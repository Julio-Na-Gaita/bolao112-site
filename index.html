<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bol√£o 112">
    <meta name="theme-color" content="#006400">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <title>Bol√£o 112 F.C 2026</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root { --primary: #006400; --bg: #f0f2f5; --card: #ffffff; --text: #1c1e21; --gray: #65676b; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); -webkit-tap-highlight-color: transparent; padding-bottom: 20px; background-position: center; background-repeat: no-repeat; background-attachment: fixed; background-size: cover; transition: background-image 0.3s ease-in-out; }
        header { background-color: var(--primary); color: white; padding: 15px; padding-top: max(15px, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 0.5px; flex-grow: 1; text-align: left; padding-left: 10px;}
        .header-icon { font-size: 28px; cursor: pointer; padding: 5px; color: #FFD700; text-shadow: 0 0 8px rgba(255, 215, 0, 0.6); }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 90px; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: white; padding: 20px; box-sizing: border-box; position: relative; z-index: 5000; }
        input, select { padding: 14px; margin: 8px 0; width: 100%; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; box-sizing: border-box; background: #f9f9f9; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: #fff; }
        button { padding: 16px; background-color: var(--primary); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; width: 100%; font-weight: 700; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,100,0,0.2); transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #ccc; box-shadow: none; }
        .secondary-btn { background-color: transparent; color: var(--gray); border: 1px solid #ddd; margin-top: 10px; box-shadow: none; }
        .toggle-link { color: var(--primary); font-weight: bold; cursor: pointer; margin-top: 25px; font-size: 14px; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); border-top: 1px solid #eee; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { cursor: pointer; font-size: 10px; text-align: center; color: #aaa; flex: 1; display: flex; flex-direction: column; align-items: center; transition: color 0.2s; }
        .nav-item .material-icons-round { font-size: 26px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .section-header { text-align: center; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; margin: 25px 0 10px 0; font-size: 14px; background: rgba(255,255,255,0.8); padding: 8px; border-radius: 20px; width: fit-content; margin-left: auto; margin-right: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.03); position: relative; overflow: hidden; }
        .comp-watermark { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; z-index: 0; pointer-events: none; object-fit: cover; }
        .match-comp { font-size: 11px; color: var(--primary); font-weight: 800; text-align: center; text-transform: uppercase; letter-spacing: 0.8px; position: relative; z-index: 2; display: flex; justify-content: center; align-items: center; }
        .match-header { font-size: 12px; color: #888; text-align: center; margin-bottom: 15px; margin-top: 4px; line-height: 1.4; position: relative; z-index: 2; }
        .teams { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 10; }
        .team-btn { display: flex; flex-direction: column; align-items: center; width: 40%; padding: 12px 5px; border: 2px solid transparent; border-radius: 12px; background: rgba(249,249,249,0.8); cursor: pointer; transition: all 0.2s; position: relative; backdrop-filter: blur(2px); z-index: 11; }
        .team-btn:active { transform: scale(0.95); }
        .team-btn.selected { background-color: rgba(232,245,233,0.9); border-color: #4CAF50; color: var(--primary); }
        .team-img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .team-name { font-size: 11px; font-weight: 700; text-align: center; line-height: 1.2; white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 28px; display: flex; align-items: center; justify-content: center; }
        .vs { font-weight: 900; color: #d32f2f; font-size: 16px; position: relative; z-index: 2; }
        .status-msg { text-align:center; margin-top:10px; position:relative; z-index:10; font-size:12px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        th { text-align: center; color: #888; font-size: 11px; background: #fafafa; padding: 12px 5px; border-bottom: 1px solid #eee; text-transform: uppercase; font-weight: 700; }
        td { padding: 14px 5px; vertical-align: middle; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        .td-nome { text-align: left; display: flex; align-items: center; font-weight: 600; cursor: pointer; padding-left: 10px; }
        .rank-avatar { width: 36px; height: 36px; border-radius: 50%; background: #eee; margin-right: 12px; object-fit: cover; border: 1px solid #999; }
        .debit { color: #d32f2f; font-weight: bold; }
        .points { font-weight: 900; font-size: 16px; color: #000; }
        .clickable-stats { cursor: pointer; }
        .rank-row-1 { background-color: #fff9c4 !important; } .rank-row-2 { background-color: #e0e0e0 !important; } .rank-row-3 { background-color: #ffccbc !important; } 
        .profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; margin-top: 20px; position: relative; z-index: 5; }
        .glass-box { background: rgba(255,255,255,0.9); padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); backdrop-filter: blur(5px); width: 100%; box-sizing: border-box; }
        .big-avatar { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .profile-name { font-size: 22px; font-weight: 800; }
        .profile-user { color: #888; font-size: 15px; margin-bottom: 25px; }
        .rules-box { background: rgba(255,255,255,0.95); padding: 25px; border-radius: 16px; font-size: 15px; line-height: 1.7; white-space: pre-wrap; box-shadow: 0 2px 6px rgba(0,0,0,0.05); color: #444; }
        .admin-btn { background-color: #333; color: #ffd700; margin-top: 20px; border: 1px solid #ffd700; font-weight: bold; padding: 12px; border-radius: 8px; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .payment-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 10px; }
        .month-box { font-size: 10px; text-align: center; padding: 5px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; background: white; }
        .month-box.paid { background-color: #2e7d32; color: white; border-color: #2e7d32; }
        .admin-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .btn-small { padding: 8px 12px; font-size: 12px; margin: 0; width: auto; }
        .btn-danger { background-color: #d32f2f; }
        .btn-edit { background-color: #1976d2; }
        .modal { display: none; position: fixed; z-index: 6000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        #modal-manage-games { z-index: 7000; }
        #modal-game-editor { z-index: 8000; }
        #modal-winner { z-index: 8000; }
        .modal-box { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 20px; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .modal-header { font-weight: 800; font-size: 18px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; text-align: center; }
        .log-item { padding: 10px 0; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .guide-title { color: var(--primary); font-weight: 800; margin-top: 20px; margin-bottom: 8px; font-size: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .hidden { display: none !important; }
        .error { color: #d32f2f; margin-top: 10px; font-size: 13px; text-align: center; }
        .alert-box { background: #333; color: white; padding: 12px; border-radius: 10px; margin-bottom: 20px; font-size: 12px; text-align: center; display: none; }
        .legenda { color: #ffd700; font-weight: 800; margin-bottom: 5px; font-size: 11px; text-transform: uppercase; }
        .icon-text { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .pot-value { font-size: 32px; font-weight: 900; color: var(--primary); text-align: center; margin: 10px 0; }
        .comp-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .search-icon-btn { cursor: pointer; color: #555; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-left: 5px; background: #eee; }
    </style>
</head>
<body>
    <div id="login-screen">
        <img src="background_login.png" onerror="this.src='favicon.png'" style="margin-bottom: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 120px; height: 120px; object-fit: cover;"> 
        <h2 style="color: #333; margin-bottom: 30px; font-weight: 800;">Bol√£o 112 F.C 2026</h2>
        <input type="text" id="fullname" placeholder="Nome de Exibi√ß√£o" class="hidden">
        <input type="text" id="email" placeholder="Usu√°rio" autocapitalize="none">
        <input type="password" id="password" placeholder="Senha">
        <button onclick="window.processarAuth()" id="btn-login">ENTRAR</button>
        <p id="login-msg" class="error"></p>
        <div class="toggle-link" onclick="window.alternarModo()" id="toggle-btn">N√£o tem conta? Criar agora</div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <h1 id="header-title">Bol√£o 112 F.C</h1>
            <span class="material-icons-round header-icon" onclick="window.verPote()">savings</span>
        </header>

        <div id="container-admin" class="container hidden">
            <div class="section-header" style="color: #333;">PAINEL ADMINISTRATIVO</div>
            <button onclick="document.getElementById('container-admin').classList.add('hidden'); document.getElementById('container-perfil').classList.remove('hidden');" class="secondary-btn" style="margin-bottom: 20px;">Voltar</button>
            <button onclick="window.abrirGestaoJogos()" class="admin-btn icon-text"><span class="material-icons-round">sports_soccer</span> GERENCIAR JOGOS</button>
            <button onclick="window.abrirGestaoUsuarios()" class="admin-btn icon-text"><span class="material-icons-round">attach_money</span> FINANCEIRO & USU√ÅRIOS</button>
            <button onclick="window.abrirGestaoCompeticoes()" class="admin-btn icon-text" style="background-color: #1976D2; border-color: #1976D2;"><span class="material-icons-round">list</span> GERENCIAR COMPETI√á√ïES</button>
        </div>

        <div id="container-jogos" class="container">
            <div id="loading-jogos" style="text-align: center; padding: 40px; color: #999;">Carregando jogos...</div>
            <div id="lista-jogos"></div>
        </div>

        <div id="container-ranking" class="container hidden">
            <div id="ranking-footer" class="alert-box" style="display:block;">
                <div class="legenda">Legenda: D=D√©bitos(-1) | V=Vit√≥rias | F=Finais | PTS=Pontos</div>
                <div id="last-update">...</div>
            </div>
            <table id="tabela-ranking">
                <thead><tr><th>Pos</th><th>Nome</th><th>D</th><th>V</th><th>F</th><th>PTS</th></tr></thead>
                <tbody id="lista-ranking"></tbody>
            </table>
        </div>

        <div id="container-regras" class="container hidden"><div id="regras-texto" class="rules-box">...</div></div>

        <div id="container-perfil" class="container hidden">
            <div class="profile-header">
                <div class="glass-box">
                    <img id="img-perfil" src="" class="big-avatar">
                    <div class="profile-name" id="nome-perfil">...</div>
                    <div class="profile-user" id="user-perfil">@...</div>
                    <input type="file" id="file-input" accept="image/*" style="display:none;" onchange="window.processarFoto()">
                    <button onclick="document.getElementById('file-input').click()" class="secondary-btn icon-text" style="width:auto; padding:10px 25px;"><span class="material-icons-round" style="font-size:18px;">photo_camera</span> Alterar Foto</button>
                    <button id="btn-admin-painel" onclick="window.abrirAdmin()" class="admin-btn icon-text" style="margin-top: 20px; display: none;">
                        <span class="material-icons-round">admin_panel_settings</span> PAINEL ADMIN
                    </button>
                </div>
            </div>
            <div class="glass-box" style="margin-top: 20px;">
                <input type="password" id="new-password" placeholder="Nova Senha">
                <button onclick="window.alterarSenha()" style="margin-top: 10px;">Salvar Nova Senha</button>
                <button onclick="window.verNovidades()" class="secondary-btn icon-text" style="margin-top:15px; color:#006400; border-color: #006400; background: #f0fff4; width: 100%;"><span class="material-icons-round">auto_awesome</span> Novidades v1.3.12 & Guia</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="window.mudarAba('jogos')" id="btn-jogos"><span class="material-icons-round">sports_soccer</span>Jogos</div>
            <div class="nav-item" onclick="window.mudarAba('ranking')" id="btn-ranking"><span class="material-icons-round">emoji_events</span>Ranking</div>
            <div class="nav-item" onclick="window.mudarAba('regras')" id="btn-regras"><span class="material-icons-round">gavel</span>Regras</div>
            <div class="nav-item" onclick="window.mudarAba('perfil')" id="btn-perfil"><span class="material-icons-round">person</span>Perfil</div>
            <div class="nav-item" onclick="window.sair()"><span class="material-icons-round">logout</span>Sair</div>
        </div>
    </div>

    <div id="modal-foto" class="modal" onclick="this.style.display='none'"><img id="modal-img" class="modal-content"></div>
    <div id="modal-history" class="modal"><div class="modal-box"><div class="modal-header" id="history-title">...</div><div id="history-list"></div><button onclick="this.parentElement.parentElement.style.display='none'" style="margin-top:20px; background:#eee; color:#333;">Fechar</button></div></div>
    <div id="modal-pote" class="modal"><div class="modal-box" style="text-align: center;"><div class="modal-header" style="color: #006400;">üí∞ POTE DE OURO üí∞</div><div style="font-size: 16px; color: #555;">Valor total arrecadado:</div><div id="pote-valor" class="pot-value">R$ 0,00</div><div style="font-size: 12px; color: #999; margin-top: 15px;">Quanto mais gente pagar em dia, maior o pr√™mio! üöÄ</div><button onclick="this.parentElement.parentElement.style.display='none'" style="margin-top:20px;">Sensacional!</button></div></div>

    <div id="modal-game-editor" class="modal">
        <div class="modal-box">
            <div class="modal-header" id="modal-game-title">Novo Jogo</div>
            <input type="hidden" id="edit-match-id">
            <select id="adm-comp"></select>
            <select id="adm-round"><option>Oitavas de final</option><option>Quartas de final</option><option>Semi final</option><option>Final</option></select>
            <div style="display:flex; align-items:center;"><input id="adm-tA" placeholder="Time A" style="flex:1;"><span onclick="window.buscarLogo('adm-tA')" class="material-icons-round search-icon-btn">search</span></div>
            <input id="adm-urlA" placeholder="URL Imagem A">
            <div style="display:flex; align-items:center; margin-top:10px;"><input id="adm-tB" placeholder="Time B" style="flex:1;"><span onclick="window.buscarLogo('adm-tB')" class="material-icons-round search-icon-btn">search</span></div>
            <input id="adm-urlB" placeholder="URL Imagem B">
            <label style="font-size:12px; color:#666; display:block; margin-top:15px; margin-bottom:2px;">Data e Hora:</label><input type="datetime-local" id="adm-date" style="margin-top:0;">
            <button onclick="window.salvarJogo()" style="margin-top:15px;">Salvar Jogo</button>
            <button onclick="document.getElementById('modal-game-editor').style.display='none'" class="secondary-btn">Cancelar</button>
        </div>
    </div>

    <div id="modal-manage-comps" class="modal"><div class="modal-box"><div class="modal-header">Competi√ß√µes</div><div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px;"><input type="hidden" id="edit-comp-original-name"><input id="new-comp-name" placeholder="Nome (ex: Brasileir√£o)"><div style="display:flex; align-items:center; margin-top:5px;"><input id="new-comp-logo" placeholder="URL do Logo" style="flex:1;"><span onclick="window.buscarLogo('new-comp-name')" class="material-icons-round search-icon-btn">search</span></div><div style="display:flex; justify-content:flex-end; margin-top:10px; gap:5px;"><button onclick="window.limparFormComp()" class="btn-small btn-danger" style="background:#ccc; color:#333; border:none;">Limpar</button><button onclick="window.salvarCompeticao()" class="btn-small" style="width:auto;">Salvar</button></div></div><div id="comp-list"></div><button onclick="document.getElementById('modal-manage-comps').style.display='none'" class="secondary-btn">Fechar</button></div></div>
    <div id="modal-finance" class="modal"><div class="modal-box" style="width: 95%; max-width: 600px;"><div class="modal-header">Gest√£o Financeira</div><div id="finance-list"></div><button onclick="document.getElementById('modal-finance').style.display='none'" style="margin-top:10px;">Fechar</button></div></div>
    <div id="modal-manage-games" class="modal"><div class="modal-box"><div class="modal-header">Gerenciar Jogos</div><button onclick="window.abrirNovoJogo()" class="admin-btn" style="margin-bottom:15px; margin-top:0;">+ NOVO JOGO</button><div id="admin-games-list"></div><button onclick="document.getElementById('modal-manage-games').style.display='none'" class="secondary-btn">Fechar</button></div></div>
    <div id="modal-winner" class="modal"><div class="modal-box"><div class="modal-header" id="history-title">Quem venceu?</div><input type="hidden" id="winner-match-id"><button id="btn-win-A" onclick="window.setWinner(this.innerText)">Time A</button><button id="btn-win-B" onclick="window.setWinner(this.innerText)">Time B</button><button onclick="window.setWinner(null)" class="btn-danger" style="margin-top:10px;">Remover Vencedor</button><button onclick="document.getElementById('modal-winner').style.display='none'" class="secondary-btn">Cancelar</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEkEE2X5hWIqopoJ0D9jFzCjJHKR8b82k",
            authDomain: "bolao112fc.firebaseapp.com",
            projectId: "bolao112fc",
            storageBucket: "bolao112fc.firebasestorage.app",
            messagingSenderId: "131329454158",
            appId: "1:131329454158:web:983e4544dd651ec942131f",
            measurementId: "G-5SGWJE6EKK"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let isRegisterMode = false;
        let currentCompetitions = []; 

        console.log("Iniciando carregamento do script...");

        // =========================================================
        //  FUN√á√ïES GLOBAIS (DEFINI√á√ÉO PRIORIT√ÅRIA PARA BOT√ïES)
        // =========================================================

        window.processarAuth = async () => { 
            const btn = document.getElementById('btn-login'); 
            const msg = document.getElementById('login-msg'); 
            const user = document.getElementById('email').value.trim().toLowerCase(); 
            const pass = document.getElementById('password').value; 
            const fullName = document.getElementById('fullname').value.trim(); 
            const email = user + "@bolao112.com";
            
            btn.disabled = true; 
            msg.innerText = "Conectando...";
            
            try {
                if (isRegisterMode) {
                    if(!fullName || pass.length < 6) throw new Error("Preencha campos (Senha min 6).");
                    const w = await getDoc(doc(db,"whitelist",user)); 
                    if(!w.exists()) throw new Error("N√£o convidado.");
                    const c = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db,"users",c.user.uid),{name:fullName,username:user,photoBase64:"",isAdmin:false,debts:0,appVersion:"Web v1.3.12"});
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) { 
                msg.innerText = e.message; 
                btn.disabled = false; 
            }
        };

        window.alternarModo = () => { 
            isRegisterMode=!isRegisterMode; 
            document.getElementById('btn-login').innerText=isRegisterMode?"CADASTRAR":"ENTRAR"; 
            document.getElementById('fullname').classList.toggle('hidden'); 
        };

        window.votar = async (matchId, time, teamA, teamB) => {
            if(!currentUser) { alert("Fa√ßa login"); return; }
            console.log("Votando:", time);
            document.getElementById(`btn-${matchId}-${teamA}`).classList.remove('selected');
            document.getElementById(`btn-${matchId}-${teamB}`).classList.remove('selected');
            document.getElementById(`btn-${matchId}-${time}`).classList.add('selected');
            await setDoc(doc(db, "guesses", `${matchId}_${currentUser.uid}`), { matchId, userId: currentUser.uid, teamSelected: time, timestamp: new Date() });
        };

        window.verPalpites = async (matchId, tA, tB, isExpired, urlA, urlB) => {
            console.log("Vendo palpites:", matchId);
            const list = document.getElementById('history-list');
            document.getElementById('history-title').innerText = isExpired ? "Palpites (Encerrado)" : "Quem Votou";
            list.innerHTML = "Carregando...";
            document.getElementById('modal-history').style.display = 'flex';
            
            try {
                const [gSnap, uSnap] = await Promise.all([getDocs(query(collection(db, "guesses"))), getDocs(collection(db, "users"))]);
                let html = "";
                const usersMap = {};
                uSnap.forEach(u => usersMap[u.id] = u.data());
                
                gSnap.forEach(g => {
                    const data = g.data();
                    if(data.matchId === matchId) {
                        const u = usersMap[data.userId] || {name: "Desconhecido", photoBase64: ""};
                        const name = u.name || u.username;
                        const photo = u.photoBase64 ? `data:image/jpeg;base64,${u.photoBase64}` : 'https://via.placeholder.com/30';
                        let teamIcon = "";
                        if(isExpired) {
                            const voted = data.teamSelected.trim().toLowerCase();
                            if(voted === tA.trim().toLowerCase()) teamIcon = `<img src="${urlA}" style="width:20px; height:20px; object-fit:contain; margin-left:auto;">`;
                            else if(voted === tB.trim().toLowerCase()) teamIcon = `<img src="${urlB}" style="width:20px; height:20px; object-fit:contain; margin-left:auto;">`;
                        }
                        html += `<div class="log-item" style="display:flex; align-items:center;"><img src="${photo}" class="rank-avatar" style="width:30px; height:30px; margin-right:10px;"><span style="font-weight:600; font-size:14px;">${name}</span>${teamIcon}</div>`;
                    }
                });
                list.innerHTML = html || "<div style='text-align:center; padding:20px;'>Nenhum voto ainda.</div>";
            } catch(e) {
                list.innerHTML = "Erro ao carregar.";
                console.error(e);
            }
        };

        window.processarFoto = () => { 
            const file = document.getElementById('file-input').files[0]; 
            if(!file) return; 
            const r = new FileReader(); 
            r.onload = (e) => { 
                const i = new Image(); 
                i.src = e.target.result; 
                i.onload = () => { 
                    const c = document.createElement('canvas'); 
                    const ctx = c.getContext('2d'); 
                    const scale = 300/i.width; c.width=300; c.height=i.height*scale; 
                    ctx.drawImage(i,0,0,c.width,c.height); 
                    const b64 = c.toDataURL('image/jpeg',0.7).split(',')[1]; 
                    updateDoc(doc(db,"users",currentUser.uid), {photoBase64: b64, appVersion: "Web v1.3.12"}).then(() => { 
                        document.getElementById('img-perfil').src = "data:image/jpeg;base64,"+b64; 
                        alert("Foto salva!"); 
                    }); 
                }; 
            }; 
            r.readAsDataURL(file); 
        };

        // --- SISTEMA DE ADMIN E JOGOS ---

        window.abrirAdmin = () => {
             ['jogos', 'ranking', 'regras', 'perfil'].forEach(a => document.getElementById(`container-${a}`).classList.add('hidden'));
             document.getElementById('container-admin').classList.remove('hidden');
             document.getElementById('header-title').innerText = "Painel Admin";
             window.loadCompetitions(); 
        };

        window.abrirGestaoJogos = async () => {
             document.getElementById('modal-manage-games').style.display = 'flex';
             const snap = await getDocs(query(collection(db, "matches"), orderBy("deadline", "desc")));
             const div = document.getElementById('admin-games-list');
             div.innerHTML = "";
             snap.forEach(d => {
                 const m = {id:d.id, ...d.data()};
                 const winnerText = m.winner ? `<span style="color:green">V: ${m.winner}</span>` : `<span style="color:orange">Aberto</span>`;
                 div.innerHTML += `
                     <div style="border:1px solid #eee; padding:10px; margin-bottom:5px; border-radius:8px;">
                         <div style="font-weight:bold">${m.teamA} x ${m.teamB}</div>
                         <div style="font-size:12px; color:#666;">${m.competition} | ${winnerText}</div>
                         <div class="admin-actions">
                              <button class="btn-small btn-edit" onclick="window.abrirEditarJogo('${m.id}', '${m.teamA}', '${m.teamB}', '${m.teamAUrl}', '${m.teamBUrl}', '${m.competition}', '${m.round}', '${m.deadline ? m.deadline.toDate().toISOString() : ''}')">Editar</button>
                             <button class="btn-small btn-edit" onclick="window.abrirDefinirVencedor('${m.id}','${m.teamA}','${m.teamB}')">Vencedor</button>
                             <button class="btn-small btn-danger" onclick="window.excluirJogo('${m.id}')">Excluir</button>
                         </div>
                     </div>`;
             });
        };

        window.abrirNovoJogo = () => {
            document.getElementById('modal-game-title').innerText = "Novo Jogo";
            document.getElementById('edit-match-id').value = ""; 
            document.getElementById('adm-tA').value = ""; document.getElementById('adm-tB').value = "";
            document.getElementById('adm-urlA').value = ""; document.getElementById('adm-urlB').value = "";
            document.getElementById('adm-date').value = "";
            document.getElementById('modal-game-editor').style.display = 'flex';
        }

        window.abrirEditarJogo = (id, tA, tB, urlA, urlB, comp, round, dateIso) => {
            document.getElementById('modal-game-title').innerText = "Editar Jogo";
            document.getElementById('edit-match-id').value = id;
            document.getElementById('adm-tA').value = tA; document.getElementById('adm-tB').value = tB;
            document.getElementById('adm-urlA').value = urlA; document.getElementById('adm-urlB').value = urlB;
            document.getElementById('adm-comp').value = comp; document.getElementById('adm-round').value = round;
            if(dateIso) {
                const d = new Date(dateIso);
                const tzOffset = d.getTimezoneOffset() * 60000;
                const localISOTime = (new Date(d - tzOffset)).toISOString().slice(0, 16);
                document.getElementById('adm-date').value = localISOTime;
            }
            document.getElementById('modal-game-editor').style.display = 'flex';
        };

        window.salvarJogo = async () => {
             const id = document.getElementById('edit-match-id').value;
             const tA = document.getElementById('adm-tA').value; const tB = document.getElementById('adm-tB').value;
             const comp = document.getElementById('adm-comp').value; const dateVal = document.getElementById('adm-date').value;
             
             if(!tA || !tB || !dateVal) return alert("Preencha tudo!");
             
             const dateObj = new Date(dateVal);
             const data = {
                 teamA: tA, teamB: tB, teamAUrl: document.getElementById('adm-urlA').value, teamBUrl: document.getElementById('adm-urlB').value,
                 competition: comp, round: document.getElementById('adm-round').value, deadline: dateObj
             };
 
             if(id) {
                 await updateDoc(doc(db, "matches", id), data);
                 if(confirm("Jogo Atualizado! Deseja avisar no WhatsApp?")) {
                     const formattedDate = dateObj.toLocaleDateString('pt-BR') + " " + dateObj.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                     const msg = `üì¢ *ATEN√á√ÉO: JOGO ATUALIZADO NO BOL√ÉO 112!*\n\n‚öΩ *${tA} x ${tB}*\nüèÜ ${comp}\n‚è∞ Novo Prazo: ${formattedDate}\n\nüì≤ *Deixe seu palpite:* https://bolao112-site.vercel.app`;
                     window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`);
                 } else { alert("Jogo Atualizado!"); }
             } else {
                 data.winner = null;
                 await addDoc(collection(db, "matches"), data);
                 const formattedDate = dateObj.toLocaleDateString('pt-BR') + " " + dateObj.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                 const msg = `üì¢ *NOVO JOGO DISPON√çVEL NO BOL√ÉO 112!*\n\n‚öΩ *${tA} x ${tB}*\nüèÜ ${comp}\n‚è∞ Prazo: ${formattedDate}\n\nüì≤ *N√£o fica moscando, entre agora e deixe seu palpite!* https://bolao112-site.vercel.app`;
                 if(confirm("Jogo Criado! Deseja enviar no WhatsApp?")) window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`);
             }
             document.getElementById('modal-game-editor').style.display='none';
             window.abrirGestaoJogos();
        };

        window.abrirDefinirVencedor = (id, tA, tB) => { document.getElementById('winner-match-id').value = id; document.getElementById('btn-win-A').innerText = tA; document.getElementById('btn-win-B').innerText = tB; document.getElementById('modal-winner').style.display = 'flex'; };
        window.setWinner = async (winner) => { const id = document.getElementById('winner-match-id').value; if(winner) await updateDoc(doc(db, "matches", id), {winner: winner}); else await updateDoc(doc(db, "matches", id), {winner: null}); alert("Salvo!"); document.getElementById('modal-winner').style.display = 'none'; window.abrirGestaoJogos(); };
        window.excluirJogo = async (id) => { if(confirm("Tem certeza?")) { await deleteDoc(doc(db, "matches", id)); alert("Exclu√≠do!"); window.abrirGestaoJogos(); } };
        window.buscarLogo = (inputId) => { const name = document.getElementById(inputId).value; if(name) window.open(`https://www.google.com/search?tbm=isch&q=escudo+${encodeURIComponent(name)}+png`); else alert("Digite o nome primeiro!"); };
        window.autoUrl = (idField, urlField) => { /* Placeholder */ };

        // --- SISTEMAS DE NAVEGA√á√ÉO ---

        window.mudarAba = (aba) => {
             let bgImage = ""; 
             if (aba === 'jogos') bgImage = "url('bg_jogos.png')";
             else if (aba === 'ranking') bgImage = "url('bg_ranking.png')";
             else if (aba === 'regras') bgImage = "url('bg_regras.png')";
             else if (aba === 'perfil') bgImage = "url('bg_perfil.png')";
             document.body.style.backgroundImage = bgImage;
 
             ['jogos', 'ranking', 'regras', 'perfil', 'admin'].forEach(a => { 
                 document.getElementById(`container-${a}`).classList.add('hidden');
                 document.getElementById(`btn-${a}`).classList.remove('active');
             });
             document.getElementById(`container-${aba}`).classList.remove('hidden');
             document.getElementById(`btn-${aba}`).classList.add('active');
             
             if(aba==='jogos') window.carregarJogos();
             if(aba==='ranking') window.carregarRanking();
             if(aba==='regras') window.carregarRegras();
             if(aba==='perfil') window.carregarPerfil();
        };

        window.carregarJogos = async () => {
             document.getElementById('loading-jogos').classList.remove('hidden');
             document.getElementById('lista-jogos').innerHTML = "";
             const [mSnap, gSnap] = await Promise.all([getDocs(query(collection(db, "matches"))), getDocs(collection(db, "guesses"))]);
             
             const settingsSnap = await getDoc(doc(db, "settings", "competitions"));
             let compLogos = {}; if(settingsSnap.exists()) { const items = settingsSnap.data().items || []; items.forEach(i => compLogos[i.name] = i.logo); }
             
             const myGuesses = {}; gSnap.forEach(d => { if(d.data().userId === currentUser.uid) myGuesses[d.data().matchId] = d.data().teamSelected; });
             let allMatches = []; mSnap.forEach(d => allMatches.push({id: d.id, ...d.data()}));
             
             const now = new Date(); const openMatches = [], waitingMatches = [], finishedMatches = [];
             allMatches.forEach(m => { m.dateObj = m.deadline ? m.deadline.toDate() : new Date(0); if (m.dateObj > now) openMatches.push(m); else if (!m.winner) waitingMatches.push(m); else finishedMatches.push(m); });
             openMatches.sort((a,b) => a.dateObj - b.dateObj); waitingMatches.sort((a,b) => b.dateObj - a.dateObj); finishedMatches.sort((a,b) => b.dateObj - a.dateObj);
             
             const renderSection = (title, matches, color) => {
                 if(matches.length === 0) return;
                 const header = document.createElement('div'); header.className = 'section-header'; header.innerText = title; header.style.color = color;
                 document.getElementById('lista-jogos').appendChild(header);
                 matches.forEach(m => {
                     const isExpired = m.dateObj < now;
                     const dateStr = m.dateObj.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}) + " " + m.dateObj.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                     const userVote = myGuesses[m.id];
                     const logoUrl = compLogos[m.competition] || "";
                     const watermarkHtml = logoUrl ? `<img src="${logoUrl}" class="comp-watermark">` : "";
                     const headerLogo = logoUrl ? `<img src="${logoUrl}" style="width:24px;height:24px;object-fit:contain;margin-right:5px;">` : "";
                     
                     const div = document.createElement('div'); div.className = "card"; if(isExpired) div.style.background = "#f7f7f7";
                     
                     let statusHtml = `<div class="match-comp">${headerLogo}${m.competition || ''}</div><div class="match-header">${m.round || ''}<br>Vota√ß√£o encerra em: ${dateStr}</div>`;
                     if(isExpired) statusHtml = `<div class="match-comp">${headerLogo}${m.competition || ''}</div><div class="match-header" style="color:#d32f2f; font-weight:bold;">üîí ENCERRADO<br>${m.winner ? 'Vencedor: <b style="color:green">'+m.winner+'</b>' : 'Aguardando resultado...'}</div>`;
 
                     const isTeamASelected = userVote && userVote.trim().toLowerCase() === m.teamA.trim().toLowerCase();
                     const isTeamBSelected = userVote && userVote.trim().toLowerCase() === m.teamB.trim().toLowerCase();
                     const clickA = isExpired ? "" : `onclick="window.votar('${m.id}', '${m.teamA}', '${m.teamA}', '${m.teamB}')"`;
                     const clickB = isExpired ? "" : `onclick="window.votar('${m.id}', '${m.teamB}', '${m.teamA}', '${m.teamB}')"`;
 
                     div.innerHTML = `${watermarkHtml} ${statusHtml} 
                         <div class="teams">
                             <div class="team-btn ${isTeamASelected?'selected':''}" id="btn-${m.id}-${m.teamA}" ${clickA}><img src="${m.teamAUrl}" class="team-img" onerror="this.src='https://placehold.co/50?text=A'"><div class="team-name">${m.teamA}</div></div>
                             <span class="vs">X</span>
                             <div class="team-btn ${isTeamBSelected?'selected':''}" id="btn-${m.id}-${m.teamB}" ${clickB}><img src="${m.teamBUrl}" class="team-img" onerror="this.src='https://placehold.co/50?text=B'"><div class="team-name">${m.teamB}</div></div>
                         </div>
                         ${userVote && !isExpired ? `<div class="status-msg" style="color:#2e7d32; font-weight:bold;">‚úÖ Voto confirmado: ${userVote}</div>` : ''}
                         <div class="status-msg"><span onclick="window.verPalpites('${m.id}', '${m.teamA}', '${m.teamB}', ${isExpired}, '${m.teamAUrl}', '${m.teamBUrl}')" style="color:#666; text-decoration:underline; cursor:pointer;">${isExpired ? 'Ver Palpites da Galera' : 'Quem j√° votou?'}</span></div>`;
                     document.getElementById('lista-jogos').appendChild(div);
                 });
             };
             renderSection("‚úÖ JOGOS DISPON√çVEIS ‚úÖ", openMatches, "#006400"); renderSection("‚è≥ AGUARDANDO RESULTADO FINAL ‚è≥", waitingMatches, "#F9A825"); renderSection("üö´ JOGOS FINALIZADOS üö´", finishedMatches, "#D32F2F");
             if(allMatches.length === 0) document.getElementById('lista-jogos').innerHTML = "<div style='text-align:center; color:#999; padding:40px;'>Nenhum jogo cadastrado.</div>";
             document.getElementById('loading-jogos').classList.add('hidden');
        };

        window.carregarRanking = async () => { /* Mesma l√≥gica, mantida simplificada aqui para caber */ const [uSnap, mSnap, gSnap] = await Promise.all([getDocs(collection(db,"users")), getDocs(collection(db,"matches")), getDocs(collection(db,"guesses"))]); let matches = []; mSnap.forEach(d => {const m={id:d.id,...d.data()}; if(m.winner) matches.push(m);}); const rank = []; uSnap.forEach(u => { const user = u.data(); let pts=0, v=0, f=0, d=user.debts||0; const userGuesses = []; gSnap.forEach(g=>{if(g.data().userId===u.id) userGuesses.push(g.data())}); userGuesses.forEach(g=>{const m=matches.find(x=>x.id===g.matchId); if(m && m.winner===g.teamSelected){ pts+= (m.round==="Final"?6:3); v++; if(m.round==="Final") f++; }}); pts-=d; rank.push({name:user.name, photo:user.photoBase64, pts, v, f, d, history:[]}); }); rank.sort((a,b)=>b.pts-a.pts); const tbody = document.getElementById('lista-ranking'); tbody.innerHTML=""; rank.forEach((r,i)=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}¬∫</td><td class="td-nome">${r.name}</td><td>${r.d}</td><td>${r.v}</td><td>${r.f}</td><td class="points">${r.pts}</td>`; tbody.appendChild(tr);}); };
        
        window.carregarRegras = async () => { const d = await getDoc(doc(db, "settings", "general")); document.getElementById('regras-texto').innerText = d.exists() ? d.data().rulesText : "Sem regras."; }
        
        window.carregarPerfil = async () => {
             const d = await getDoc(doc(db, "users", currentUser.uid));
             if(d.exists()) {
                 const u = d.data();
                 document.getElementById('nome-perfil').innerText = u.name;
                 document.getElementById('user-perfil').innerText = "@"+u.username;
                 if(u.photoBase64) document.getElementById('img-perfil').src = "data:image/jpeg;base64,"+u.photoBase64;
                 if(u.isAdmin) { document.getElementById('btn-admin-painel').style.display = 'flex'; window.loadCompetitions(); }
             }
        };

        window.verPote = async () => { document.getElementById('modal-pote').style.display = 'flex'; const usersSnap = await getDocs(collection(db, "users")); let totalPayments = 0; usersSnap.forEach(doc => { const payments = doc.data().payments || {}; for(let month in payments) { if(payments[month]) totalPayments++; } }); const totalValue = totalPayments * 10; document.getElementById('pote-valor').innerText = totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); };
        window.verNovidades = () => { document.getElementById('history-list').innerHTML = "Vers√£o 1.3.12: Corre√ß√£o de bot√µes e layout."; document.getElementById('modal-history').style.display='flex'; };
        window.alterarSenha = () => { const p = document.getElementById('new-password').value; if(p.length<6) return alert("Min 6 d√≠gitos"); updatePassword(currentUser, p).then(()=>alert("Senha alterada!")); };
        window.sair = () => signOut(auth);

        // AUTH LISTENER
        onAuthStateChanged(auth, (u) => {
            if(u) {
                currentUser = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                window.mudarAba('jogos');
            } else {
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
