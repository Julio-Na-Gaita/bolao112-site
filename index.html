<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bol√£o 112">
    <meta name="theme-color" content="#006400">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <title>Bol√£o 112 F.C 2026</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root { 
            --primary: #006400; 
            --gold: #FFD700;
            --bg: #f8f9fa; 
            --text: #1c1e21;
            /* Fonte Serifada - Classic Badge */
            --font-stack: "Times New Roman", Times, serif;
        }

        body { 
            font-family: var(--font-stack);
            background-color: var(--bg); margin: 0; padding: 0; color: var(--text); 
            -webkit-tap-highlight-color: transparent; padding-bottom: 20px;
            background-image: url('bg_jogos.png'); /* Padr√£o inicial */
            background-position: center; background-repeat: no-repeat; background-attachment: fixed; background-size: cover; 
            transition: background-image 0.3s ease-in-out;
        }

        /* --- ESTILO CLASSIC BADGE (CANTOS CORTADOS) --- */
        .cut-corner {
            clip-path: polygon(
                10px 0, 100% 0, 
                100% calc(100% - 10px), calc(100% - 10px) 100%, 
                0 100%, 0 10px
            );
        }

        header { 
            background-color: var(--primary); color: white; padding: 15px; 
            padding-top: max(15px, env(safe-area-inset-top)); 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); border-bottom: 3px solid var(--gold);
        }
        h1 { margin: 0; font-size: 20px; font-weight: 800; letter-spacing: 1px; flex-grow: 1; padding-left: 10px; text-transform: uppercase; }
        .header-icon { font-size: 28px; cursor: pointer; padding: 5px; color: var(--gold); text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        
        .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 90px; }
        
        /* Inputs Cl√°ssicos */
        input:not([type="checkbox"]), select, textarea { 
            padding: 12px; margin: 8px 0; width: 100%; 
            border: 2px solid #ccc; border-radius: 4px; 
            font-size: 16px; box-sizing: border-box; background: #fff; color: #333; 
            font-family: var(--font-stack);
        }
        input:focus { border-color: var(--primary); outline: none; }

        /* Bot√µes com Cut Corner */
        button { 
            padding: 14px; background-color: var(--primary); color: white; border: none; 
            cursor: pointer; font-size: 15px; width: 100%; font-weight: 800; margin-top: 10px; 
            font-family: var(--font-stack); text-transform: uppercase; letter-spacing: 1px;
            clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .secondary-btn { background-color: #eee; color: #333; border: 1px solid #999; }
        
        /* Login */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #fff; position: fixed; top: 0; left: 0; width: 100%; z-index: 5000; }
        .login-box { background: rgba(255,255,255,0.95); padding: 30px; border: 4px solid var(--primary); width: 85%; max-width: 350px; text-align: center; clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .toggle-link { color: var(--primary); font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 13px; text-decoration: underline; text-transform: uppercase; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 3px solid #ddd; z-index: 100; }
        .nav-item { cursor: pointer; font-size: 10px; text-align: center; color: #888; flex: 1; font-family: var(--font-stack); font-weight: bold; }
        .nav-item .material-icons-round { font-size: 24px; display: block; margin: 0 auto 2px auto; }
        .nav-item.active { color: var(--primary); font-weight: 900; }

        /* Admin Panel Styles */
        .admin-section { display: flex; flex-direction: column; gap: 10px; }
        .admin-btn { display: flex; align-items: center; justify-content: center; gap: 8px; text-shadow: 0 1px 1px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.1); }
        
        /* Cards */
        .card { 
            background: white; padding: 16px; margin-bottom: 12px; position: relative; overflow: hidden; 
            border: 1px solid #bbb; 
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .card-final {
            border: 4px solid var(--gold) !important;
            background: linear-gradient(145deg, #FFFDE7, #FFF9C4) !important;
        }
        .match-comp { font-size: 12px; font-weight: 900; color: var(--primary); text-transform: uppercase; text-align: center; margin-bottom: 2px; }
        .match-info { font-size: 12px; color: #666; text-align: center; font-weight: 600; margin-bottom: 12px; }
        .teams { display: flex; justify-content: space-between; align-items: center; }
        .team-box { width: 35%; display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px; background: #f0f0f0; border: 1px solid transparent; clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px); transition: 0.2s; }
        .team-box.selected { background: var(--primary); color: white; border-color: var(--gold); }
        .team-box img { width: 45px; height: 45px; object-fit: contain; margin-bottom: 5px; }
        .team-name { font-size: 11px; font-weight: 800; text-align: center; line-height: 1.1; height: 24px; display: flex; align-items: center; justify-content: center; }
        .vs { font-size: 22px; font-weight: 900; color: #ccc; font-family: sans-serif; }
        
        /* Tabelas */
        table { width: 100%; border-collapse: collapse; background: white; border: 2px solid var(--primary); font-size: 14px; }
        th { background: #eee; padding: 10px 4px; font-weight: 900; color: #444; border-bottom: 2px solid #ccc; font-size: 11px; text-transform: uppercase; }
        td { padding: 12px 4px; text-align: center; border-bottom: 1px solid #eee; font-weight: 600; }
        .rank-avatar { width: 32px; height: 32px; border-radius: 50%; vertical-align: middle; margin-right: 8px; border: 1px solid #999; }
        .row-gold { background: #FFF9C4; } .row-silver { background: #E0E0E0; } .row-bronze { background: #FFCCBC; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 450px; max-height: 85vh; padding: 20px; overflow-y: auto; border: 3px solid var(--primary); clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; }
        .modal-header { font-weight: 900; font-size: 18px; color: var(--primary); text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; }
        
        /* Grid Financeiro */
        .month-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: 5px; }
        .month-item { font-size: 10px; text-align: center; padding: 6px 0; border: 1px solid #ccc; background: #fff; cursor: pointer; font-weight: bold; }
        .month-item.paid { background: #2E7D32; color: white; border-color: #2E7D32; }

        /* Whitelist Items */
        .whitelist-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 14px; }
        .btn-delete { background: none; border: none; color: #d32f2f; cursor: pointer; padding: 5px; width: auto; margin: 0; clip-path: none; }

        /* Section Header */
        .section-tag { background: rgba(255,255,255,0.95); border: 2px solid; padding: 8px; text-align: center; font-weight: 900; text-transform: uppercase; font-size: 14px; margin: 20px auto 10px auto; width: fit-content; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .hidden { display: none !important; }
        .error { color: #d32f2f; font-size: 13px; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <img src="background_login.png" onerror="this.src='favicon.png'" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; margin-bottom: 15px;">
            <h2 style="color: var(--primary); margin-bottom: 20px; font-weight: 900; letter-spacing: 1px;">BOL√ÉO 112 F.C</h2>
            <input type="text" id="fullname" placeholder="Nome de Exibi√ß√£o" class="hidden">
            <input type="text" id="email" placeholder="Usu√°rio" autocapitalize="none">
            <input type="password" id="password" placeholder="Senha">
            <button onclick="window.processarAuth()" id="btn-login">ENTRAR</button>
            <p id="login-msg" class="error"></p>
            <div class="toggle-link" onclick="window.alternarModo()" id="toggle-btn">N√ÉO TEM CONTA? CRIAR</div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <h1>BOL√ÉO 112 F.C</h1>
            <span class="material-icons-round header-icon" onclick="window.verPote()">savings</span>
        </header>

        <div id="container-admin" class="container hidden">
            <div class="section-tag" style="border-color: #333; color: #333;">PAINEL ADMINISTRATIVO</div>
            <button onclick="window.fecharAdmin()" class="secondary-btn" style="margin-bottom: 20px;">VOLTAR</button>
            
            <div class="admin-section">
                <button onclick="window.abrirGestaoUsuarios()" class="admin-btn" style="background-color: #2E7D32;">üí∞ FINANCEIRO & USU√ÅRIOS üë•</button>
                <button onclick="window.abrirNovoJogo()" class="admin-btn" style="background-color: #1565C0;">‚öΩ NOVO CONFRONTO ‚ûï</button>
                <button onclick="window.abrirGestaoCompeticoes()" class="admin-btn" style="background-color: #EF6C00;">üèÜ COMPETI√á√ïES üéñÔ∏è</button>
                <button onclick="window.abrirGestaoConvites()" class="admin-btn" style="background-color: #4A148C;">üì© GERENCIAR CONVITES</button>
            </div>
            
            <div style="margin-top: 25px; font-weight: bold; border-bottom: 2px solid #ccc; padding-bottom: 5px;">Gerenciar Confrontos Existentes:</div>
            <div id="admin-games-list" style="margin-top: 10px;"></div>
        </div>

        <div id="container-jogos" class="container">
            <div id="loading-jogos" style="text-align: center; padding: 40px; color: #999; font-weight: bold;">Carregando...</div>
            <div id="lista-jogos"></div>
        </div>

        <div id="container-ranking" class="container hidden">
            <div style="background: #222; color: #ffd700; padding: 10px; font-size: 11px; text-align: center; font-weight: bold; margin-bottom: 15px; border: 1px solid #ffd700;">
                LEGENDA: D=D√©bitos(-1) | V=Vit√≥rias | F=Finais | PTS=Pontos
                <div id="last-update" style="color: white; font-style: italic; margin-top: 4px;">...</div>
            </div>
            <table id="tabela-ranking">
                <thead><tr><th>Pos</th><th>Participante</th><th>D</th><th>V</th><th>F</th><th>PTS</th></tr></thead>
                <tbody id="lista-ranking"></tbody>
            </table>
        </div>

        <div id="container-regras" class="container hidden">
            <div style="text-align: right; margin-bottom: 10px;">
                <button id="btn-edit-rules" class="btn-small hidden" style="width: auto; background: #333;" onclick="window.editarRegras()">‚úèÔ∏è Editar</button>
            </div>
            <div id="regras-texto" class="rules-box">...</div>
            <textarea id="regras-input" class="rules-box hidden" style="width:100%; height:400px;"></textarea>
            <div id="rules-actions" class="hidden" style="margin-top: 10px; text-align: right;">
                <button onclick="window.cancelarEdicaoRegras()" class="secondary-btn" style="width: auto;">Cancelar</button>
                <button onclick="window.salvarRegras()" style="width: auto; margin-left: 5px;">Salvar</button>
            </div>
        </div>

        <div id="container-perfil" class="container hidden">
            <div class="profile-header">
                <div class="glass-box">
                    <div style="color: var(--primary); font-weight: 900; font-size: 18px; margin-bottom: 10px;">CART√ÉO DE MEMBRO</div>
                    <img id="img-perfil" src="" class="big-avatar">
                    <button onclick="document.getElementById('file-input').click()" class="secondary-btn" style="width: auto; padding: 8px 15px; font-size: 11px; margin-bottom: 10px;">ALTERAR FOTO</button>
                    <div class="profile-name" id="nome-perfil">...</div>
                    <div class="profile-user" id="user-perfil">@...</div>
                    <input type="file" id="file-input" accept="image/*" style="display:none;" onchange="window.processarFoto()">
                </div>
            </div>
            <div class="glass-box" style="padding: 20px; border-top: none;">
                <input type="password" id="new-password" placeholder="Nova Senha">
                <button onclick="window.alterarSenha()" style="margin-top: 5px; background: #1565C0;">TROCAR SENHA</button>
                <button onclick="window.verNovidades()" class="secondary-btn" style="background: white; border-color: var(--primary); color: var(--primary); margin-top: 15px;">‚ú® NOVIDADES & HIST√ìRICO</button>
            </div>
            <button id="btn-admin-painel" onclick="window.abrirAdmin()" class="admin-btn" style="margin-top: 25px; background: #000; display: none;">PAINEL ADMIN</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="window.mudarAba('jogos')" id="btn-jogos"><span class="material-icons-round">sports_soccer</span>Confrontos</div>
            <div class="nav-item" onclick="window.mudarAba('ranking')" id="btn-ranking"><span class="material-icons-round">emoji_events</span>Ranking</div>
            <div class="nav-item" onclick="window.mudarAba('regras')" id="btn-regras"><span class="material-icons-round">gavel</span>Regras</div>
            <div class="nav-item" onclick="window.mudarAba('perfil')" id="btn-perfil"><span class="material-icons-round">person</span>Perfil</div>
            <div class="nav-item" onclick="window.sair()"><span class="material-icons-round">logout</span>Sair</div>
        </div>
    </div>

    <div id="modal-foto" class="modal" onclick="this.style.display='none'"><img id="modal-img" style="max-width: 90%; max-height: 80%; border: 5px solid white;"></div>
    
    <div id="modal-pote" class="modal"><div class="modal-box" style="text-align: center;"><div class="modal-header">üí∞ POTE DE OURO üí∞</div><div style="color: #666;">Total acumulado:</div><div id="pote-valor" class="pot-value">...</div><div style="font-size: 11px; color: #888; margin-top: 15px;">Quanto mais pagantes, maior o pr√™mio!</div><button onclick="document.getElementById('modal-pote').style.display='none'" style="margin-top: 20px;">SHOW!</button></div></div>
    
    <div id="modal-history" class="modal"><div class="modal-box"><div class="modal-header" id="history-title">...</div><div id="history-list"></div><button onclick="document.getElementById('modal-history').style.display='none'" class="secondary-btn" style="margin-top: 15px;">FECHAR</button></div></div>

    <div id="modal-whitelist" class="modal">
        <div class="modal-box">
            <div class="modal-header">GERENCIAR CONVITES</div>
            <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">Novo Convite:</div>
            <div style="display: flex; gap: 5px;">
                <input id="new-invite-user" placeholder="Usu√°rio (sem @)" style="margin: 0;">
                <button onclick="window.criarConvite()" style="margin: 0; width: auto; background: var(--primary);">+</button>
            </div>
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ccc;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; margin-bottom: 10px;">
                <span>Convites Vigentes:</span>
                <span style="color: #888;">Ordem A-Z</span>
            </div>
            <div id="whitelist-list" style="max-height: 200px; overflow-y: auto;"></div>
            <button onclick="document.getElementById('modal-whitelist').style.display='none'" class="secondary-btn" style="margin-top: 15px;">FECHAR</button>
        </div>
    </div>

    <div id="modal-delete-confirm" class="modal">
        <div class="modal-box" style="border-color: #d32f2f;">
            <div class="modal-header" style="color: #d32f2f; border-bottom-color: #d32f2f;">‚ö†Ô∏è REVOGAR ACESSO?</div>
            <div style="text-align: center;">
                <p style="font-size: 14px;">Voc√™ vai remover o convite de:</p>
                <h3 id="delete-target-user" style="font-size: 24px; margin: 10px 0;">...</h3>
                <p style="font-size: 12px; color: #666;">O usu√°rio perder√° o acesso imediatamente.<br><b>O hist√≥rico de pontos N√ÉO ser√° apagado.</b></p>
                <button onclick="window.executarExclusaoConvite()" style="background: #d32f2f; margin-top: 15px;">CONFIRMAR EXCLUS√ÉO</button>
                <button onclick="document.getElementById('modal-delete-confirm').style.display='none'" class="secondary-btn">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-finance" class="modal"><div class="modal-box" style="max-width: 600px;"><div class="modal-header">Gest√£o Financeira</div><div id="finance-list"></div><button onclick="document.getElementById('modal-finance').style.display='none'" class="secondary-btn">FECHAR</button></div></div>
    
    <div id="modal-game-editor" class="modal">
        <div class="modal-box">
            <div class="modal-header" id="modal-game-title">Novo Confronto</div>
            <input type="hidden" id="edit-match-id">
            <select id="adm-comp"></select>
            <select id="adm-round"><option>Oitavas de final</option><option>Quartas de final</option><option>Semi final</option><option>Final</option><option>Fase de Grupos (Apenas para teste)</option></select>
            <div style="display:flex;align-items:center;gap:5px;"><input id="adm-tA" placeholder="Time A"><span onclick="window.buscarLogo('adm-tA')" class="material-icons-round search-icon-btn">search</span></div>
            <input id="adm-urlA" placeholder="URL Imagem A">
            <div style="display:flex;align-items:center;gap:5px;"><input id="adm-tB" placeholder="Time B"><span onclick="window.buscarLogo('adm-tB')" class="material-icons-round search-icon-btn">search</span></div>
            <input id="adm-urlB" placeholder="URL Imagem B">
            <label style="font-size:12px;font-weight:bold;display:block;margin-top:10px;">Data e Hora:</label><input type="datetime-local" id="adm-date">
            <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <label class="notify-option"><input type="checkbox" id="notify-whatsapp" checked> Abrir WhatsApp</label>
                <label class="notify-option"><input type="checkbox" id="notify-push" checked> Enviar Push</label>
            </div>
            <button onclick="window.salvarJogo()">SALVAR</button>
            <button onclick="document.getElementById('modal-game-editor').style.display='none'" class="secondary-btn">CANCELAR</button>
        </div>
    </div>

    <div id="modal-winner" class="modal">
        <div class="modal-box">
            <div class="modal-header">QUEM VENCEU?</div>
            <input type="hidden" id="winner-match-id"><input type="hidden" id="winner-round">
            <button id="btn-win-A" onclick="window.setWinner(this.innerText)">Time A</button>
            <button id="btn-win-B" onclick="window.setWinner(this.innerText)">Time B</button>
            <button id="btn-win-draw" onclick="window.setWinner('Empate')" class="secondary-btn" style="display:none;">Empate</button>
            <button onclick="window.setWinner(null)" style="background:#d32f2f; margin-top:15px;">REMOVER VENCEDOR</button>
            <button onclick="document.getElementById('modal-winner').style.display='none'" class="secondary-btn">CANCELAR</button>
        </div>
    </div>

    <div id="modal-manage-comps" class="modal"><div class="modal-box"><div class="modal-header">Competi√ß√µes</div><div style="background:#eee;padding:10px;margin-bottom:10px;"><input type="hidden" id="edit-comp-orig"><input id="new-comp-name" placeholder="Nome"><div style="display:flex;gap:5px;"><input id="new-comp-logo" placeholder="URL Logo"><span class="material-icons-round search-icon-btn" onclick="window.buscarLogo('new-comp-name')">search</span></div><div style="text-align:right;margin-top:5px;"><button onclick="window.limparComp()" class="btn-small secondary-btn" style="width:auto;margin:0;">Limpar</button><button onclick="window.salvarCompeticao()" class="btn-small" style="width:auto;margin:0 0 0 5px;">Salvar</button></div></div><div id="comp-list"></div><button onclick="document.getElementById('modal-manage-comps').style.display='none'" class="secondary-btn">FECHAR</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEkEE2X5hWIqopoJ0D9jFzCjJHKR8b82k", authDomain: "bolao112fc.firebaseapp.com", projectId: "bolao112fc", storageBucket: "bolao112fc.firebasestorage.app", messagingSenderId: "131329454158", appId: "1:131329454158:web:983e4544dd651ec942131f" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        let currentUser = null; let isRegisterMode = false; let currentCompetitions = []; let inviteToDeleteId = "";

        // --- FUN√á√ïES DE NAVEGA√á√ÉO ---
        window.mudarAba = (aba) => {
            const bgs = {jogos:'bg_jogos.png', ranking:'bg_ranking.png', regras:'bg_regras.png', perfil:'bg_perfil.png'};
            document.body.style.backgroundImage = `url('${bgs[aba]}')`;
            const titles = {jogos:'BOL√ÉO 112 F.C', ranking:'CLASSIFICA√á√ÉO', regras:'REGULAMENTO', perfil:'PERFIL'};
            document.getElementById('header-title').innerText = titles[aba];
            ['jogos','ranking','regras','perfil','admin'].forEach(id => { document.getElementById(`container-${id}`).classList.add('hidden'); document.getElementById(`btn-${id}`)?.classList.remove('active'); });
            document.getElementById(`container-${aba}`).classList.remove('hidden');
            document.getElementById(`btn-${aba}`)?.classList.add('active');
            if(aba==='jogos') window.carregarJogos(); if(aba==='ranking') window.carregarRanking(); if(aba==='regras') window.carregarRegras(); if(aba==='perfil') window.carregarPerfil();
        };

        // --- GEST√ÉO DE CONVITES (WHITELIST) ---
        window.abrirGestaoConvites = () => {
            document.getElementById('modal-whitelist').style.display = 'flex';
            const listDiv = document.getElementById('whitelist-list');
            // Listener em tempo real para whitelist
            onSnapshot(collection(db, "whitelist"), (snap) => {
                let html = "";
                const invites = [];
                snap.forEach(d => invites.push(d.id));
                invites.sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase())); // Ordem A-Z
                invites.forEach(u => {
                    html += `<div class="whitelist-item">
                        <span style="display:flex;align-items:center;"><span class="material-icons-round" style="font-size:16px;margin-right:5px;color:#888;">person</span>${u}</span>
                        <button class="btn-delete" onclick="window.confirmarExclusaoConvite('${u}')"><span class="material-icons-round">delete</span></button>
                    </div>`;
                });
                listDiv.innerHTML = html || "<div style='text-align:center;padding:10px;color:#999;'>Nenhum convite ativo.</div>";
            });
        };

        window.criarConvite = async () => {
            const input = document.getElementById('new-invite-user');
            const user = input.value.trim().toLowerCase();
            if(!user) return alert("Digite o usu√°rio.");
            try {
                await setDoc(doc(db, "whitelist", user), { active: true });
                input.value = "";
                alert("Convite criado com sucesso!");
            } catch(e) { alert("Erro ao criar: " + e.message); }
        };

        window.confirmarExclusaoConvite = (userId) => {
            inviteToDeleteId = userId;
            document.getElementById('delete-target-user').innerText = userId.toUpperCase();
            document.getElementById('modal-delete-confirm').style.display = 'flex';
        };

        window.executarExclusaoConvite = async () => {
            if(!inviteToDeleteId) return;
            try {
                await deleteDoc(doc(db, "whitelist", inviteToDeleteId));
                document.getElementById('modal-delete-confirm').style.display = 'none';
                alert("Acesso revogado.");
            } catch(e) { alert("Erro ao excluir: " + e.message); }
        };

        // --- CORE DO APP ---
        window.processarAuth = async () => {
            const btn = document.getElementById('btn-login'); const msg = document.getElementById('login-msg');
            const email = document.getElementById('email').value.trim().toLowerCase() + "@bolao112.com";
            const pass = document.getElementById('password').value;
            btn.disabled = true; msg.innerText = "Verificando...";
            try {
                if(isRegisterMode) {
                    const name = document.getElementById('fullname').value.trim();
                    const user = document.getElementById('email').value.trim().toLowerCase();
                    if(!name || pass.length < 6) throw new Error("Preencha corretamente.");
                    const w = await getDoc(doc(db, "whitelist", user));
                    if(!w.exists()) throw new Error("Usu√°rio n√£o convidado.");
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), { name: name, username: user, isAdmin: false, debts: 0, appVersion: "Web v1.3.2" });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) { msg.innerText = e.message; btn.disabled = false; }
        };

        window.carregarJogos = async () => {
            document.getElementById('loading-jogos').classList.remove('hidden'); document.getElementById('lista-jogos').innerHTML = "";
            const [mSnap, gSnap, cSnap] = await Promise.all([getDocs(query(collection(db, "matches"))), getDocs(collection(db, "guesses")), getDoc(doc(db, "settings", "competitions"))]);
            const logos = {}; if(cSnap.exists()) (cSnap.data().items||[]).forEach(i => logos[i.name] = i.logo);
            const guesses = {}; gSnap.forEach(g => { if(g.data().userId === currentUser.uid) guesses[g.data().matchId] = g.data().teamSelected; });
            
            const matches = []; mSnap.forEach(d => matches.push({id:d.id, ...d.data(), date: d.data().deadline?.toDate()}));
            const now = new Date();
            const open = matches.filter(m => m.date > now && !m.winner).sort((a,b) => a.date - b.date);
            const wait = matches.filter(m => m.date <= now && !m.winner).sort((a,b) => b.date - a.date);
            const done = matches.filter(m => m.winner).sort((a,b) => b.date - a.date);

            const render = (list, title, color) => {
                if(!list.length) return;
                const div = document.createElement('div');
                div.innerHTML = `<div class="section-tag" style="color:${color}; border-color:${color};">${title}</div>`;
                list.forEach(m => {
                    const isFinal = m.round?.toLowerCase() === "final";
                    const isExpired = m.date <= now;
                    const myVote = guesses[m.id];
                    const dateStr = m.date ? m.date.toLocaleDateString('pt-BR') + ' ' + m.date.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) : '';
                    
                    let html = `<div class="card ${isFinal?'card-final':''}">`;
                    if(logos[m.competition]) html += `<img src="${logos[m.competition]}" class="comp-watermark">`;
                    if(isFinal) html += `<div style="text-align:center;color:#F57F17;font-weight:900;font-size:12px;margin-bottom:5px;">‚ú®üèÜ GRANDE FINAL ‚Ä¢ VALE DOBRO üèÜ‚ú®</div>`;
                    
                    // Header com Emoticons
                    let statusLine = isExpired ? `<span style="color:#d32f2f;">üîí ENCERRADO: ${dateStr}</span>` : `<span class="material-icons-round" style="font-size:12px;vertical-align:middle;">schedule</span> PRAZO: ${dateStr}`;
                    if(isExpired && m.winner) statusLine = isFinal ? `<span style="color:#F57F17;font-size:16px;">üèÜ CAMPE√ÉO: ${m.winner}</span>` : `<span style="color:#006400;font-size:14px;">VENCEDOR: ${m.winner}</span>`;
                    
                    html += `<div class="match-comp">${m.competition}</div><div class="match-info">${m.round}<br>${statusLine}</div>`;
                    
                    // Times
                    html += `<div class="teams">
                        <div class="team-box ${myVote===m.teamA?'selected':''}" ${!isExpired ? `onclick="window.votar('${m.id}','${m.teamA}')"` : ''}>
                            <img src="${m.teamAUrl}" onerror="this.src='https://placehold.co/50?text=A'">
                            <div class="team-name">${m.teamA}</div>
                        </div>
                        <div class="vs">X</div>
                        <div class="team-box ${myVote===m.teamB?'selected':''}" ${!isExpired ? `onclick="window.votar('${m.id}','${m.teamB}')"` : ''}>
                            <img src="${m.teamBUrl}" onerror="this.src='https://placehold.co/50?text=B'">
                            <div class="team-name">${m.teamB}</div>
                        </div>
                    </div>`;
                    
                    if(myVote && !isExpired) html += `<div class="status-msg" style="color:#2e7d32;">‚úÖ Voto confirmado: ${myVote}</div>`;
                    html += `<div class="status-msg"><span onclick="window.verPalpites('${m.id}','${m.teamA}','${m.teamB}',${isExpired},'${m.teamAUrl}','${m.teamBUrl}','${m.winner||''}')" style="text-decoration:underline;cursor:pointer;color:#555;">${isExpired?'Ver Palpites da Galera':'Quem j√° votou?'}</span></div></div>`;
                    div.innerHTML += html;
                });
                document.getElementById('lista-jogos').appendChild(div);
            };

            render(open, "‚úÖ CONFRONTOS DISPON√çVEIS ‚úÖ", "#006400");
            render(wait, "‚è≥ AGUARDANDO RESULTADO ‚è≥", "#F9A825");
            render(done, "üö´ CONFRONTOS FINALIZADOS üö´", "#D32F2F");
            if(!matches.length) document.getElementById('lista-jogos').innerHTML = "<div style='text-align:center;padding:20px;'>Nada por aqui.</div>";
            document.getElementById('loading-jogos').classList.add('hidden');
        };

        window.votar = async (mid, team) => { await setDoc(doc(db,"guesses",`${mid}_${currentUser.uid}`), {matchId:mid, userId:currentUser.uid, teamSelected:team, timestamp:new Date()}); window.carregarJogos(); };
        
        window.carregarRanking = async () => {
            const tbody = document.getElementById('lista-ranking'); tbody.innerHTML = "<tr><td colspan='6'>Calculando...</td></tr>";
            const [uSnap, gSnap, mSnap] = await Promise.all([getDocs(collection(db,"users")), getDocs(collection(db,"guesses")), getDocs(collection(db,"matches"))]);
            const matches = []; mSnap.forEach(d => { if(d.data().winner) matches.push({id:d.id, ...d.data()}); });
            
            // Last Update
            const lastM = matches.sort((a,b) => b.deadline?.toDate() - a.deadline?.toDate())[0];
            if(lastM) document.getElementById('last-update').innerText = "√öltima atualiza√ß√£o: " + lastM.teamA + " x " + lastM.teamB;

            const rank = [];
            const oitavas = matches.filter(m => m.round === "Oitavas de final").reduce((acc, m) => { (acc[m.competition] = acc[m.competition] || []).push(m); return acc; }, {});

            uSnap.forEach(u => {
                const ud = u.data(); let pts=0, v=0, f=0, d=ud.debts||0, hist=[];
                const myGs = []; gSnap.forEach(g => { if(g.data().userId===u.id) myGs.push(g.data()); });
                
                myGs.forEach(g => {
                    const m = matches.find(x => x.id === g.matchId);
                    if(m && m.winner === g.teamSelected) {
                        const isF = m.round === "Final";
                        if(isF) { pts+=6; v++; f++; hist.push(`üèÜ Final: ${m.teamA} x ${m.teamB}`); }
                        else { pts+=3; v++; hist.push(`‚úÖ Acerto: ${m.teamA} x ${m.teamB}`); }
                    }
                });
                
                for(let c in oitavas) {
                    const ms = oitavas[c];
                    if(ms.every(m => myGs.some(g => g.matchId===m.id && g.teamSelected===m.winner))) { pts+=3; hist.push(`üåü B√¥nus Oitavas: ${c}`); }
                }
                if(d>0) { pts-=d; hist.push(`üîª Inadimpl√™ncia (-${d})`); }
                rank.push({name:ud.name, photo:ud.photoBase64, pts, v, f, d, hist});
            });

            rank.sort((a,b) => b.pts - a.pts || a.d - b.d || b.v - a.v || b.f - a.f);
            tbody.innerHTML = "";
            rank.forEach((r,i) => {
                let cls = ""; if(i===0) cls="row-gold"; if(i===1) cls="row-silver"; if(i===2) cls="row-bronze";
                const img = r.photo ? `data:image/jpeg;base64,${r.photo}` : 'https://via.placeholder.com/30';
                tbody.innerHTML += `<tr class="${cls}">
                    <td>${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':(i+1)+'¬∫'}</td>
                    <td class="td-nome" onclick="window.verFoto('${img}')"><img src="${img}" class="rank-avatar">${r.name}</td>
                    <td class="debit clickable-stats" onclick="window.verExtrato('${r.name}')">${r.d}</td>
                    <td class="clickable-stats" onclick="window.verExtrato('${r.name}')">${r.v}</td>
                    <td class="clickable-stats" onclick="window.verExtrato('${r.name}')">${r.f}</td>
                    <td class="points clickable-stats" onclick="window.verExtrato('${r.name}')">${r.pts}</td>
                </tr>`;
                // Gambiarra pra salvar hist√≥rico no window pra abrir depois (simples)
                window['hist_'+r.name] = r.hist;
            });
        };

        window.verExtrato = (name) => {
            const h = window['hist_'+name] || [];
            document.getElementById('history-title').innerText = "Extrato: " + name;
            document.getElementById('history-list').innerHTML = h.length ? h.map(x=>`<div class="log-item">${x}</div>`).join('') : '<div style="padding:10px;">Sem pontos.</div>';
            document.getElementById('modal-history').style.display = 'flex';
        };
        
        window.verFoto = (src) => { document.getElementById('modal-img').src = src; document.getElementById('modal-foto').style.display = 'flex'; };
        
        window.verPalpites = async (mid, tA, tB, exp, uA, uB, win) => {
            document.getElementById('history-title').innerText = exp ? "Palpites (Encerrado)" : "Quem Votou";
            const list = document.getElementById('history-list'); list.innerHTML = "Carregando...";
            document.getElementById('modal-history').style.display = 'flex';
            const [gSnap, uSnap] = await Promise.all([getDocs(query(collection(db,"guesses"))), getDocs(collection(db,"users"))]);
            const users = {}; uSnap.forEach(u => users[u.id] = u.data());
            let html = "";
            gSnap.forEach(g => {
                if(g.data().matchId === mid) {
                    const u = users[g.data().userId];
                    const vote = g.data().teamSelected;
                    let icon = "";
                    if(exp) {
                        if(vote === tA) icon = `<img src="${uA}" style="width:20px;">`;
                        else if(vote === tB) icon = `<img src="${uB}" style="width:20px;">`;
                        if(win && win !== "Empate") {
                            icon += (vote === win) ? ' <span style="color:green">‚úî</span>' : ' <span style="color:red">‚úñ</span>';
                        }
                    }
                    html += `<div class="log-item" style="display:flex;justify-content:space-between;"><span>${u.name}</span><span>${icon}</span></div>`;
                }
            });
            list.innerHTML = html || "Nenhum voto.";
        };

        // ADMIN FINANCEIRO E JOGOS (L√≥gica mantida, visual atualizado no HTML)
        window.abrirGestaoUsuarios = async () => { 
            document.getElementById('modal-finance').style.display = 'flex'; 
            const list = document.getElementById('finance-list'); 
            list.innerHTML = "Carregando..."; 
            const snap = await getDocs(collection(db, "users")); 
            let html = ""; 
            const users = []; 
            snap.forEach(d => users.push({id:d.id, ...d.data()})); 
            users.sort((a,b) => (a.name||"").localeCompare(b.name||"")); 
            const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"]; 
            
            users.forEach(u => { 
                const debts = u.debts || 0; 
                let monthsHtml = ""; 
                months.forEach(m => { 
                    const isPaid = u.payments && u.payments[m]; 
                    monthsHtml += `<div class="month-item ${isPaid?'paid':''}" onclick="window.togglePayment('${u.id}', '${m}', ${!isPaid})">${m}</div>`; 
                }); 
                html += `
                <div style="border-bottom:1px solid #eee; padding:10px 0;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${u.name} <small style="color:blue;">(${u.appVersion||'-'})</small></span>
                        <span style="color:red">D√©b: ${debts}</span>
                    </div>
                    <div style="display:flex; gap:10px; margin:5px 0;">
                        <button class="btn-small" onclick="window.mudarDebito('${u.id}', ${debts-1})">-1</button>
                        <button class="btn-small btn-danger" onclick="window.mudarDebito('${u.id}', ${debts+1})">+1</button>
                    </div>
                    <div class="month-grid">${monthsHtml}</div>
                </div>`; 
            }); 
            list.innerHTML = html; 
        };
        window.togglePayment = async (uid, month, status) => { const ref = doc(db, "users", uid); const key = `payments.${month}`; await updateDoc(ref, { [key]: status }); window.abrirGestaoUsuarios(); };
        window.mudarDebito = async (uid, val) => { if(val < 0) val = 0; await updateDoc(doc(db, "users", uid), { debts: val }); window.abrirGestaoUsuarios(); };

        // Admin Jogos (Mantido simplificado, chamadas no HTML)
        window.abrirAdmin = () => { ['jogos', 'ranking', 'regras', 'perfil'].forEach(a => document.getElementById(`container-${a}`).classList.add('hidden')); document.getElementById('container-admin').classList.remove('hidden'); document.getElementById('header-title').innerText = "Painel Admin"; window.loadCompetitions(); };
        window.fecharAdmin = () => { document.getElementById('container-admin').classList.add('hidden'); document.getElementById('container-perfil').classList.remove('hidden'); window.mudarAba('perfil'); };
        window.abrirGestaoJogos = async () => { document.getElementById('modal-manage-games').style.display = 'flex'; const snap = await getDocs(query(collection(db, "matches"), orderBy("deadline", "desc"))); const div = document.getElementById('admin-games-list'); div.innerHTML = ""; snap.forEach(d => { const m = {id:d.id, ...d.data()}; div.innerHTML += `<div style="border:1px solid #ccc; padding:10px; margin-bottom:5px;"><div style="font-weight:bold">${m.teamA} x ${m.teamB}</div><div>${m.winner?'‚úÖ '+m.winner:'‚è≥ Aberto'}</div><div class="admin-actions"><button class="btn-small btn-edit" onclick="window.abrirEditarJogo('${m.id}', '${m.teamA}', '${m.teamB}', '${m.teamAUrl}', '${m.teamBUrl}', '${m.competition}', '${m.round}', '${m.deadline ? m.deadline.toDate().toISOString() : ''}')">‚úèÔ∏è</button><button class="btn-small btn-edit" onclick="window.abrirDefinirVencedor('${m.id}','${m.teamA}','${m.teamB}', '${m.round}')">üèÜ</button><button class="btn-small btn-danger" onclick="window.excluirJogo('${m.id}')">üóëÔ∏è</button></div></div>`; }); };
        
        // ... (Restante das fun√ß√µes auxiliares de admin como salvarJogo, definirVencedor, etc. permanecem iguais √† vers√£o anterior, apenas com o CSS atualizado) ...
        // Re-declaring key admin functions for completeness in this block if not already present in memory:
        window.abrirNovoJogo = () => { document.getElementById('modal-game-title').innerText = "Novo Confronto"; document.getElementById('edit-match-id').value = ""; document.getElementById('modal-game-editor').style.display = 'flex'; }
        window.salvarJogo = async () => { 
            const id = document.getElementById('edit-match-id').value; 
            const data = { 
                teamA: document.getElementById('adm-tA').value, 
                teamB: document.getElementById('adm-tB').value, 
                teamAUrl: document.getElementById('adm-urlA').value, 
                teamBUrl: document.getElementById('adm-urlB').value, 
                competition: document.getElementById('adm-comp').value, 
                round: document.getElementById('adm-round').value, 
                deadline: new Date(document.getElementById('adm-date').value) 
            };
            if(id) await updateDoc(doc(db,"matches",id), data); else { data.winner=null; await addDoc(collection(db,"matches"), data); }
            document.getElementById('modal-game-editor').style.display='none'; window.abrirGestaoJogos();
        };
        window.abrirEditarJogo = (id, tA, tB, uA, uB, c, r, d) => {
            document.getElementById('modal-game-title').innerText = "Editar"; document.getElementById('edit-match-id').value=id;
            document.getElementById('adm-tA').value=tA; document.getElementById('adm-tB').value=tB; document.getElementById('adm-urlA').value=uA; document.getElementById('adm-urlB').value=uB;
            document.getElementById('adm-comp').value=c; document.getElementById('adm-round').value=r; 
            if(d) { const date = new Date(d); const offset = date.getTimezoneOffset() * 60000; document.getElementById('adm-date').value = (new Date(date - offset)).toISOString().slice(0, 16); }
            document.getElementById('modal-game-editor').style.display='flex';
        };
        window.excluirJogo = async (id) => { if(confirm("Apagar?")) { await deleteDoc(doc(db,"matches",id)); window.abrirGestaoJogos(); } };
        window.abrirDefinirVencedor = (id, tA, tB, round) => { document.getElementById('winner-match-id').value = id; document.getElementById('btn-win-A').innerText = tA; document.getElementById('btn-win-B').innerText = tB; document.getElementById('btn-win-draw').style.display = round.includes("Grupo") ? 'block' : 'none'; document.getElementById('modal-winner').style.display = 'flex'; };
        window.setWinner = async (w) => { const id = document.getElementById('winner-match-id').value; await updateDoc(doc(db,"matches",id), {winner:w}); document.getElementById('modal-winner').style.display='none'; window.abrirGestaoJogos(); };
        
        window.alternarModo = () => { isRegisterMode=!isRegisterMode; document.getElementById('btn-login').innerText=isRegisterMode?"CADASTRAR":"ENTRAR"; document.getElementById('fullname').classList.toggle('hidden'); };
        window.sair = () => signOut(auth);
        
        onAuthStateChanged(auth, (u) => { if(u) { currentUser=u; verificarAdmin(u.uid); const userRef = doc(db, "users", u.uid); updateDoc(userRef, { appVersion: "Web v1.3.2", lastAccess: new Date() }); document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-screen').classList.remove('hidden'); window.mudarAba('jogos'); } else { currentUser=null; document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('app-screen').classList.add('hidden'); } });
    </script>
</body>
</html>
