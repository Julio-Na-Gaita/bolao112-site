<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bol√£o 112 F.C</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap');
        :root { --dark-green: #006400; --gold: #FFD700; }
        body { font-family: 'PT Serif', serif; -webkit-tap-highlight-color: transparent; user-select: none; background-color: #f3f4f6; }
        
        /* Utilit√°rios Visuais */
        .card-cut { background: white; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)); border: 1px solid #e5e7eb; }
        .bg-main { background-size: cover; background-attachment: fixed; background-position: center; transition: background 0.3s ease; }
        .tab-matches { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_jogos.png'); }
        .tab-ranking { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_ranking.png'); }
        
        .btn-press:active { transform: scale(0.95); transition: 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-[#006400] text-white pt-[env(safe-area-inset-top)] sticky top-0 z-50 shadow-md">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold tracking-tighter uppercase">Bol√£o 112 F.C</h1>
            <div class="flex gap-4">
                <button id="btnRefresh" class="btn-press"><i class="fas fa-sync-alt text-xl"></i></button>
                <button id="btnLogout" class="hidden btn-press"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </div>
        <div id="progressBar" class="hidden h-1 w-full bg-[#006400]"><div class="h-full bg-[#FFD700] animate-pulse w-full"></div></div>
    </nav>

    <main id="appContent" class="flex-1 overflow-y-auto bg-main tab-matches pb-32">
        
        <section id="loginScreen" class="flex flex-col items-center justify-center min-h-[70vh] p-6">
            <div class="card-cut w-full max-w-sm p-8 border-t-4 border-[#006400]">
                <h2 class="text-xl font-black text-center text-[#006400] mb-8 uppercase tracking-widest">Acesso Membros</h2>
                <input type="text" id="userInput" placeholder="Usu√°rio" class="w-full p-4 bg-gray-50 border rounded-lg mb-4 outline-none focus:ring-2 focus:ring-green-700">
                <input type="password" id="passInput" placeholder="Senha" class="w-full p-4 bg-gray-50 border rounded-lg mb-8 outline-none focus:ring-2 focus:ring-green-700">
                <button id="btnLoginAction" class="w-full bg-[#006400] text-white py-4 font-bold rounded-lg btn-press shadow-lg">ACESSAR</button>
            </div>
        </section>

        <div id="mainScreens" class="hidden p-4 space-y-4">
            
            <div id="matchesScreen" class="hidden space-y-6"></div>

            <div id="rankingScreen" class="hidden">
                <div class="card-cut p-4 mb-4 border-t-2 border-[#FFD700]">
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <h3 class="font-bold text-lg text-gray-800">Classifica√ß√£o</h3>
                        <button onclick="loadRanking()" class="text-[#006400] btn-press"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    
                    <div class="grid grid-cols-[30px_1fr_30px_30px_30px_40px] text-[10px] font-bold text-gray-400 uppercase text-center items-center pb-2">
                        <span>Pos</span>
                        <span class="text-left pl-2">Nome</span>
                        <span class="text-red-500">D</span>
                        <span>V</span>
                        <span>F</span>
                        <span class="text-black">PTS</span>
                    </div>
                    
                    <div id="rankingListContent" class="space-y-1"></div>
                </div>
                
                <div class="bg-black/80 text-[#FFD700] p-3 text-[10px] text-center rounded-lg shadow-lg">
                    <p class="font-bold mb-1">Legenda: D=D√©bitos(-1) | V=Vit√≥rias | F=Finais | PTS=Pontos</p>
                    <p id="lastUpdateRanking" class="text-white font-normal">Aguardando atualiza√ß√£o...</p>
                </div>
            </div>

        </div>
    </main>

    <div id="modalOverlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in" onclick="closeModal()">
        <div id="modalContainer" class="w-full max-w-sm bg-white rounded-none shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            </div>
    </div>

    <nav id="bottomNav" class="hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t safe-bottom flex justify-around p-2 z-50 shadow-2xl">
        <button onclick="showTab('matches')" class="nav-btn flex flex-col items-center text-[#006400]" id="nav-matches"><i class="fas fa-soccer-ball text-lg"></i><span class="text-[10px] mt-1">Jogos</span></button>
        <button onclick="showTab('ranking')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-ranking"><i class="fas fa-trophy text-lg"></i><span class="text-[10px] mt-1">Ranking</span></button>
        <button class="nav-btn flex flex-col items-center text-gray-400 opacity-50 cursor-not-allowed"><i class="fas fa-gavel text-lg"></i><span class="text-[10px] mt-1">Regras</span></button>
        <button class="nav-btn flex flex-col items-center text-gray-400 opacity-50 cursor-not-allowed"><i class="fas fa-user text-lg"></i><span class="text-[10px] mt-1">Perfil</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEkEE2X5hWIqopoJ0D9jFzCjJHKR8b82k",
            authDomain: "bolao112fc.firebaseapp.com",
            projectId: "bolao112fc",
            storageBucket: "bolao112fc.firebasestorage.app",
            messagingSenderId: "131329454158",
            appId: "1:131329454158:web:983e4544dd651ec942131f",
            measurementId: "G-5SGWJE6EKK"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- AUTH ---
        document.getElementById('btnLoginAction').onclick = async () => {
            const user = document.getElementById('userInput').value.trim().toLowerCase();
            const pass = document.getElementById('passInput').value;
            try { await signInWithEmailAndPassword(auth, `${user}@bolao112.com`, pass); } 
            catch (e) { alert("Dados incorretos."); }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreens').classList.remove('hidden');
                document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('btnLogout').classList.remove('hidden');
                showTab('matches');
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainScreens').classList.add('hidden');
                document.getElementById('bottomNav').classList.add('hidden');
            }
        });

        // --- NAVEGA√á√ÉO ---
        window.showTab = (tab) => {
            const content = document.getElementById('appContent');
            content.className = `flex-1 overflow-y-auto bg-main pb-32 tab-${tab}`;
            
            document.getElementById('matchesScreen').classList.add('hidden');
            document.getElementById('rankingScreen').classList.add('hidden');
            document.getElementById(`nav-matches`).classList.replace('text-[#006400]', 'text-gray-400');
            document.getElementById(`nav-ranking`).classList.replace('text-[#006400]', 'text-gray-400');

            if(tab === 'matches') {
                document.getElementById('matchesScreen').classList.remove('hidden');
                // loadMatches(); -> Fun√ß√£o da etapa anterior (n√£o inclu√≠da aqui para focar no ranking)
            } else if(tab === 'ranking') {
                document.getElementById('rankingScreen').classList.remove('hidden');
                loadRanking();
            }
            document.getElementById(`nav-${tab}`).classList.replace('text-gray-400', 'text-[#006400]');
        };

        // --- L√ìGICA DO RANKING (Port do Kotlin para JS) ---
        async function loadRanking() {
            const list = document.getElementById('rankingListContent');
            const footer = document.getElementById('lastUpdateRanking');
            const progress = document.getElementById('progressBar');
            
            list.innerHTML = `<div class="text-center py-10 text-green-800"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
            progress.classList.remove('hidden');

            try {
                // 1. Carregar todas as cole√ß√µes necess√°rias em paralelo
                const [usersSnap, guessesSnap, matchesSnap] = await Promise.all([
                    getDocs(collection(db, "users")),
                    getDocs(collection(db, "guesses")),
                    getDocs(collection(db, "matches"))
                ]);

                // 2. Processar Jogos (Identificar Finalizados e Oitavas)
                const allMatches = [];
                matchesSnap.forEach(d => allMatches.push({id: d.id, ...d.data()}));
                
                const finishedMatches = allMatches.filter(m => m.winner);
                const oitavasByComp = {}; // Agrupamento para b√¥nus

                // Configurar data da √∫ltima atualiza√ß√£o
                if(finishedMatches.length > 0) {
                    // Ordena para pegar o mais recente
                    finishedMatches.sort((a,b) => b.deadline.toDate() - a.deadline.toDate());
                    const last = finishedMatches[0];
                    const dateStr = last.deadline.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                    footer.innerText = `√öltima atualiza√ß√£o: ${last.teamA} x ${last.teamB} em ${dateStr}`;
                } else {
                    footer.innerText = "Nenhum confronto finalizado ainda.";
                }

                // Agrupar Oitavas por competi√ß√£o
                finishedMatches.forEach(m => {
                    if(m.round === "Oitavas de final") {
                        if(!oitavasByComp[m.competition]) oitavasByComp[m.competition] = [];
                        oitavasByComp[m.competition].push(m);
                    }
                });

                // 3. Processar Usu√°rios (C√°lculo de Pontos)
                let rankingData = [];
                const now = new Date();

                usersSnap.forEach(userDoc => {
                    const u = userDoc.data();
                    let points = 0, victories = 0, finalsWon = 0;
                    const historyEvents = [];
                    const debts = u.debts || 0;
                    
                    // Filtrar palpites deste usu√°rio
                    const userGuesses = [];
                    guessesSnap.forEach(g => { if(g.data().userId === userDoc.id) userGuesses.push(g.data()) });

                    // A) Pontos por Acerto/Erro
                    userGuesses.forEach(guess => {
                        const match = finishedMatches.find(m => m.id === guess.matchId);
                        if(match) {
                            const dateObj = match.deadline.toDate();
                            const dateStr = dateObj.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                            
                            if(match.winner === guess.teamSelected) {
                                const isFinal = match.round === "Final";
                                if(isFinal) {
                                    points += 6; victories++; finalsWon++;
                                    historyEvents.push({date: dateObj, text: `üìÖ ${dateStr} - üèÜ Acerto Final: ${match.teamA} x ${match.teamB} (+6)`});
                                } else {
                                    points += 3; victories++;
                                    historyEvents.push({date: dateObj, text: `üìÖ ${dateStr} - ‚úÖ Acerto: ${match.teamA} x ${match.teamB} (+3)`});
                                }
                            } else {
                                historyEvents.push({date: dateObj, text: `üìÖ ${dateStr} - üëé Errou: ${match.teamA} x ${match.teamB} (Voto: ${guess.teamSelected})`, type: 'bad'});
                            }
                        }
                    });

                    // B) B√¥nus Oitavas
                    for (const [compName, compMatches] of Object.entries(oitavasByComp)) {
                        if(compMatches.length > 0) {
                            const hits = compMatches.filter(m => {
                                const g = userGuesses.find(guess => guess.matchId === m.id);
                                return g && g.teamSelected === m.winner;
                            }).length;
                            
                            if(hits === 8) { // Acertou todas as oitavas daquela competi√ß√£o (L√≥gica do Android pode variar se a competi√ß√£o n√£o tiver 8 jogos, mas seguindo o c√≥digo)
                                points += 3;
                                const lastDate = compMatches[0].deadline.toDate(); // Data aproximada
                                historyEvents.push({date: lastDate, text: `üåü B√¥nus Oitavas: ${compName} (+3)`});
                            }
                        }
                    }

                    // C) Aus√™ncias (N√£o votou)
                    allMatches.forEach(match => {
                        const deadline = match.deadline.toDate();
                        if (now > deadline) {
                            const hasVote = userGuesses.some(g => g.matchId === match.id);
                            if (!hasVote) {
                                const dateStr = deadline.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                                historyEvents.push({date: deadline, text: `üìÖ ${dateStr} - ‚ùå N√£o votou: ${match.teamA} x ${match.teamB}`, type: 'bad'});
                            }
                        }
                    });

                    // D) Penalidade Financeira
                    if(debts > 0) {
                        points -= debts;
                        historyEvents.push({date: now, text: `üîª Penalidade Inadimpl√™ncia (-${debts})`, type: 'bad'});
                    }

                    // Ordenar hist√≥rico (Mais recente primeiro)
                    historyEvents.sort((a,b) => b.date - a.date);
                    
                    rankingData.push({
                        id: userDoc.id,
                        name: u.name || u.username || "Sem Nome",
                        photo: u.photoBase64,
                        lastRank: u.lastRank || 0,
                        debts, points, victories, finalsWon,
                        history: historyEvents // Guardar objeto para renderizar depois
                    });
                });

                // 4. Ordena√ß√£o do Ranking (Igual ao Android: Pts > Divida > Vit > Finais)
                rankingData.sort((a,b) => {
                    if(b.points !== a.points) return b.points - a.points;
                    if(a.debts !== b.debts) return a.debts - b.debts; // Menor divida melhor
                    if(b.victories !== a.victories) return b.victories - a.victories;
                    return b.finalsWon - a.finalsWon;
                });

                // 5. Renderiza√ß√£o da Lista
                list.innerHTML = rankingData.map((u, index) => {
                    const pos = index + 1;
                    const rankDiff = calculateRankDiff(pos, u.lastRank); // Fun√ß√£o auxiliar
                    
                    // Cores das linhas (Ouro, Prata, Bronze, Branco)
                    let bgClass = "bg-white";
                    if(pos === 1) bgClass = "bg-[#FFF9C4]"; // Amarelo
                    else if(pos === 2) bgClass = "bg-[#E0E0E0]"; // Cinza
                    else if(pos === 3) bgClass = "bg-[#FFCCBC]"; // Laranja/Bronze

                    return `
                        <div class="${bgClass} rounded-lg p-2 flex items-center border border-gray-100 shadow-sm mb-1 text-xs">
                            
                            <div class="w-[30px] flex flex-col items-center justify-center">
                                <span class="font-bold text-sm">${getMedalOrNum(pos)}</span>
                                ${rankDiff}
                            </div>

                            <div class="flex-1 flex items-center gap-2 pl-1 overflow-hidden btn-press" onclick="openPhotoModal('${u.photo}', '${u.name}')">
                                ${u.photo ? 
                                    `<img src="data:image/jpeg;base64,${u.photo}" class="w-8 h-8 rounded-full object-cover border border-gray-300">` : 
                                    `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>`
                                }
                                <span class="font-bold text-gray-800 truncate leading-tight">${u.name}</span>
                            </div>

                            <div class="flex items-center btn-press" onclick="openHistoryModal('${u.name}', '${escapeHtml(JSON.stringify(u.history))}')">
                                <div class="w-[30px] text-center text-red-600 font-bold">${u.debts}</div>
                                <div class="w-[30px] text-center text-gray-600">${u.victories}</div>
                                <div class="w-[30px] text-center text-gray-600">${u.finalsWon}</div>
                                <div class="w-[40px] text-center font-black text-[#006400] text-sm">${u.points}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error(e);
                list.innerHTML = `<div class="text-center text-red-500 py-4">Erro ao carregar ranking.</div>`;
            } finally {
                progress.classList.add('hidden');
            }
        }

        // --- HELPERS VISUAIS ---
        function getMedalOrNum(pos) {
            if(pos===1) return 'ü•á';
            if(pos===2) return 'ü•à';
            if(pos===3) return 'ü•â';
            return `${pos}¬∫`;
        }

        function calculateRankDiff(current, previous) {
            if(!previous || previous === 0) return '';
            if(current < previous) { // Subiu (ex: era 5, virou 3)
                const diff = previous - current;
                return `<div class="flex items-center text-[#2E7D32] text-[10px] leading-none"><i class="fas fa-caret-up"></i><span class="font-bold ml-0.5">${diff}</span></div>`;
            } else if(current > previous) { // Desceu
                const diff = current - previous;
                return `<div class="flex items-center text-red-600 text-[10px] leading-none"><i class="fas fa-caret-down"></i><span class="font-bold ml-0.5">${diff}</span></div>`;
            } else { // Igual
                return `<div class="text-gray-400 text-[8px] leading-none"><i class="fas fa-minus"></i></div>`;
            }
        }

        // --- MODAIS (FOTO E HIST√ìRICO) ---
        window.openPhotoModal = (b64, name) => {
            if(!b64) return;
            const content = document.getElementById('modalContainer');
            document.getElementById('modalOverlay').classList.remove('hidden');
            content.innerHTML = `
                <div class="card-cut p-6 bg-white text-center">
                    <h3 class="font-bold text-[#006400] text-lg uppercase mb-4">${name}</h3>
                    <img src="data:image/jpeg;base64,${b64}" class="w-64 h-64 mx-auto rounded-lg shadow-lg object-cover bg-gray-100 mb-6">
                    <button onclick="closeModal()" class="w-full bg-[#006400] text-white py-3 rounded font-bold btn-press">FECHAR</button>
                </div>
            `;
        };

        window.openHistoryModal = (name, historyJson) => {
            const history = JSON.parse(decodeHtml(historyJson));
            const content = document.getElementById('modalContainer');
            document.getElementById('modalOverlay').classList.remove('hidden');
            
            let listHtml = "";
            if(history.length === 0) listHtml = `<p class="text-center text-gray-400 py-4">Nenhum registro.</p>`;
            else {
                listHtml = history.map(h => `
                    <div class="border-b border-gray-100 py-2">
                        <p class="text-xs ${h.type === 'bad' ? 'text-red-600 font-normal' : 'text-gray-800 font-bold'}">
                            ‚Ä¢ ${h.text}
                        </p>
                    </div>
                `).join('');
            }

            content.innerHTML = `
                <div class="card-cut p-0 overflow-hidden bg-white">
                    <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                        <h3 class="font-bold text-[#006400] text-sm uppercase">Extrato: ${name}</h3>
                        <button onclick="closeModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="max-h-[50vh] overflow-y-auto p-4 space-y-1">
                        ${listHtml}
                    </div>
                    <div class="bg-gray-50 p-3 text-center">
                        <button onclick="closeModal()" class="text-[#006400] font-black text-xs">FECHAR</button>
                    </div>
                </div>
            `;
        };

        // --- UTILIT√ÅRIOS ---
        window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');
        function escapeHtml(text) { return text.replace(/"/g, "&quot;"); }
        function decodeHtml(text) { return text.replace(/&quot;/g, '"'); }

        // Botoes Globais
        document.getElementById('btnRefresh').onclick = () => {
            const active = document.querySelector('nav#bottomNav .text-\\[\\#006400\\]').id.replace('nav-','');
            showTab(active);
        };
        document.getElementById('btnLogout').onclick = () => signOut(auth);

    </script>
</body>
</html>
