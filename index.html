<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bol√£o 112 F.C</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap');
        
        :root { --dark-green: #006400; --gold: #FFD700; }
        
        body { 
            font-family: 'PT Serif', serif; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            background-color: #f3f4f6;
        }

        /* Replica Exata do CutCornerShape(topStart = 16.dp, bottomEnd = 16.dp) */
        .card-cut {
            background: white;
            clip-path: polygon(20px 0, 100% 0, 100% 100%, calc(100% - 20px) 100%, 0 100%, 0 20px);
            /* Nota: CSS Clip-path puro n√£o suporta sombras perfeitas facilmente, 
               usaremos filter drop-shadow no elemento pai se necess√°rio ou bordas simuladas */
            border: 1px solid #e5e7eb;
        }
        
        /* Ajuste fino para simular a borda do Android com clip-path */
        .card-container {
            filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.15));
        }

        .bg-app { 
            background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_jogos.png');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }

        /* Anima√ß√£o de clique do TeamVotingButton */
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.90); }

        /* Utilit√°rios */
        .safe-top { padding-top: env(safe-area-inset-top); }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-100">

    <nav class="bg-[#006400] text-white pt-[env(safe-area-inset-top)] sticky top-0 z-50 shadow-md">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold tracking-tighter uppercase">Bol√£o 112 F.C</h1>
            <div class="flex gap-4">
                <button id="btnRefresh" class="btn-press"><i class="fas fa-sync-alt text-xl"></i></button>
                <button id="btnLogout" class="hidden btn-press"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </div>
        <div id="progressBar" class="hidden h-1 w-full bg-[#006400]">
            <div class="h-full bg-[#FFD700] animate-pulse w-full"></div>
        </div>
    </nav>

    <main id="appContent" class="flex-1 overflow-y-auto bg-app pb-10">
        
        <section id="loginScreen" class="flex flex-col items-center justify-center min-h-[70vh] p-6">
            <div class="card-container w-full max-w-sm">
                <div class="card-cut p-8 border-t-4 border-[#006400] bg-white/95">
                    <h2 class="text-xl font-black text-center text-[#006400] mb-8 uppercase tracking-widest">Acesso Membros</h2>
                    <input type="text" id="userInput" placeholder="Usu√°rio" class="w-full p-4 bg-gray-50 border rounded-none mb-4 outline-none focus:border-[#006400] transition-colors">
                    <input type="password" id="passInput" placeholder="Senha" class="w-full p-4 bg-gray-50 border rounded-none mb-8 outline-none focus:border-[#006400] transition-colors">
                    <button id="btnLoginAction" class="w-full bg-[#006400] text-white py-4 font-bold rounded-sm btn-press shadow-lg uppercase">Acessar</button>
                </div>
            </div>
        </section>

        <div id="matchesScreen" class="hidden p-4 space-y-6">
            </div>

    </main>

    <div id="modalOverlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in" onclick="closeModal()">
        <div class="w-full max-w-sm bg-white rounded-none shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            <div class="bg-white p-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 id="modalTitle" class="font-bold text-[#006400] uppercase text-sm">Quem j√° votou?</h3>
                    <p id="modalSubtitle" class="text-[10px] text-gray-400">Os palpites s√£o revelados ap√≥s o prazo.</p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="modalList" class="max-h-[60vh] overflow-y-auto bg-white p-2">
                <div class="text-center py-4"><i class="fas fa-spinner fa-spin text-[#006400]"></i></div>
            </div>
            <div class="p-3 bg-gray-50 text-right">
                <button onclick="closeModal()" class="text-[#006400] font-black text-xs px-4 py-2 uppercase">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // SUAS CREDENCIAIS [memory]
        const firebaseConfig = {
            apiKey: "AIzaSyAEkEE2X5hWIqopoJ0D9jFzCjJHKR8b82k",
            authDomain: "bolao112fc.firebaseapp.com",
            projectId: "bolao112fc",
            storageBucket: "bolao112fc.firebasestorage.app",
            messagingSenderId: "131329454158",
            appId: "1:131329454158:web:983e4544dd651ec942131f",
            measurementId: "G-5SGWJE6EKK"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- AUTH ---
        document.getElementById('btnLoginAction').onclick = async () => {
            const user = document.getElementById('userInput').value.trim().toLowerCase();
            const pass = document.getElementById('passInput').value;
            try { await signInWithEmailAndPassword(auth, `${user}@bolao112.com`, pass); } 
            catch (e) { alert("Dados incorretos."); }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('matchesScreen').classList.remove('hidden');
                document.getElementById('btnLogout').classList.remove('hidden');
                loadMatches();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('matchesScreen').classList.add('hidden');
                document.getElementById('btnLogout').classList.add('hidden');
            }
        });

        // --- COMPONENTE: Section Header ---
        const SectionHeader = (title, colorHex, bgClass = "bg-white/90") => `
            <div class="card-container mb-3">
                <div class="bg-white/90 border border-[${colorHex}] rounded-tl-2xl rounded-br-2xl p-2 text-center shadow-sm">
                    <h4 class="font-bold text-[${colorHex}] uppercase tracking-wider text-xs" style="color: ${colorHex};">${title}</h4>
                </div>
            </div>`;

        // --- CORE: Carregar Jogos ---
        async function loadMatches() {
            const container = document.getElementById('matchesScreen');
            const progress = document.getElementById('progressBar');
            
            progress.classList.remove('hidden'); // Show loading
            
            try {
                // 1. Buscas Paralelas (Jogos e Configura√ß√µes)
                const [matchesSnap, compsSnap] = await Promise.all([
                    getDocs(collection(db, "matches")),
                    getDocs(collection(db, "settings")) // Se precisar de logos, mas usaremos do match por enquanto
                ]);

                const now = new Date();
                let open = [], waiting = [], finished = [];

                // 2. Processamento e Filtragem
                for (const docSnapshot of matchesSnap.docs) {
                    const m = { id: docSnapshot.id, ...docSnapshot.data() };
                    const deadline = m.deadline.toDate();
                    
                    // Replicando a l√≥gica do Android (MatchCard)
                    m.isExpired = now > deadline;
                    m.isFinal = (m.round && m.round.toLowerCase() === 'final');
                    m.hasWinner = !!m.winner;

                    if (m.hasWinner) finished.push(m);
                    else if (m.isExpired) waiting.push(m);
                    else open.push(m);
                }

                // 3. Ordena√ß√£o (Igual ao Android)
                open.sort((a,b) => a.deadline.toDate() - b.deadline.toDate());
                waiting.sort((a,b) => b.deadline.toDate() - a.deadline.toDate()); // Descending
                finished.sort((a,b) => b.deadline.toDate() - a.deadline.toDate()); // Descending

                // 4. Renderiza√ß√£o
                let html = "";

                if (open.length > 0) {
                    html += SectionHeader("‚úÖ CONFRONTOS DISPON√çVEIS ‚úÖ", "#006400");
                    for (const m of open) html += await createMatchCardHTML(m);
                    html += `<div class="h-6"></div>`;
                }

                if (waiting.length > 0) {
                    html += SectionHeader("‚è≥ AGUARDANDO RESULTADO ‚è≥", "#FBC02D"); // Amarelo/Laranja
                    for (const m of waiting) html += await createMatchCardHTML(m);
                    html += `<div class="h-6"></div>`;
                }

                if (finished.length > 0) {
                    html += SectionHeader("üö´ CONFRONTOS FINALIZADOS üö´", "#D32F2F"); // Vermelho
                    for (const m of finished) html += await createMatchCardHTML(m);
                    html += `<div class="h-6"></div>`;
                }

                if (!html) html = `<div class="text-center text-gray-500 mt-10">Nenhum jogo encontrado.</div>`;
                
                container.innerHTML = html;

            } catch (e) {
                console.error(e);
            } finally {
                progress.classList.add('hidden'); // Hide loading
            }
        }

        // --- COMPONENTE: Match Card HTML ---
        async function createMatchCardHTML(m) {
            // Buscar voto do usu√°rio atual para este jogo
            // Nota: Em produ√ß√£o, buscar todos os votos de uma vez seria mais eficiente, 
            // mas aqui mantemos a paridade l√≥gica com o Android match-by-match.
            let userVote = "";
            try {
                const vSnap = await getDoc(doc(db, "guesses", `${m.id}_${currentUser.uid}`));
                if (vSnap.exists()) userVote = vSnap.data().teamSelected;
            } catch (e) {}

            const deadlineDate = m.deadline.toDate();
            // Formata√ß√£o de data
            const dateStr = deadlineDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric'});
            const timeStr = deadlineDate.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
            
            // Estilos condicionais (Igual ao Android)
            const isFinal = m.isFinal;
            const bgColor = isFinal ? 'bg-[#FFF9C4]' : 'bg-white'; // Amarelo claro se Final
            const borderColor = isFinal ? 'border-[#FFD700]' : (m.isExpired ? (m.hasWinner ? 'border-[#D32F2F]' : 'border-[#FBC02D]') : 'border-gray-200');
            const borderWidth = isFinal ? 'border-4' : 'border';
            
            // Texto do Prazo
            const prazoLabel = m.isExpired ? "Encerrado:" : "Prazo:";
            const prazoColor = m.isExpired ? "text-red-600" : "text-black";

            return `
                <div class="card-container mb-4">
                    <div class="card-cut p-4 relative ${bgColor} ${borderWidth} ${borderColor.startsWith('border-[#') ? '' : 'border-l-4'} " style="${isFinal ? 'border-color: #FFD700;' : (m.isExpired ? '' : 'border-left: 1px solid #e5e7eb;')}">
                        
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex flex-col">
                                ${isFinal ? '<span class="text-[10px] font-black text-orange-600 mb-1 tracking-widest">‚òÖ üèÜ FINAL ‚Ä¢ VALE O DOBRO üèÜ ‚òÖ</span>' : ''}
                                <span class="text-[10px] font-bold text-[#006400] uppercase font-serif">${m.competition}</span>
                                <span class="text-[12px] text-gray-500 font-serif">${m.round}</span>
                                <span class="text-[11px] font-bold ${prazoColor} mt-1 font-serif">
                                    ${prazoLabel} ${dateStr} ${timeStr}
                                </span>
                            </div>
                            
                            <button onclick="window.openVoters('${m.id}', '${m.teamA}', '${m.teamB}', ${m.isExpired}, '${m.winner||''}', '${m.teamAUrl}', '${m.teamBUrl}')" class="btn-press p-2 text-[#006400]">
                                <i class="fas ${m.isExpired ? 'fa-eye' : 'fa-users'} text-lg"></i>
                            </button>
                        </div>

                        ${m.hasWinner ? `
                            <div class="mb-3">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">${isFinal ? 'CAMPE√ÉO' : 'VENCEDOR'}</span>
                                <p class="text-xl font-black ${isFinal ? 'text-orange-600' : 'text-green-700'} font-serif leading-none">${m.winner}</p>
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between px-1">
                            ${createTeamButton(m.id, m.teamA, m.teamAUrl, userVote === m.teamA, m.isExpired)}
                            
                            <span class="italic font-black text-gray-300 text-xl font-serif">X</span>
                            
                            ${createTeamButton(m.id, m.teamB, m.teamBUrl, userVote === m.teamB, m.isExpired)}
                        </div>

                        ${userVote && !m.isExpired ? `<div class="mt-3 text-center"><span class="text-[11px] font-bold text-[#006400]">Voto: ${userVote}</span></div>` : ''}

                    </div>
                </div>
            `;
        }

        // --- Helper: Bot√£o de Time ---
        function createTeamButton(matchId, teamName, teamUrl, isSelected, isExpired) {
            const bgClass = isSelected ? 'bg-[#006400]' : 'bg-[#EEEEEE]';
            const textClass = isSelected ? 'text-white' : 'text-black';
            const borderClass = isSelected ? 'border-2 border-[#FFD700]' : ''; // Borda dourada se selecionado
            
            return `
                <button onclick="window.vote('${matchId}', '${teamName}')" 
                        ${isExpired ? 'disabled' : ''} 
                        class="btn-press flex flex-col items-center justify-center w-[40%] h-24 rounded-lg shadow-sm transition-all ${bgClass} ${borderClass} ${isExpired ? 'opacity-90 cursor-not-allowed' : ''}">
                    <img src="${teamUrl}" class="w-10 h-10 object-contain mb-1">
                    <span class="text-[11px] font-bold text-center leading-tight ${textClass} font-serif line-clamp-2 px-1">
                        ${teamName}
                    </span>
                </button>
            `;
        }

        // --- L√ìGICA: Votar ---
        window.vote = async (mId, team) => {
            if(!currentUser) return;
            // Otimistic UI update could go here, but for safety we reload
            try {
                await setDoc(doc(db, "guesses", `${mId}_${currentUser.uid}`), { 
                    matchId: mId, 
                    userId: currentUser.uid, 
                    teamSelected: team, 
                    timestamp: new Date() 
                });
                loadMatches(); // Recarrega para atualizar o estado visual
            } catch(e) { console.error(e); alert("Erro ao computar voto"); }
        };

        // --- L√ìGICA: Modal de Votantes ---
        window.openVoters = async (mId, tA, tB, isExpired, winner, urlA, urlB) => {
            const modal = document.getElementById('modalOverlay');
            const listDiv = document.getElementById('modalList');
            const title = document.getElementById('modalTitle');
            const subtitle = document.getElementById('modalSubtitle');

            modal.classList.remove('hidden');
            title.innerText = isExpired ? "PALPITES REGISTRADOS" : "QUEM J√Å VOTOU?";
            subtitle.innerText = isExpired ? "" : "Os palpites s√£o revelados ap√≥s o prazo.";
            listDiv.innerHTML = `<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-[#006400]"></i></div>`;

            // Buscar palpites
            const q = query(collection(db, "guesses"), where("matchId", "==", mId));
            const guessesSnap = await getDocs(q);
            
            if (guessesSnap.empty) {
                listDiv.innerHTML = `<p class="text-center text-gray-500 text-xs py-4">Nenhum voto registrado.</p>`;
                return;
            }

            // Buscar usu√°rios (Cache simples poderia ser usado aqui para otimizar)
            const usersSnap = await getDocs(collection(db, "users"));
            const usersMap = {};
            usersSnap.forEach(u => usersMap[u.id] = u.data());

            let html = "";
            let voters = [];

            guessesSnap.forEach(g => {
                const data = g.data();
                const user = usersMap[data.userId] || { name: "Desconhecido", photoBase64: "" };
                voters.push({ ...data, userName: user.name, userPhoto: user.photoBase64 });
            });

            // Ordena√ß√£o (Vencedores > Ordem Alfab√©tica)
            voters.sort((a,b) => {
                if (winner) {
                    const aWin = a.teamSelected === winner;
                    const bWin = b.teamSelected === winner;
                    if (aWin && !bWin) return -1;
                    if (!aWin && bWin) return 1;
                }
                return a.userName.localeCompare(b.userName);
            });

            voters.forEach(v => {
                let statusIcon = "";
                let rowBg = "bg-white";
                let displayVote = "";

                if (isExpired) {
                    // Mostrar voto real (Imagem ou Texto)
                    const isTeamA = v.teamSelected.trim().toLowerCase() === tA.trim().toLowerCase();
                    const isTeamB = v.teamSelected.trim().toLowerCase() === tB.trim().toLowerCase();
                    
                    if (isTeamA && urlA) displayVote = `<img src="${urlA}" class="w-6 h-6 object-contain">`;
                    else if (isTeamB && urlB) displayVote = `<img src="${urlB}" class="w-6 h-6 object-contain">`;
                    else displayVote = `<span class="text-[10px] font-bold">${v.teamSelected}</span>`;

                    // Status (Acerto/Erro)
                    if (winner) {
                        if (v.teamSelected === winner) {
                            rowBg = "bg-green-50";
                            statusIcon = `<i class="fas fa-check-circle text-green-700 ml-2"></i>`;
                        } else {
                            rowBg = "bg-red-50";
                            statusIcon = `<i class="fas fa-times-circle text-red-600 ml-2"></i>`;
                        }
                    }
                } else {
                    // Sigilo
                    displayVote = `<span class="text-[10px] text-gray-400 italic flex items-center"><i class="fas fa-lock mr-1"></i> Sigilo</span>`;
                }

                html += `
                    <div class="flex items-center justify-between p-2 mb-1 rounded border-b border-gray-100 ${rowBg}">
                        <div class="flex items-center gap-2 overflow-hidden">
                            ${v.userPhoto ? `<img src="data:image/jpeg;base64,${v.userPhoto}" class="w-8 h-8 rounded-full object-cover border border-gray-200">` : `<i class="fas fa-user-circle text-gray-300 text-2xl"></i>`}
                            <span class="text-xs font-bold text-gray-800 truncate max-w-[120px] font-serif">${v.userName}</span>
                        </div>
                        <div class="flex items-center">
                            ${displayVote}
                            ${statusIcon}
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        };

        window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');

        // Bot√µes Globais
        document.getElementById('btnRefresh').onclick = () => loadMatches();
        document.getElementById('btnLogout').onclick = () => signOut(auth);

    </script>
</body>
</html>
