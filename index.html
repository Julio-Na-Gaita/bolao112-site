<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bol√£o 112 F.C</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap');
        
        :root { --dark-green: #006400; --gold: #FFD700; }
        
        body { 
            font-family: 'PT Serif', serif; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            background-color: #f3f4f6;
        }

        .card-cut {
            background: white;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07));
            border: 1px solid #e5e7eb;
        }

        /* Fundos Din√¢micos */
        .bg-main { background-size: cover; background-attachment: fixed; background-position: center; transition: background 0.3s ease; }
        .tab-matches { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_jogos.png'); }
        .tab-ranking { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_ranking.png'); }
        .tab-rules { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_regras.png'); }
        .tab-profile { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_perfil.png'); }

        .btn-press:active { transform: scale(0.95); transition: 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        ::-webkit-scrollbar { display: none; }
        .rules-text { white-space: pre-wrap; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-[#006400] text-white pt-[env(safe-area-inset-top)] sticky top-0 z-50 shadow-md">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold tracking-tighter uppercase">Bol√£o 112 F.C</h1>
            <div class="flex gap-4">
                <button id="btnPot" class="btn-press text-[#FFD700]"><i class="fas fa-piggy-bank text-xl drop-shadow-md"></i></button>
                <button id="btnRefresh" class="btn-press"><i class="fas fa-sync-alt text-xl"></i></button>
                <button id="btnLogout" class="hidden btn-press"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </div>
        <div id="progressBar" class="hidden h-1 w-full bg-[#006400]"><div class="h-full bg-[#FFD700] animate-pulse w-full"></div></div>
    </nav>

    <main id="appContent" class="flex-1 overflow-y-auto bg-main tab-matches pb-32">
        
        <section id="loginScreen" class="flex flex-col items-center justify-center min-h-[70vh] p-6">
            <div class="card-cut w-full max-w-sm p-8 border-t-4 border-[#006400]">
                <h2 class="text-xl font-black text-center text-[#006400] mb-8 uppercase tracking-widest">Acesso Membros</h2>
                <input type="text" id="userInput" placeholder="Usu√°rio" class="w-full p-4 bg-gray-50 border rounded-lg mb-4 outline-none focus:ring-2 focus:ring-green-700">
                <input type="password" id="passInput" placeholder="Senha" class="w-full p-4 bg-gray-50 border rounded-lg mb-2 outline-none focus:ring-2 focus:ring-green-700">
                
                <div class="flex justify-end mb-6">
                    <button id="btnForgotPass" class="text-xs text-gray-500 font-bold hover:text-[#006400] transition-colors">Esqueci a senha</button>
                </div>

                <button id="btnLoginAction" class="w-full bg-[#006400] text-white py-4 font-bold rounded-lg btn-press shadow-lg mb-6">ACESSAR</button>
                
                <div class="border-t pt-6 text-center">
                    <p class="text-xs text-gray-400 mb-2 font-bold">Ainda n√£o tem cadastro?</p>
                    <button id="btnOpenRegister" class="text-[#006400] font-black text-sm uppercase btn-press border border-[#006400] px-6 py-2 rounded-full hover:bg-green-50">CRIAR CONTA</button>
                </div>
            </div>
        </section>

        <div id="mainScreens" class="hidden p-4 space-y-4">
            
            <div id="matchesScreen" class="hidden space-y-6"></div>

            <div id="rankingScreen" class="hidden">
                <div class="card-cut p-4 mb-4 border-t-2 border-[#FFD700]">
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <h3 class="font-bold text-lg text-gray-800">Classifica√ß√£o</h3>
                        <button onclick="loadRanking()" class="text-[#006400] btn-press"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <div class="grid grid-cols-[30px_1fr_30px_30px_30px_40px] text-[10px] font-bold text-gray-400 uppercase text-center items-center pb-2">
                        <span>Pos</span><span class="text-left pl-2">Nome</span><span class="text-red-500">D</span><span>V</span><span>F</span><span class="text-black">PTS</span>
                    </div>
                    <div id="rankingListContent" class="space-y-1"></div>
                </div>
                <div class="bg-black/80 text-[#FFD700] p-3 text-[10px] text-center rounded-lg shadow-lg border border-gray-800">
                    <p class="font-bold mb-1 tracking-wide">Legenda: D=D√©bitos(-1) | V=Vit√≥rias | F=Finais | PTS=Pontos</p>
                    <p id="lastUpdateRanking" class="text-white font-normal opacity-90 italic">Aguardando...</p>
                </div>
            </div>

            <div id="rulesScreen" class="hidden space-y-4">
                <div class="card-cut p-6 border-l-4 border-yellow-400 bg-[#FFF9C4] text-left shadow-sm">
                    <p class="text-xs text-gray-800 leading-relaxed rules-text">üéØ <b>Objetivo</b>
Competi√ß√£o de palpites esportivos entre amigos, baseada exclusivamente nos principais torneios de futebol em formato mata-mata, com sistema de pontua√ß√£o, classifica√ß√£o geral e premia√ß√£o anual.

üóìÔ∏è <b>VIG√äNCIA DO BOL√ÉO</b>
In√≠cio oficial: 01 de janeiro de 2026
T√©rmino oficial: 31 de dezembro de 2026

‚úÖ ‚úçÔ∏è A participa√ß√£o no bol√£o implica aceita√ß√£o integral e irrestrita deste regulamento.</p>
                </div>
                <div id="rulesList" class="space-y-2"></div>
                <div class="h-10"></div>
            </div>

            <div id="profileScreen" class="hidden">
                <div class="card-cut p-6 border-t-4 border-[#006400] text-center relative mb-4">
                    <h2 class="font-bold text-gray-400 text-xs mb-6 tracking-[0.2em]">CART√ÉO DE MEMBRO</h2>
                    <div class="relative w-28 h-28 mx-auto mb-4">
                        <div id="profileAvatar" class="w-full h-full bg-gray-200 rounded-full border-4 border-white shadow-lg overflow-hidden flex items-center justify-center">
                            <i class="fas fa-user text-4xl text-gray-400"></i>
                        </div>
                    </div>
                    <label class="inline-block bg-white border border-[#006400] text-[#006400] px-4 py-1 rounded-full text-xs font-bold shadow-sm mb-4 cursor-pointer btn-press">
                        <i class="fas fa-camera mr-1"></i> Alterar Foto
                        <input type="file" id="uploadPhoto" accept="image/*" class="hidden">
                    </label>

                    <h3 id="profileName" class="text-xl font-black text-gray-800 uppercase leading-tight mb-1">...</h3>
                    <p id="profileUser" class="text-gray-500 text-sm mb-6">@...</p>

                    <div class="flex justify-center gap-4 mb-2">
                        <button onclick="changePassword()" class="text-xs text-gray-600 font-bold btn-press"><i class="fas fa-lock mr-1"></i> Senha</button>
                        <button onclick="showChangelog()" class="text-xs text-gray-600 font-bold btn-press"><i class="fas fa-info-circle mr-1"></i> Ajuda</button>
                    </div>
                </div>

                <div id="financialCard" class="p-4 rounded-lg border mb-4 cursor-pointer btn-press transition-colors bg-white shadow-sm">
                    <div class="flex justify-between items-center">
                        <div class="text-left">
                            <p id="financialStatusText" class="font-black text-sm">VERIFICANDO...</p>
                            <p class="text-[10px] text-gray-500 font-bold">Toque para detalhes</p>
                        </div>
                        <i id="financialIcon" class="fas fa-circle-notch fa-spin text-2xl"></i>
                    </div>
                </div>

                <div id="pixArea" class="hidden bg-white p-4 rounded-lg border border-gray-200 text-left space-y-3 mb-4 shadow-sm">
                    <div class="text-center mb-2"><i class="fas fa-qrcode text-3xl text-[#006400]"></i><p class="font-bold text-[#006400]">PAGAMENTO PIX</p><p class="text-2xl font-black">R$ 10,00</p></div>
                    <div class="text-center text-[10px] text-gray-500 mb-2">Benefici√°rio:<br><b class="text-[#006400] text-xs">MATHEUS FERREIRA ALVES</b></div>
                    <div><label class="text-[10px] text-gray-500 font-bold">CHAVE PIX</label><div class="flex gap-2"><input type="text" id="pixKey" readonly class="w-full text-xs p-2 bg-white border rounded"><button id="btnCopyPix" class="bg-[#006400] text-white px-3 rounded"><i class="fas fa-copy"></i></button></div></div>
                    <button id="btnSendProof" class="w-full bg-green-500 text-white py-2 rounded font-bold text-xs shadow btn-press"><i class="fab fa-whatsapp"></i> ENVIAR COMPROVANTE</button>
                </div>

                <button id="btnAdminPanel" onclick="openAdminMenu()" class="hidden w-full bg-gray-800 text-white py-3 rounded font-bold text-xs shadow btn-press mb-10"><i class="fas fa-cogs mr-2"></i> PAINEL DO ADMIN</button>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in" onclick="closeModal()">
        <div id="modalContainer" class="w-full max-w-sm bg-white rounded-none shadow-2xl overflow-hidden" onclick="event.stopPropagation()"></div>
    </div>

    <div id="potModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-6" onclick="document.getElementById('potModal').classList.add('hidden')">
        <div class="card-cut w-full max-w-sm p-8 text-center relative border-t-4 border-[#FFD700]" style="background-image: linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.9)), url('https://cdn.pixabay.com/photo/2017/09/07/08/54/money-2724241_640.jpg'); background-size: cover; background-position: center;" onclick="event.stopPropagation()">
            <i class="fas fa-piggy-bank text-5xl text-[#FFD700] mb-4 drop-shadow-sm"></i>
            <h2 class="text-xl font-bold text-gray-800">POTE DE OURO</h2>
            <div class="my-6"><p id="potValue" class="text-4xl font-black text-[#006400]">R$ 0,00</p><p class="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Pr√™mio Acumulado</p></div>
            <button onclick="document.getElementById('potModal').classList.add('hidden')" class="w-full bg-[#006400] text-white py-3 font-bold rounded shadow-lg btn-press">SHOW!</button>
        </div>
    </div>

    <nav id="bottomNav" class="hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t safe-bottom flex justify-around p-2 z-50 shadow-2xl">
        <button onclick="showTab('matches')" class="nav-btn flex flex-col items-center text-[#006400]" id="nav-matches"><i class="fas fa-soccer-ball text-lg"></i><span class="text-[10px] mt-1">Jogos</span></button>
        <button onclick="showTab('ranking')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-ranking"><i class="fas fa-trophy text-lg"></i><span class="text-[10px] mt-1">Ranking</span></button>
        <button onclick="showTab('rules')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-rules"><i class="fas fa-gavel text-lg"></i><span class="text-[10px] mt-1">Regras</span></button>
        <button onclick="showTab('profile')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-profile"><i class="fas fa-user text-lg"></i><span class="text-[10px] mt-1">Perfil</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAEkEE2X5hWIqopoJ0D9jFzCjJHKR8b82k", authDomain: "bolao112fc.firebaseapp.com", projectId: "bolao112fc", storageBucket: "bolao112fc.firebasestorage.app", messagingSenderId: "131329454158", appId: "1:131329454158:web:983e4544dd651ec942131f", measurementId: "G-5SGWJE6EKK" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentRankingData = [];

        // --- REGRAS (DATA) ---
        const rulesData = [
            { t: "1Ô∏è‚É£ PARTICIPA√á√ÉO E FINANCEIRO", c: "üí∞ Aporte Mensal\nValor: R$ 10,00 por participante\nVencimento: todo dia 10 de cada m√™s\n\nüü¢ Entrada de novos participantes\nNovos participantes podem ingressar a qualquer momento da temporada\nN√£o haver√° pontua√ß√£o retroativa, sob nenhuma hip√≥tese\nA pontua√ß√£o passa a valer exclusivamente a partir da inclus√£o oficial do participante no bol√£o\n\n‚ùå Desist√™ncia\nN√£o haver√° reembolso de valores pagos, independentemente do motivo da desist√™ncia, afastamento ou exclus√£o\n\n‚ö†Ô∏è Pol√≠tica de Inadimpl√™ncia (Pontos e Votos)\n1. Penalidade de Pontos: Atraso de 1 dia (pagamento dia 11) gera -1 ponto. A cada 5 dias subsequentes (16, 21, 26...), -1 ponto adicional cumulativo.\n2. Penalidade Pol√≠tica (Vota√ß√µes): Participantes que estiverem INADIMPLENTES no momento de qualquer vota√ß√£o perdem imediatamente o direito de voto.\n   - O voto √© direito exclusivo de quem est√° com o financeiro em dia na data da vota√ß√£o.\n\nüìå A drenagem de pontos somente √© interrompida mediante envio do comprovante\n\nüìå O hist√≥rico de inadimpl√™ncia permanece registrado para fins de desempate" },
            { t: "2Ô∏è‚É£ PREMIA√á√ÉO FINAL (CLASSIFICA√á√ÉO GERAL)", c: "O valor total arrecadado ao longo da temporada formar√° o Pote Anual.\nDistribui√ß√£o:\nü•á 1¬∫ Lugar: 60%\nü•à 2¬∫ Lugar: 30%\nü•â 3¬∫ Lugar: 10%" },
            { t: "3Ô∏è‚É£ SISTEMA DE PONTUA√á√ÉO", c: "‚úÖ Acerto do vencedor/classificado: 3 pontos\n\nüî• Finais (Peso 2)\nFinais de qualquer competi√ß√£o v√°lida possuem pontua√ß√£o dobrada\nCada acerto em final: 6 pontos\n\nüí• Rodada Perfeita ‚Äì Oitavas de Final\nA rodada perfeita ser√° considerada exclusivamente nas oitavas de final, em todas as competi√ß√µes v√°lidas\nO participante que acertar 100% dos confrontos das oitavas receber√°:\n+3 pontos extras, al√©m da pontua√ß√£o regular\n\nüìå N√£o existe rodada perfeita em quartas, semifinais ou finais." },
            { t: "4Ô∏è‚É£ COMPETI√á√ïES E OBRIGATORIEDADE DE FASES", c: "As competi√ß√µes abaixo comp√µem a base do bol√£o. A inclus√£o dos jogos segue a seguinte regra hier√°rquica:\n\nA) Competi√ß√µes V√°lidas:\nüåç Copa do Mundo\nüèÜ UEFA Champions League\nüèÜ UEFA Europa League\nüáßüá∑ Copa do Brasil\nüåé Copa Libertadores\nüåé Copa Sul-Americana\nüáßüá∑ Supercopa do Brasil\nüá™üá∫ Supercopa da UEFA\nüåé CONMEBOL Recopa\nüåç FIFA Intercontinental Cup\n\nB) Fases de Mata-Mata Regular (Obrigat√≥rias)\nTodas as fases eliminat√≥rias da chave principal das competi√ß√µes listadas s√£o de inclus√£o OBRIGAT√ìRIA e AUTOM√ÅTICA.\n- Isso inclui fases iniciais extensas, como 64-avos e 32-avos da Copa do Brasil.\n\nüìå FASES PRELIMINARES (PLAY-OFFS) E DEMAIS JOGOS\n\nJogos de fases preliminares (ex: \"Pr√©-Libertadores\", Play-offs da Sul-Americana, Repescagens), fases de grupos, ligas corridas ou pontos corridos n√£o pontuam." },
            { t: "5Ô∏è‚É£ CRIT√âRIOS DE DESEMPATE", c: "(Aplicados somente se houver empate no n√∫mero total de pontos)\n1- Menor n√∫mero de inadimpl√™ncias (D)\n2- Maior n√∫mero total de acertos (V)\n3- Maior n√∫mero de acertos em finais (F)\n4- Sorteio\n\nüìå Nenhum crit√©rio de desempate ser√° aplicado se n√£o houver empate em pontos." },
            { t: "6Ô∏è‚É£ PALPITES E PLATAFORMAS OFICIAIS", c: "Os palpites ser√£o realizados exclusivamente nas plataformas oficiais do bol√£o:\nüì± Aplicativo (Android)\nüåê Site (compat√≠vel com iOS e computador)\n\nüìå Palpites feitos fora dessas plataformas n√£o ser√£o considerados, mesmo que publicados no grupo." },
            { t: "7Ô∏è‚É£ CLASSIFICA√á√ÉO E TRANSPAR√äNCIA", c: "A classifica√ß√£o geral oficial ser√° mantida e atualizada exclusivamente:\nüì± No aplicativo Android\nüåê No site (iOS e PC)\nO link de acesso ser√° disponibilizado no grupo oficial do WhatsApp\nO app/site ser√° a √∫nica fonte oficial, contendo:\nPontua√ß√£o total\nInadimpl√™ncias (D)\nTotal de acertos (V)\nAcertos em finais (F)\n\nüìå Para garantir a total lisura da competi√ß√£o, o sistema possui travas t√©cnicas de seguran√ßa:\n\nüîí Bloqueio de Edi√ß√£o\nAp√≥s o hor√°rio limite estipulado para um jogo, o sistema bloqueia automaticamente a edi√ß√£o da data/hora. √â tecnicamente imposs√≠vel para a organiza√ß√£o alterar o prazo de um jogo vencido para reabrir a vota√ß√£o." },
            { t: "8Ô∏è‚É£ CONDUTAS, INTERPRETA√á√ïES E ALTERA√á√ïES", c: "üß≠ Interpreta√ß√£o das regras\nEm caso de d√∫vida ou diverg√™ncia na interpreta√ß√£o de uma regra j√° existente, ser√° adotada a decis√£o da maioria simples dos participantes.\n\nüìå Essa regra vale exclusivamente para interpreta√ß√£o de regras j√° previstas neste regulamento.\n\nüö´ Cria√ß√£o ou altera√ß√£o de regras\n\nCria√ß√£o, exclus√£o ou altera√ß√£o de regras exige 100% de concord√¢ncia dos participantes, conforme j√° estabelecido.\n\nüìåA regra de maioria simples n√£o se aplica nesses casos." },
            { t: "9Ô∏è‚É£ SISTEMA DE NOTIFICA√á√ïES (B√îNUS)", c: "O servi√ßo de notifica√ß√µes push (exclusivo para Android) informando sobre novos jogos, edi√ß√µes ou lembretes de prazo (1h antes) √© uma funcionalidade b√¥nus de cortesia.\n\n‚ö†Ô∏è Importante:\nFalhas no envio ou n√£o recebimento da notifica√ß√£o (por falta de internet, configura√ß√£o do celular ou erro de sistema) N√ÉO justificam o esquecimento do voto.\n√â de inteira e exclusiva responsabilidade do participante acessar regularmente as plataformas e verificar os jogos dispon√≠veis." },
            { t: "üîü VALIDA√á√ÉO DO VOTO E FALHAS T√âCNICAS", c: "Para garantir a integridade da competi√ß√£o e evitar contesta√ß√µes tardias:\n\n‚úÖ A √∫nica comprova√ß√£o v√°lida de um voto √© o seu registro visual no sistema (Bot√£o destacado em VERDE ou mensagem \"Voto confirmado\").\n\nüö´ N√£o ser√£o aceitas reclama√ß√µes posteriores ao encerramento da vota√ß√£o sob alega√ß√µes de falha t√©cnica individual (ex: \"Votei mas o app n√£o salvou\", \"Minha internet caiu\").\n\nüìå Princ√≠pio da Integridade Sist√™mica:\nConsiderando que a plataforma (App/Site) √© √∫nica e distribu√≠da uniformemente a todos, presume-se que, se o sistema permitiu a vota√ß√£o para a coletividade, eventuais falhas isoladas de registro s√£o decorrentes de fatores locais do pr√≥prio usu√°rio (instabilidade de conex√£o, falhas no dispositivo ou erro de manuseio), e n√£o de instabilidade da plataforma.\n\nüí° Recomenda√ß√£o de Seguran√ßa: Ap√≥s votar, atualize a p√°gina ou feche e abra o app novamente para certificar-se de que seu palpite persiste gravado. Se n√£o estiver verde, o voto n√£o foi computado." }
        ];

        document.getElementById('btnLoginAction').onclick = async () => {
            const user = document.getElementById('userInput').value.trim().toLowerCase();
            const pass = document.getElementById('passInput').value;
            try { await signInWithEmailAndPassword(auth, `${user}@bolao112.com`, pass); } 
            catch (e) { alert("Dados incorretos."); }
        };

        document.getElementById('btnForgotPass').onclick = () => {
            alert("Utilizamos um sistema de login simplificado.\n\nPor favor, entre em contato com o Admin (J√∫lio) para resetar sua senha.");
        };

        document.getElementById('btnOpenRegister').onclick = () => {
            const modal = document.getElementById('modalOverlay');
            const cont = document.getElementById('modalContainer');
            modal.classList.remove('hidden');
            cont.innerHTML = `
                <div class="bg-white p-6 relative">
                    <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-400 p-2"><i class="fas fa-times text-xl"></i></button>
                    <h3 class="text-[#006400] font-black uppercase text-center mb-6 text-lg">Criar Nova Conta</h3>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Nome Completo</label>
                    <input type="text" id="regName" placeholder="Ex: Jo√£o da Silva" class="w-full p-3 bg-gray-50 border rounded-lg mb-3 text-sm outline-none focus:border-[#006400]">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Usu√°rio (Login)</label>
                    <input type="text" id="regUser" placeholder="Ex: joaosilva (sem espa√ßos)" class="w-full p-3 bg-gray-50 border rounded-lg mb-3 text-sm outline-none focus:border-[#006400]">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Senha</label>
                    <input type="password" id="regPass" placeholder="M√≠nimo 6 caracteres" class="w-full p-3 bg-gray-50 border rounded-lg mb-6 text-sm outline-none focus:border-[#006400]">
                    <button id="btnDoRegister" class="w-full bg-[#006400] text-white py-3 font-bold rounded-lg shadow-lg btn-press">CADASTRAR</button>
                </div>
            `;

            document.getElementById('btnDoRegister').onclick = async () => {
                const name = document.getElementById('regName').value.trim();
                const user = document.getElementById('regUser').value.trim().toLowerCase();
                const pass = document.getElementById('regPass').value;
                if(!name || !user || pass.length < 6) { alert("Preencha todos os campos corretamente. Senha deve ter no m√≠nimo 6 d√≠gitos."); return; }
                if(user.includes(" ")) { alert("O nome de usu√°rio n√£o pode conter espa√ßos."); return; }
                try {
                    const email = `${user}@bolao112.com`;
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), { name: name, username: user, createdAt: new Date(), isAdmin: false, debts: 0, payments: {} });
                    alert("Conta criada com sucesso! Voc√™ j√° est√° logado.");
                    closeModal();
                } catch(e) { console.error(e); if(e.code === 'auth/email-already-in-use') alert("Este usu√°rio j√° existe."); else alert("Erro ao criar conta: " + e.message); }
            };
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreens').classList.remove('hidden');
                document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('btnLogout').classList.remove('hidden');
                showTab('matches');
                calculatePot();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainScreens').classList.add('hidden');
                document.getElementById('bottomNav').classList.add('hidden');
            }
        });

        window.showTab = (tab) => {
            const content = document.getElementById('appContent');
            content.className = `flex-1 overflow-y-auto bg-main pb-32 tab-${tab}`;
            ['matches', 'ranking', 'rules', 'profile'].forEach(t => {
                document.getElementById(`${t}Screen`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.replace('text-[#006400]', 'text-gray-400');
            });
            document.getElementById(`${tab}Screen`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.replace('text-gray-400', 'text-[#006400]');
            if(tab === 'matches') loadMatches();
            if(tab === 'ranking') loadRanking();
            if(tab === 'rules') renderRules();
            if(tab === 'profile') loadProfile();
        };

        // --- JOGOS (ATUALIZADO: COLLAPSIBLE PARA FINALIZADOS E AGUARDANDO) ---
        const SectionHeader = (title, color) => `<div class="card-container mb-3"><div class="bg-white/90 border border-[${color}] rounded-tl-2xl rounded-br-2xl p-2 text-center shadow-sm"><h4 class="font-bold text-[${color}] uppercase tracking-wider text-xs" style="color: ${color};">${title}</h4></div></div>`;
        
        async function loadMatches() {
            const container = document.getElementById('matchesScreen');
            document.getElementById('progressBar').classList.remove('hidden');
            try {
                const snap = await getDocs(collection(db, "matches"));
                const now = new Date();
                let open = [], waiting = [], finished = [];
                for (const d of snap.docs) {
                    const m = {id:d.id, ...d.data()};
                    const dl = m.deadline.toDate();
                    m.expired = now > dl;
                    m.final = m.round?.toLowerCase() === 'final';
                    if (m.winner) finished.push(m); else if (m.expired) waiting.push(m); else open.push(m);
                }
                open.sort((a,b)=>a.deadline.toDate()-b.deadline.toDate());
                waiting.sort((a,b)=>b.deadline.toDate()-a.deadline.toDate());
                finished.sort((a,b)=>b.deadline.toDate()-a.deadline.toDate());
                let html = "";
                
                // 1. JOGOS ABERTOS (Sempre Vis√≠veis)
                if(open.length) html += SectionHeader("‚úÖ CONFRONTOS DISPON√çVEIS ‚úÖ", "#006400") + await renderMatchList(open);
                
                // 2. AGUARDANDO RESULTADO (Colaps√°vel)
                if(waiting.length) {
                    html += `
                    <div onclick="window.toggleWaiting()" class="card-container mb-3 cursor-pointer btn-press">
                        <div class="bg-white/90 border border-[#FBC02D] rounded-tl-2xl rounded-br-2xl p-2 text-center shadow-sm">
                             <h4 class="font-bold text-[#FBC02D] uppercase tracking-wider text-xs">‚è≥ AGUARDANDO RESULTADO ‚è≥</h4>
                        </div>
                    </div>
                    <div id="waitingContainer" class="hidden">
                        ${await renderMatchList(waiting)}
                    </div>
                    `;
                }
                
                // 3. JOGOS FINALIZADOS (Colaps√°vel)
                if(finished.length) {
                    html += `
                    <div onclick="window.toggleFinished()" class="card-container mb-3 cursor-pointer btn-press">
                        <div class="bg-white/90 border border-[#D32F2F] rounded-tl-2xl rounded-br-2xl p-2 text-center shadow-sm">
                             <h4 class="font-bold text-[#D32F2F] uppercase tracking-wider text-xs">üö´ CONFRONTOS FINALIZADOS üö´</h4>
                        </div>
                    </div>
                    <div id="finishedContainer" class="hidden">
                        ${await renderMatchList(finished)}
                    </div>
                    `;
                }

                container.innerHTML = html || `<div class="text-center text-gray-500 mt-10">Nenhum jogo encontrado.</div>`;
            } catch(e) { console.error(e); }
            document.getElementById('progressBar').classList.add('hidden');
        }

        window.toggleWaiting = () => {
            const el = document.getElementById('waitingContainer');
            el.classList.toggle('hidden');
        };

        window.toggleFinished = () => {
            const el = document.getElementById('finishedContainer');
            el.classList.toggle('hidden');
        };

        async function renderMatchList(list) {
            let html = "";
            for (const m of list) {
                let userVote = "";
                try { const vs = await getDoc(doc(db, "guesses", `${m.id}_${currentUser.uid}`)); if(vs.exists()) userVote = vs.data().teamSelected; } catch(e){}
                const dl = m.deadline.toDate();
                const borderColor = m.final ? 'border-[#FFD700]' : (m.expired ? (m.winner ? 'border-[#D32F2F]' : 'border-[#FBC02D]') : 'border-[#006400]');
                const bgColor = m.final ? 'bg-[#FFF9C4]' : 'bg-white';
                html += `
                <div class="card-cut p-4 relative border-l-[6px] ${bgColor} mb-6" style="border-left-color: ${borderColor.replace('border-[','').replace(']','')};">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex flex-col">
                            ${m.final ? '<span class="text-[10px] font-black text-orange-600 mb-1">‚òÖ FINAL ‚Ä¢ VALE DOBRO ‚òÖ</span>' : ''}
                            <span class="text-[10px] font-bold text-[#006400] uppercase">${m.competition}</span>
                            <span class="text-[11px] text-gray-400">${m.round}</span>
                            <span class="text-[10px] font-bold ${m.expired ? 'text-red-600' : 'text-black'} mt-1">
                                ${m.expired ? 'Encerrado:' : 'Prazo:'} ${dl.toLocaleTimeString([], {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}
                            </span>
                        </div>
                        <button onclick="openVoters('${m.id}', '${m.teamA}', '${m.teamB}', ${m.expired}, '${m.winner||''}')" class="text-[#006400] p-2"><i class="fas ${m.expired ? 'fa-eye' : 'fa-users'} text-lg"></i></button>
                    </div>
                    <div class="flex items-center justify-between px-1">
                        ${createTeamBtn(m.id, m.teamA, m.teamAUrl, userVote===m.teamA, m.expired)}
                        <span class="font-black text-gray-300 text-xl">X</span>
                        ${createTeamBtn(m.id, m.teamB, m.teamBUrl, userVote===m.teamB, m.expired)}
                    </div>
                    ${m.winner ? `<div class="mt-3 text-center border-t pt-2"><span class="text-[10px] font-bold text-gray-400">VENCEDOR</span><p class="text-[#006400] font-black text-lg">${m.winner}</p></div>` : ''}
                </div>`;
            }
            return html;
        }
        function createTeamBtn(mid, name, url, selected, expired) {
            const bg = selected ? 'bg-[#006400] text-white' : 'bg-[#EEEEEE] text-gray-800';
            const border = selected ? 'border-2 border-[#FFD700]' : '';
            return `<button onclick="window.vote('${mid}', '${name}')" ${expired?'disabled':''} class="btn-press flex flex-col items-center justify-center w-[40%] h-24 rounded-lg transition-all ${bg} ${border} ${expired?'opacity-80':''}"><img src="${url}" class="w-10 h-10 object-contain mb-1"><span class="text-[11px] font-bold text-center leading-tight px-1 line-clamp-2">${name}</span></button>`;
        }
        window.vote = async (mid, team) => { if(!currentUser) return; await setDoc(doc(db, "guesses", `${mid}_${currentUser.uid}`), { matchId: mid, userId: currentUser.uid, teamSelected: team, timestamp: new Date() }); loadMatches(); };
        window.openVoters = async (mid, ta, tb, exp, win) => {
            const modal = document.getElementById('modalOverlay');
            const cont = document.getElementById('modalContainer');
            modal.classList.remove('hidden');
            cont.innerHTML = `<div class="bg-white p-4 text-center"><i class="fas fa-spinner fa-spin text-[#006400]"></i></div>`;
            const gSnap = await getDocs(query(collection(db, "guesses"), where("matchId", "==", mid)));
            const uSnap = await getDocs(collection(db, "users"));
            const uMap = {}; uSnap.forEach(u => uMap[u.id] = u.data());
            let rows = ""; const guesses = []; gSnap.forEach(g => guesses.push(g.data()));
            guesses.sort((a,b) => { const uA = uMap[a.userId]?.name || ""; const uB = uMap[b.userId]?.name || ""; if(win) { const wa = a.teamSelected===win, wb = b.teamSelected===win; if(wa && !wb) return -1; if(!wa && wb) return 1; } return uA.localeCompare(uB); });
            guesses.forEach(d => {
                const u = uMap[d.userId] || {name: "Desc.", photoBase64: ""};
                let voteDisplay = `<span class="text-[10px] text-gray-400 italic"><i class="fas fa-lock"></i> Sigilo</span>`;
                let bg = "bg-white";
                if (exp) { voteDisplay = `<span class="text-[11px] font-bold">${d.teamSelected}</span>`; if(win) { if(d.teamSelected === win) { bg = "bg-green-50"; voteDisplay += ` <i class="fas fa-check-circle text-green-600"></i>`; } else { bg = "bg-red-50"; voteDisplay += ` <i class="fas fa-times-circle text-red-600"></i>`; } } }
                rows += `<div class="flex justify-between items-center p-2 border-b border-gray-100 ${bg}"><div class="flex items-center gap-2">${u.photoBase64 ? `<img src="data:image/jpeg;base64,${u.photoBase64}" class="w-6 h-6 rounded-full object-cover">` : `<i class="fas fa-user-circle text-gray-300"></i>`}<span class="text-xs font-bold truncate w-24">${u.name}</span></div><div>${voteDisplay}</div></div>`;
            });
            cont.innerHTML = `<div class="bg-gray-50 p-3 border-b flex justify-between items-center"><h3 class="font-bold text-[#006400] uppercase text-xs">${exp ? 'Palpites' : 'Quem j√° votou?'}</h3><button onclick="closeModal()"><i class="fas fa-times text-gray-400"></i></button></div><div class="bg-white max-h-[60vh] overflow-y-auto p-2">${rows || '<p class="text-xs text-center p-4">Sem votos.</p>'}</div><div class="bg-gray-50 p-3 text-center"><button onclick="closeModal()" class="text-[#006400] font-black text-xs">FECHAR</button></div>`;
        };

        // --- RANKING (PRESERVADO) ---
        async function loadRanking() {
            const list = document.getElementById('rankingListContent');
            const footer = document.getElementById('lastUpdateRanking');
            list.innerHTML = `<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-[#006400]"></i></div>`;
            const [uSnap, gSnap, mSnap] = await Promise.all([getDocs(collection(db, "users")), getDocs(collection(db, "guesses")), getDocs(collection(db, "matches"))]);
            const matches = []; mSnap.forEach(d => matches.push({id:d.id, ...d.data()}));
            const finished = matches.filter(m => m.winner);
            if (finished.length > 0) {
                finished.sort((a,b) => b.deadline.toDate() - a.deadline.toDate());
                const last = finished[0]; const d = last.deadline.toDate();
                const dStr = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                footer.innerText = `√öltima atualiza√ß√£o: ${last.teamA} x ${last.teamB} em ${dStr}`;
            } else footer.innerText = "Nenhum confronto finalizado.";
            let users = []; const now = new Date();
            uSnap.forEach(ud => {
                const u = ud.data(); let p=0, v=0, f=0; const hist = []; const userGuesses = [];
                gSnap.forEach(gd => { if(gd.data().userId === ud.id) userGuesses.push(gd.data()) });
                userGuesses.forEach(g => {
                    const m = finished.find(x => x.id === g.matchId);
                    if(m) {
                        const dl = m.deadline.toDate(); const dStr = `üìÖ ${String(dl.getDate()).padStart(2,'0')}/${String(dl.getMonth()+1).padStart(2,'0')}`;
                        if(m.winner === g.teamSelected) { const isF = m.round?.toLowerCase() === 'final'; p += isF ? 6 : 3; v++; if(isF) f++; hist.push({ts: dl, text: `${dStr} - ‚úÖ Acerto: ${m.teamA} x ${m.teamB} (+${isF?6:3})`}); } 
                        else { hist.push({ts: dl, text: `${dStr} - üëé Errou: ${m.teamA} x ${m.teamB} (Voto: ${g.teamSelected})`, type:'bad'}); }
                    }
                });
                matches.forEach(m => { const dl = m.deadline.toDate(); if(now > dl && !userGuesses.some(g => g.matchId === m.id)) { const dStr = `üìÖ ${String(dl.getDate()).padStart(2,'0')}/${String(dl.getMonth()+1).padStart(2,'0')}`; hist.push({ts: dl, text: `${dStr} - ‚ùå N√£o votou: ${m.teamA} x ${m.teamB}`, type:'bad'}); } });
                const deb = u.debts || 0; p -= deb; if(deb > 0) hist.push({ts: now, text: `üîª Penalidade: -${deb} pts`, type:'bad'});
                hist.sort((a,b) => b.ts - a.ts);
                users.push({name: u.name||"Sem Nome", p, v, f, d: deb, photo: u.photoBase64, hist, lastRank: u.lastRank||0});
            });
            users.sort((a,b) => b.p - a.p || a.d - b.d || b.v - a.v || b.f - a.f);
            currentRankingData = users;
            list.innerHTML = users.map((u, i) => {
                const pos = i+1; const bg = pos===1?'bg-yellow-50':(pos<=3?'bg-gray-50':'bg-white');
                let diffHtml = '<div class="text-gray-400 text-[8px]"><i class="fas fa-minus"></i></div>';
                if(u.lastRank > 0) { if(pos < u.lastRank) diffHtml = `<div class="text-green-600 text-[9px] font-bold"><i class="fas fa-caret-up"></i> ${u.lastRank-pos}</div>`; else if(pos > u.lastRank) diffHtml = `<div class="text-red-600 text-[9px] font-bold"><i class="fas fa-caret-down"></i> ${pos-u.lastRank}</div>`; }
                return `<div class="${bg} rounded p-2 flex items-center border border-gray-100 text-xs mb-1"><div class="w-[30px] font-bold text-center flex flex-col items-center"><span>${pos}¬∫</span>${diffHtml}</div><div class="flex-1 flex items-center gap-2 overflow-hidden pl-2 btn-press" onclick="showModalPhoto(${i})">${u.photo ? `<img src="data:image/jpeg;base64,${u.photo}" class="w-6 h-6 rounded-full border object-cover">` : `<i class="fas fa-user-circle text-gray-300 text-lg"></i>`}<span class="font-bold truncate">${u.name}</span></div><div class="w-[30px] text-center text-red-500 font-bold btn-press" onclick="showModalHistory(${i})">${u.d}</div><div class="w-[30px] text-center text-gray-500 btn-press" onclick="showModalHistory(${i})">${u.v}</div><div class="w-[30px] text-center text-gray-500 btn-press" onclick="showModalHistory(${i})">${u.f}</div><div class="w-[40px] text-center font-black text-[#006400] text-sm btn-press" onclick="showModalHistory(${i})">${u.p}</div></div>`;
            }).join('');
        }
        window.showModalPhoto = (idx) => { const u = currentRankingData[idx]; if(!u.photo) return; document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalContainer').innerHTML = `<div class="bg-white p-4 text-center"><img src="data:image/jpeg;base64,${u.photo}" class="w-full rounded mb-4 shadow-lg"><h3 class="font-bold uppercase text-[#006400]">${u.name}</h3><button onclick="closeModal()" class="mt-4 text-gray-500 font-bold text-xs border border-gray-300 px-4 py-2 rounded">FECHAR</button></div>`; };
        window.showModalHistory = (idx) => { const u = currentRankingData[idx]; const html = u.hist.length ? u.hist.map(h => `<div class="border-b py-2 text-xs ${h.type==='bad'?'text-red-500':'text-black'}">${h.text}</div>`).join('') : "Sem hist√≥rico."; document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalContainer').innerHTML = `<div class="bg-gray-50 p-3 border-b"><h3 class="font-bold text-[#006400] uppercase text-xs">Extrato: ${u.name}</h3></div><div class="bg-white p-4 max-h-[50vh] overflow-y-auto">${html}</div><div class="bg-gray-50 p-3 text-center"><button onclick="closeModal()" class="text-[#006400] font-black text-xs">FECHAR</button></div>`; };

        function renderRules() { 
            const list = document.getElementById('rulesList');
            if(list.innerHTML !== "") return;
            list.innerHTML = rulesData.map(r => `
                <div class="bg-white rounded p-3 shadow-sm border border-gray-100">
                    <button class="w-full text-left font-bold text-xs text-[#006400] flex justify-between" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        ${r.t} <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="hidden mt-2 text-xs text-gray-600 border-t pt-2 whitespace-pre-line">${r.c}</div>
                </div>`).join(''); 
        }

        // --- ADMIN PANEL (CORRIGIDO: MENU E SEGURAN√áA) ---
        window.openAdminMenu = () => {
            const modal = document.getElementById('modalOverlay');
            const cont = document.getElementById('modalContainer');
            modal.classList.remove('hidden');
            cont.innerHTML = `
                <div class="bg-white rounded shadow-lg overflow-hidden">
                    <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                        <h3 class="font-bold uppercase text-sm">Painel Admin</h3>
                        <button onclick="closeModal()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 space-y-3">
                        <button onclick="openFinancialScreen()" class="w-full bg-[#2E7D32] text-white py-3 rounded font-bold text-xs shadow btn-press flex items-center justify-center gap-2"><i class="fas fa-wallet"></i> FINANCEIRO & USU√ÅRIOS</button>
                        <button onclick="alert('Funcionalidade dispon√≠vel apenas no App Android.')" class="w-full bg-[#1565C0] text-white py-3 rounded font-bold text-xs shadow btn-press flex items-center justify-center gap-2"><i class="fas fa-plus-circle"></i> NOVO CONFRONTO</button>
                        <button onclick="alert('Funcionalidade dispon√≠vel apenas no App Android.')" class="w-full bg-[#EF6C00] text-white py-3 rounded font-bold text-xs shadow btn-press flex items-center justify-center gap-2"><i class="fas fa-trophy"></i> COMPETI√á√ïES</button>
                        <hr class="border-gray-200 my-2">
                        <h4 class="font-bold text-[#006400] text-xs uppercase mb-2">Gerenciar Confrontos</h4>
                        <div id="adminMatchList" class="max-h-[30vh] overflow-y-auto text-xs text-gray-500">
                            Carregando lista...
                        </div>
                    </div>
                </div>`;
            loadAdminMatches();
        };

        async function loadAdminMatches() {
            const snap = await getDocs(collection(db, "matches"));
            const listDiv = document.getElementById('adminMatchList');
            if(!listDiv) return;
            let html = "";
            snap.forEach(d => {
                const m = d.data();
                html += `<div class="flex justify-between items-center p-2 border-b border-gray-100">
                    <span class="truncate w-2/3 font-bold">${m.teamA} x ${m.teamB}</span>
                    <div class="flex gap-2">
                        <button class="text-blue-500" onclick="alert('Edi√ß√£o apenas no App')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500" onclick="alert('Exclus√£o apenas no App')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
            listDiv.innerHTML = html || "Sem jogos.";
        }

        window.openFinancialScreen = async () => {
            const cont = document.getElementById('modalContainer');
            cont.innerHTML = `<div class="bg-white p-6 text-center"><i class="fas fa-spinner fa-spin text-2xl text-[#006400]"></i></div>`;
            
            const usersSnap = await getDocs(collection(db, "users"));
            const users = [];
            usersSnap.forEach(d => users.push({id: d.id, ...d.data()}));
            users.sort((a,b) => (a.name||"").localeCompare(b.name||""));

            let html = `
                <div class="bg-white rounded shadow-lg overflow-hidden h-[80vh] flex flex-col">
                    <div class="bg-[#2E7D32] text-white p-3 flex justify-between items-center shrink-0">
                        <button onclick="openAdminMenu()"><i class="fas fa-arrow-left"></i></button>
                        <h3 class="font-bold uppercase text-xs">Gest√£o Financeira</h3>
                        <div class="w-4"></div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">`;
            
            users.forEach(u => {
                html += `
                <div class="bg-white border rounded p-2 mb-2 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-xs text-gray-800">${u.name}</span>
                        <div class="flex items-center gap-2">
                            <button onclick="changeDebt('${u.id}', -1)" class="text-gray-400 bg-gray-100 p-1 rounded"><i class="fas fa-minus-circle"></i></button>
                            <span class="text-red-600 font-black text-xs min-w-[30px] text-center">${u.debts||0}</span>
                            <button onclick="changeDebt('${u.id}', 1)" class="text-red-500 bg-red-50 p-1 rounded"><i class="fas fa-plus-circle"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-1">`;
                    
                const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                months.forEach(m => {
                    const isPaid = u.payments && u.payments[m];
                    const bg = isPaid ? "bg-green-600 text-white border-green-600 shadow-md" : "bg-gray-100 text-gray-400 border-gray-200";
                    html += `<div onclick="togglePay('${u.id}', '${m}', ${!isPaid})" class="${bg} border text-[8px] font-bold py-1 rounded text-center cursor-pointer transition-colors">${m}</div>`;
                });
                html += `</div></div>`;
            });
            html += `</div></div>`;
            cont.innerHTML = html;
        };

        window.togglePay = async (uid, month, status) => {
            const ref = doc(db, "users", uid);
            const u = await getDoc(ref);
            const payments = u.data().payments || {};
            payments[month] = status;
            await updateDoc(ref, { payments: payments });
            calculatePot(); // Atualiza o Pote instantaneamente
            openFinancialScreen(); // Recarrega a lista sem fechar o modal
        };

        window.changeDebt = async (uid, delta) => {
            const ref = doc(db, "users", uid);
            const u = await getDoc(ref);
            let debts = u.data().debts || 0;
            debts += delta;
            if(debts < 0) debts = 0;
            await updateDoc(ref, { debts: debts });
            openFinancialScreen();
        };

        // --- PERFIL (SEGURAN√áA ATIVADA) ---
        async function loadProfile() { 
            const docRef = doc(db, "users", currentUser.uid); const snap = await getDoc(docRef); if(!snap.exists()) return; const u = snap.data(); document.getElementById('profileName').innerText = u.name || "MEMBRO"; document.getElementById('profileUser').innerText = `@${u.username}`; if(u.photoBase64) document.getElementById('profileAvatar').innerHTML = `<img src="data:image/jpeg;base64,${u.photoBase64}" class="w-full h-full object-cover">`; 
            
            // CORRE√á√ÉO SEGURAN√áA: S√≥ mostra se isAdmin for true no banco
            const adminBtn = document.getElementById('btnAdminPanel');
            if(u.isAdmin === true) {
                adminBtn.classList.remove('hidden');
            } else {
                adminBtn.classList.add('hidden');
            }

            const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"]; const currMonth = months[new Date().getMonth()]; const isPaid = u.payments && u.payments[currMonth]; const stCard = document.getElementById('financialCard'); const stText = document.getElementById('financialStatusText'); const stIcon = document.getElementById('financialIcon'); if(isPaid || new Date().getFullYear() < 2026) { stCard.className = "p-4 rounded-lg border mb-4 cursor-pointer btn-press bg-green-50 border-green-200 text-green-800"; stText.innerText = "MENSALIDADE EM DIA"; stIcon.className = "fas fa-check-circle text-2xl"; } else { stCard.className = "p-4 rounded-lg border mb-4 cursor-pointer btn-press bg-red-50 border-red-200 text-red-800"; stText.innerText = "PAGAMENTO PENDENTE"; stIcon.className = "fas fa-exclamation-circle text-2xl"; } const finSnap = await getDoc(doc(db, "settings", "financial")); if(finSnap.exists()) { const fin = finSnap.data(); document.getElementById('pixKey').value = fin.pixKey || "admin@bolao112.com"; document.getElementById('btnSendProof').onclick = () => { const msg = encodeURIComponent("Ei Branco! Segue o comprovante da minha mensalidade do Bol√£o 112."); window.open(`https://wa.me/${fin.adminPhone}?text=${msg}`, '_blank'); }; } 
        }
        document.getElementById('uploadPhoto').onchange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onloadend = async () => { const base64 = reader.result.split(',')[1]; await updateDoc(doc(db, "users", currentUser.uid), { photoBase64: base64 }); loadProfile(); }; reader.readAsDataURL(file); } };
        document.getElementById('financialCard').onclick = () => document.getElementById('pixArea').classList.toggle('hidden');
        document.getElementById('btnCopyPix').onclick = () => { document.getElementById('pixKey').select(); document.execCommand('copy'); alert("Chave Pix Copiada!"); };
        window.changePassword = () => {
            const newPass = prompt("Digite a nova senha (m√≠nimo 6 caracteres):");
            if(newPass && newPass.length >= 6) updatePassword(currentUser, newPass).then(() => alert("Senha alterada!")).catch(e => alert("Erro ao alterar senha. Fa√ßa login novamente."));
            else if(newPass) alert("Senha muito curta.");
        };
        window.showChangelog = () => {
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalContainer').innerHTML = `<div class="bg-white p-6"><h3 class="font-bold text-lg mb-4">Linha do Tempo</h3><p class="text-xs text-gray-600 mb-4"><b>v1.3.7 (Web):</b> Paridade completa com Android. Ranking interativo, upload de foto e extrato de pontos.</p><button onclick="closeModal()" class="w-full bg-[#006400] text-white py-2 rounded">ENTENDI</button></div>`;
        };
        async function calculatePot() { const snap = await getDocs(collection(db, "users")); let total = 0; snap.forEach(d => { const p = d.data().payments; if(p) total += Object.values(p).filter(v => v).length * 10; }); document.getElementById('potValue').innerText = total.toLocaleString('pt-br',{style:'currency',currency:'BRL'}); }
        document.getElementById('btnPot').onclick = () => document.getElementById('potModal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');
        document.getElementById('btnRefresh').onclick = () => { const active = document.querySelector('nav#bottomNav .text-\\[\\#006400\\]').id.replace('nav-',''); showTab(active); };
        document.getElementById('btnLogout').onclick = () => signOut(auth);
    </script>
</body>
</html>
