<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bol√£o 112 F.C</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap');
        
        :root { --dark-green: #006400; --gold: #FFD700; }
        
        body { 
            font-family: 'PT Serif', serif; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            background-color: #f3f4f6;
        }

        .card-cut {
            background: white;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07));
            border: 1px solid #e5e7eb;
        }

        /* Fundos Din√¢micos */
        .bg-main { background-size: cover; background-attachment: fixed; background-position: center; transition: background 0.3s ease; }
        .tab-matches { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_jogos.png'); }
        .tab-ranking { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_ranking.png'); }
        .tab-rules { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_regras.png'); }
        .tab-profile { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_perfil.png'); }

        .btn-press:active { transform: scale(0.95); transition: 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-[#006400] text-white pt-[env(safe-area-inset-top)] sticky top-0 z-50 shadow-md">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold tracking-tighter uppercase">Bol√£o 112 F.C</h1>
            <div class="flex gap-4">
                <button id="btnPot" class="btn-press text-[#FFD700]"><i class="fas fa-piggy-bank text-xl drop-shadow-md"></i></button>
                <button id="btnRefresh" class="btn-press"><i class="fas fa-sync-alt text-xl"></i></button>
                <button id="btnLogout" class="hidden btn-press"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </div>
        <div id="progressBar" class="hidden h-1 w-full bg-[#006400]"><div class="h-full bg-[#FFD700] animate-pulse w-full"></div></div>
    </nav>

    <main id="appContent" class="flex-1 overflow-y-auto bg-main tab-matches pb-32">
        
        <section id="loginScreen" class="flex flex-col items-center justify-center min-h-[70vh] p-6">
            <div class="card-cut w-full max-w-sm p-8 border-t-4 border-[#006400]">
                <h2 class="text-xl font-black text-center text-[#006400] mb-8 uppercase tracking-widest">Acesso Membros</h2>
                <input type="text" id="userInput" placeholder="Usu√°rio" class="w-full p-4 bg-gray-50 border rounded-lg mb-4 outline-none focus:ring-2 focus:ring-green-700">
                <input type="password" id="passInput" placeholder="Senha" class="w-full p-4 bg-gray-50 border rounded-lg mb-8 outline-none focus:ring-2 focus:ring-green-700">
                <button id="btnLoginAction" class="w-full bg-[#006400] text-white py-4 font-bold rounded-lg btn-press shadow-lg">ACESSAR</button>
            </div>
        </section>

        <div id="mainScreens" class="hidden p-4 space-y-4">
            
            <div id="matchesScreen" class="hidden space-y-6"></div>

            <div id="rankingScreen" class="hidden">
                <div class="card-cut p-4 mb-4 border-t-2 border-[#FFD700]">
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <h3 class="font-bold text-lg text-gray-800">Classifica√ß√£o</h3>
                        <span id="lastUpdateRanking" class="text-[10px] text-gray-400">...</span>
                    </div>
                    <div class="grid grid-cols-[30px_1fr_30px_30px_30px_40px] text-[10px] font-bold text-gray-400 uppercase text-center items-center pb-2">
                        <span>Pos</span><span class="text-left pl-2">Nome</span><span class="text-red-500">D</span><span>V</span><span>F</span><span class="text-black">PTS</span>
                    </div>
                    <div id="rankingListContent" class="space-y-1"></div>
                </div>
                <div class="bg-black/80 text-[#FFD700] p-3 text-[10px] text-center rounded-lg shadow-lg">
                    Legenda: D=D√©bitos(-1) | V=Vit√≥rias | F=Finais | PTS=Pontos
                </div>
            </div>

            <div id="rulesScreen" class="hidden space-y-4">
                <div class="card-cut p-6 border-2 border-[#006400] text-center bg-yellow-50">
                    <h2 class="text-xl font-black text-[#006400] mb-2">REGULAMENTO 2026</h2>
                    <p class="text-xs text-gray-600 leading-relaxed text-left">
                        üéØ <b>Objetivo:</b> Competi√ß√£o de palpites esportivos.<br>
                        üóìÔ∏è <b>Vig√™ncia:</b> 01/01/2026 a 31/12/2026.<br>
                        ‚úÖ A participa√ß√£o implica aceita√ß√£o total.
                    </p>
                </div>
                <div id="rulesList" class="space-y-3"></div>
            </div>

            <div id="profileScreen" class="hidden">
                <div class="card-cut p-6 border-t-4 border-[#006400] text-center relative">
                    <h2 class="font-bold text-gray-400 text-xs mb-6 tracking-[0.2em]">CART√ÉO DE MEMBRO</h2>
                    <div class="relative w-28 h-28 mx-auto mb-4">
                        <div id="profileAvatar" class="w-full h-full bg-gray-200 rounded-full border-4 border-white shadow-lg overflow-hidden flex items-center justify-center">
                            <i class="fas fa-user text-4xl text-gray-400"></i>
                        </div>
                        <label class="absolute bottom-0 right-0 bg-[#006400] text-white p-2 rounded-full shadow-md cursor-pointer btn-press">
                            <i class="fas fa-camera text-xs"></i>
                            <input type="file" id="uploadPhoto" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <h3 id="profileName" class="text-2xl font-black text-gray-800 uppercase leading-none">...</h3>
                    <p id="profileUser" class="text-gray-500 text-sm mb-6">@...</p>
                    <div id="financialCard" class="p-4 rounded-lg border mb-4 cursor-pointer btn-press transition-colors">
                        <div class="flex justify-between items-center">
                            <div class="text-left">
                                <p id="financialStatusText" class="font-black text-sm">VERIFICANDO...</p>
                                <p class="text-[10px] text-gray-500 font-bold">Toque para detalhes</p>
                            </div>
                            <i id="financialIcon" class="fas fa-circle-notch fa-spin text-2xl"></i>
                        </div>
                    </div>
                    <div id="pixArea" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200 text-left space-y-3">
                        <div class="text-center mb-2"><i class="fas fa-qrcode text-3xl text-[#006400]"></i><p class="font-bold text-[#006400]">PAGAMENTO PIX</p><p class="text-2xl font-black">R$ 10,00</p></div>
                        <div><label class="text-[10px] text-gray-500 font-bold">CHAVE PIX</label><div class="flex gap-2"><input type="text" id="pixKey" readonly class="w-full text-xs p-2 bg-white border rounded"><button id="btnCopyPix" class="bg-[#006400] text-white px-3 rounded"><i class="fas fa-copy"></i></button></div></div>
                        <button id="btnSendProof" class="w-full bg-green-500 text-white py-2 rounded font-bold text-xs shadow btn-press"><i class="fab fa-whatsapp"></i> ENVIAR COMPROVANTE</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="potModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-6" onclick="document.getElementById('potModal').classList.add('hidden')">
        <div class="card-cut w-full max-w-sm p-8 text-center relative border-t-4 border-[#FFD700]" onclick="event.stopPropagation()">
            <i class="fas fa-piggy-bank text-5xl text-[#FFD700] mb-4 drop-shadow-sm"></i>
            <h2 class="text-xl font-bold text-gray-800">POTE DE OURO</h2>
            <div class="my-6">
                <p id="potValue" class="text-4xl font-black text-[#006400]">R$ 0,00</p>
                <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Pr√™mio Acumulado</p>
            </div>
            <button onclick="document.getElementById('potModal').classList.add('hidden')" class="w-full bg-[#006400] text-white py-3 font-bold rounded shadow-lg btn-press">SHOW!</button>
        </div>
    </div>

    <div id="modalOverlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in" onclick="closeModal()">
        <div id="modalContainer" class="w-full max-w-sm bg-white rounded-none shadow-2xl overflow-hidden" onclick="event.stopPropagation()"></div>
    </div>

    <nav id="bottomNav" class="hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t safe-bottom flex justify-around p-2 z-50 shadow-2xl">
        <button onclick="showTab('matches')" class="nav-btn flex flex-col items-center text-[#006400]" id="nav-matches"><i class="fas fa-soccer-ball text-lg"></i><span class="text-[10px] mt-1">Jogos</span></button>
        <button onclick="showTab('ranking')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-ranking"><i class="fas fa-trophy text-lg"></i><span class="text-[10px] mt-1">Ranking</span></button>
        <button onclick="showTab('rules')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-rules"><i class="fas fa-gavel text-lg"></i><span class="text-[10px] mt-1">Regras</span></button>
        <button onclick="showTab('profile')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-profile"><i class="fas fa-user text-lg"></i><span class="text-[10px] mt-1">Perfil</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEkEE2X5hWIqopoJ0D9jFzCjJHKR8b82k",
            authDomain: "bolao112fc.firebaseapp.com",
            projectId: "bolao112fc",
            storageBucket: "bolao112fc.firebasestorage.app",
            messagingSenderId: "131329454158",
            appId: "1:131329454158:web:983e4544dd651ec942131f",
            measurementId: "G-5SGWJE6EKK"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentRankingData = []; // Armazena dados do ranking para acesso nos modais

        const rulesData = [
            { t: "1Ô∏è‚É£ FINANCEIRO", c: "üí∞ Mensalidade: R$ 10,00 (Venc. dia 10).\n‚ö†Ô∏è Inadimpl√™ncia: -1 ponto a cada 5 dias de atraso." },
            { t: "2Ô∏è‚É£ PREMIA√á√ÉO", c: "ü•á 1¬∫ Lugar: 60%\nü•à 2¬∫ Lugar: 30%\nü•â 3¬∫ Lugar: 10%\nDo pote anual acumulado." },
            { t: "3Ô∏è‚É£ PONTUA√á√ÉO", c: "‚úÖ Acerto: 3 pts.\nüî• Finais: 6 pts (Peso 2).\nüí• Oitavas Perfeitas: +3 pts b√¥nus." },
            { t: "4Ô∏è‚É£ COMPETI√á√ïES", c: "Copa do Mundo, Champions, Libertadores, Copa do Brasil e outras matas-matas." },
            { t: "5Ô∏è‚É£ DESEMPATE", c: "1. Menor inadimpl√™ncia.\n2. Vit√≥rias.\n3. Finais.\n4. Sorteio." },
            { t: "6Ô∏è‚É£ PLATAFORMAS", c: "Palpites apenas pelo App ou Site." }
        ];

        document.getElementById('btnLoginAction').onclick = async () => {
            const user = document.getElementById('userInput').value.trim().toLowerCase();
            const pass = document.getElementById('passInput').value;
            try { await signInWithEmailAndPassword(auth, `${user}@bolao112.com`, pass); } 
            catch (e) { alert("Dados incorretos."); }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreens').classList.remove('hidden');
                document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('btnLogout').classList.remove('hidden');
                showTab('matches');
                calculatePot();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainScreens').classList.add('hidden');
                document.getElementById('bottomNav').classList.add('hidden');
            }
        });

        window.showTab = (tab) => {
            const content = document.getElementById('appContent');
            content.className = `flex-1 overflow-y-auto bg-main pb-32 tab-${tab}`;
            ['matches', 'ranking', 'rules', 'profile'].forEach(t => {
                document.getElementById(`${t}Screen`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.replace('text-[#006400]', 'text-gray-400');
            });
            document.getElementById(`${tab}Screen`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.replace('text-gray-400', 'text-[#006400]');

            if(tab === 'matches') loadMatches();
            if(tab === 'ranking') loadRanking();
            if(tab === 'rules') renderRules();
            if(tab === 'profile') loadProfile();
        };

        // --- MATCHES (Restaurado 100%) ---
        const SectionHeader = (title, color) => `
            <div class="card-container mb-3">
                <div class="bg-white/90 border border-[${color}] rounded-tl-2xl rounded-br-2xl p-2 text-center shadow-sm">
                    <h4 class="font-bold text-[${color}] uppercase tracking-wider text-xs" style="color: ${color};">${title}</h4>
                </div>
            </div>`;

        async function loadMatches() {
            const container = document.getElementById('matchesScreen');
            document.getElementById('progressBar').classList.remove('hidden');
            
            try {
                const snap = await getDocs(collection(db, "matches"));
                const now = new Date();
                let open = [], waiting = [], finished = [];

                for (const d of snap.docs) {
                    const m = {id:d.id, ...d.data()};
                    const dl = m.deadline.toDate();
                    m.expired = now > dl;
                    m.final = m.round?.toLowerCase() === 'final';
                    if (m.winner) finished.push(m);
                    else if (m.expired) waiting.push(m);
                    else open.push(m);
                }

                open.sort((a,b)=>a.deadline.toDate()-b.deadline.toDate());
                waiting.sort((a,b)=>b.deadline.toDate()-a.deadline.toDate());
                finished.sort((a,b)=>b.deadline.toDate()-a.deadline.toDate());

                let html = "";
                if(open.length) html += SectionHeader("‚úÖ CONFRONTOS DISPON√çVEIS ‚úÖ", "#006400") + await renderMatchList(open);
                if(waiting.length) html += SectionHeader("‚è≥ AGUARDANDO RESULTADO ‚è≥", "#FBC02D") + await renderMatchList(waiting);
                if(finished.length) html += SectionHeader("üö´ CONFRONTOS FINALIZADOS üö´", "#D32F2F") + await renderMatchList(finished);
                container.innerHTML = html || `<div class="text-center text-gray-500 mt-10">Nenhum jogo encontrado.</div>`;
            } catch(e) { console.error(e); }
            document.getElementById('progressBar').classList.add('hidden');
        }

        async function renderMatchList(list) {
            let html = "";
            for (const m of list) {
                let userVote = "";
                try {
                    const vs = await getDoc(doc(db, "guesses", `${m.id}_${currentUser.uid}`));
                    if(vs.exists()) userVote = vs.data().teamSelected;
                } catch(e){}

                const dl = m.deadline.toDate();
                const borderColor = m.final ? 'border-[#FFD700]' : (m.expired ? (m.winner ? 'border-[#D32F2F]' : 'border-[#FBC02D]') : 'border-[#006400]');
                const bgColor = m.final ? 'bg-[#FFF9C4]' : 'bg-white';

                html += `
                <div class="card-cut p-4 relative border-l-[6px] ${bgColor} mb-6" style="border-left-color: ${borderColor.replace('border-[','').replace(']','')};">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex flex-col">
                            ${m.final ? '<span class="text-[10px] font-black text-orange-600 mb-1">‚òÖ FINAL ‚Ä¢ VALE DOBRO ‚òÖ</span>' : ''}
                            <span class="text-[10px] font-bold text-[#006400] uppercase">${m.competition}</span>
                            <span class="text-[11px] text-gray-400">${m.round}</span>
                            <span class="text-[10px] font-bold ${m.expired ? 'text-red-600' : 'text-black'} mt-1">
                                ${m.expired ? 'Encerrado:' : 'Prazo:'} ${dl.toLocaleTimeString([], {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}
                            </span>
                        </div>
                        <button onclick="openVoters('${m.id}', '${m.teamA}', '${m.teamB}', ${m.expired}, '${m.winner||''}')" class="text-[#006400] p-2">
                            <i class="fas ${m.expired ? 'fa-eye' : 'fa-users'} text-lg"></i>
                        </button>
                    </div>
                    <div class="flex items-center justify-between px-1">
                        ${createTeamBtn(m.id, m.teamA, m.teamAUrl, userVote===m.teamA, m.expired)}
                        <span class="font-black text-gray-300 text-xl">X</span>
                        ${createTeamBtn(m.id, m.teamB, m.teamBUrl, userVote===m.teamB, m.expired)}
                    </div>
                    ${m.winner ? `<div class="mt-3 text-center border-t pt-2"><span class="text-[10px] font-bold text-gray-400">VENCEDOR</span><p class="text-[#006400] font-black text-lg">${m.winner}</p></div>` : ''}
                </div>`;
            }
            return html;
        }

        function createTeamBtn(mid, name, url, selected, expired) {
            const bg = selected ? 'bg-[#006400] text-white' : 'bg-[#EEEEEE] text-gray-800';
            const border = selected ? 'border-2 border-[#FFD700]' : '';
            return `
            <button onclick="window.vote('${mid}', '${name}')" ${expired?'disabled':''} class="btn-press flex flex-col items-center justify-center w-[40%] h-24 rounded-lg transition-all ${bg} ${border} ${expired?'opacity-80':''}">
                <img src="${url}" class="w-10 h-10 object-contain mb-1">
                <span class="text-[11px] font-bold text-center leading-tight px-1 line-clamp-2">${name}</span>
            </button>`;
        }

        window.vote = async (mid, team) => {
            if(!currentUser) return;
            await setDoc(doc(db, "guesses", `${mid}_${currentUser.uid}`), { matchId: mid, userId: currentUser.uid, teamSelected: team, timestamp: new Date() });
            loadMatches();
        };

        window.openVoters = async (mid, ta, tb, exp, win) => {
            const modal = document.getElementById('modalOverlay');
            const cont = document.getElementById('modalContainer');
            modal.classList.remove('hidden');
            cont.innerHTML = `<div class="bg-white p-4 text-center"><i class="fas fa-spinner fa-spin text-[#006400]"></i></div>`;

            const gSnap = await getDocs(query(collection(db, "guesses"), where("matchId", "==", mid)));
            const uSnap = await getDocs(collection(db, "users"));
            const uMap = {}; uSnap.forEach(u => uMap[u.id] = u.data());

            let rows = "";
            gSnap.forEach(g => {
                const d = g.data();
                const u = uMap[d.userId] || {name: "Desc.", photoBase64: ""};
                let voteDisplay = `<span class="text-[10px] text-gray-400 italic"><i class="fas fa-lock"></i> Sigilo</span>`;
                let bg = "bg-white";
                
                if (exp) {
                    voteDisplay = `<span class="text-[11px] font-bold">${d.teamSelected}</span>`;
                    if(win) {
                        if(d.teamSelected === win) { bg = "bg-green-50"; voteDisplay += ` <i class="fas fa-check-circle text-green-600"></i>`; }
                        else { bg = "bg-red-50"; voteDisplay += ` <i class="fas fa-times-circle text-red-600"></i>`; }
                    }
                }

                rows += `
                <div class="flex justify-between items-center p-2 border-b border-gray-100 ${bg}">
                    <div class="flex items-center gap-2">
                        ${u.photoBase64 ? `<img src="data:image/jpeg;base64,${u.photoBase64}" class="w-6 h-6 rounded-full object-cover">` : `<i class="fas fa-user-circle text-gray-300"></i>`}
                        <span class="text-xs font-bold truncate w-24">${u.name}</span>
                    </div>
                    <div>${voteDisplay}</div>
                </div>`;
            });

            cont.innerHTML = `
                <div class="bg-gray-50 p-3 border-b flex justify-between items-center">
                    <h3 class="font-bold text-[#006400] uppercase text-xs">${exp ? 'Palpites' : 'Quem j√° votou?'}</h3>
                    <button onclick="closeModal()"><i class="fas fa-times text-gray-400"></i></button>
                </div>
                <div class="bg-white max-h-[60vh] overflow-y-auto p-2">${rows || '<p class="text-xs text-center p-4">Sem votos.</p>'}</div>
                <div class="bg-gray-50 p-3 text-center"><button onclick="closeModal()" class="text-[#006400] font-black text-xs">FECHAR</button></div>
            `;
        };

        // --- RANKING (Corrigido o bug do clique) ---
        async function loadRanking() {
            const list = document.getElementById('rankingListContent');
            list.innerHTML = `<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-[#006400]"></i></div>`;
            
            const [uSnap, gSnap, mSnap] = await Promise.all([getDocs(collection(db, "users")), getDocs(collection(db, "guesses")), getDocs(collection(db, "matches"))]);
            const matches = []; mSnap.forEach(d => matches.push({id:d.id, ...d.data()}));
            const finished = matches.filter(m => m.winner);

            let users = [];
            uSnap.forEach(ud => {
                const u = ud.data();
                let p=0, v=0, f=0;
                const hist = [];
                // Calculo simples (igual ao anterior)
                gSnap.forEach(gd => {
                    const g = gd.data();
                    if(g.userId === ud.id) {
                        const m = finished.find(x => x.id === g.matchId);
                        if(m && m.winner === g.teamSelected) {
                            const isF = m.round?.toLowerCase() === 'final';
                            p += isF ? 6 : 3; v++; if(isF) f++;
                            hist.push(`‚úÖ ${m.teamA} x ${m.teamB}`);
                        } else if(m) hist.push(`üëé ${m.teamA} x ${m.teamB}`);
                    }
                });
                const deb = u.debts || 0; p -= deb;
                if(deb > 0) hist.push(`üîª D√©bitos: -${deb}`);
                
                users.push({name: u.name||"Sem Nome", p, v, f, d: deb, photo: u.photoBase64, hist});
            });

            users.sort((a,b) => b.p - a.p || a.d - b.d); 
            
            // ATEN√á√ÉO: Salva os dados na vari√°vel global para o clique funcionar
            currentRankingData = users; 

            list.innerHTML = users.map((u, i) => {
                const pos = i+1;
                const bg = pos===1?'bg-yellow-50':(pos<=3?'bg-gray-50':'bg-white');
                // IMPORTANTE: onclick agora usa o index 'i'
                return `
                <div class="${bg} rounded p-2 flex items-center border border-gray-100 text-xs mb-1">
                    <div class="w-[30px] font-bold text-center">${pos}¬∫</div>
                    <div class="flex-1 flex items-center gap-2 overflow-hidden pl-2 btn-press" onclick="openRankingPhoto(${i})">
                        ${u.photo ? `<img src="data:image/jpeg;base64,${u.photo}" class="w-6 h-6 rounded-full border object-cover">` : `<i class="fas fa-user-circle text-gray-300 text-lg"></i>`}
                        <span class="font-bold truncate">${u.name}</span>
                    </div>
                    <div class="w-[30px] text-center text-red-500 font-bold btn-press" onclick="openRankingHistory(${i})">${u.d}</div>
                    <div class="w-[30px] text-center text-gray-500 btn-press" onclick="openRankingHistory(${i})">${u.v}</div>
                    <div class="w-[30px] text-center text-gray-500 btn-press" onclick="openRankingHistory(${i})">${u.f}</div>
                    <div class="w-[40px] text-center font-black text-[#006400] text-sm btn-press" onclick="openRankingHistory(${i})">${u.p}</div>
                </div>`;
            }).join('');
            document.getElementById('lastUpdateRanking').innerText = "Atualizado agora";
        }

        window.openRankingPhoto = (index) => {
            const u = currentRankingData[index];
            if(!u.photo) return;
            const modal = document.getElementById('modalOverlay');
            const cont = document.getElementById('modalContainer');
            modal.classList.remove('hidden');
            cont.innerHTML = `
                <div class="bg-white p-4 text-center">
                    <img src="data:image/jpeg;base64,${u.photo}" class="w-full rounded mb-4">
                    <h3 class="font-bold uppercase">${u.name}</h3>
                    <button onclick="closeModal()" class="mt-4 text-[#006400] font-black text-xs">FECHAR</button>
                </div>`;
        }

        window.openRankingHistory = (index) => {
            const u = currentRankingData[index];
            const html = u.hist.length ? u.hist.map(l => `<div class="border-b py-2 text-xs ${l.includes('‚úÖ')?'':'text-red-500'}">${l}</div>`).join('') : "Sem hist√≥rico.";
            const modal = document.getElementById('modalOverlay');
            const cont = document.getElementById('modalContainer');
            modal.classList.remove('hidden');
            cont.innerHTML = `
                <div class="bg-gray-50 p-3 border-b"><h3 class="font-bold text-[#006400] uppercase text-xs">Extrato: ${u.name}</h3></div>
                <div class="bg-white p-4 max-h-[50vh] overflow-y-auto">${html}</div>
                <div class="bg-gray-50 p-3 text-center"><button onclick="closeModal()" class="text-[#006400] font-black text-xs">FECHAR</button></div>`;
        }

        // --- OUTRAS FUN√á√ïES ---
        function renderRules() {
            document.getElementById('rulesList').innerHTML = rulesData.map(r => `
                <div class="bg-white rounded p-3 shadow-sm border border-gray-100">
                    <button class="w-full text-left font-bold text-xs text-[#006400] flex justify-between" onclick="this.nextElementSibling.classList.toggle('hidden')">${r.t} <i class="fas fa-chevron-down"></i></button>
                    <div class="hidden mt-2 text-xs text-gray-600 border-t pt-2 whitespace-pre-line">${r.c}</div>
                </div>`).join('');
        }

        async function loadProfile() { 
            const docRef = doc(db, "users", currentUser.uid); const snap = await getDoc(docRef); if(!snap.exists()) return; const u = snap.data(); document.getElementById('profileName').innerText = u.name || "MEMBRO"; document.getElementById('profileUser').innerText = `@${u.username}`; if(u.photoBase64) document.getElementById('profileAvatar').innerHTML = `<img src="data:image/jpeg;base64,${u.photoBase64}" class="w-full h-full object-cover">`; const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"]; const currMonth = months[new Date().getMonth()]; const isPaid = u.payments && u.payments[currMonth]; const stCard = document.getElementById('financialCard'); const stText = document.getElementById('financialStatusText'); const stIcon = document.getElementById('financialIcon'); if(isPaid || new Date().getFullYear() < 2026) { stCard.className = "p-4 rounded-lg border mb-4 cursor-pointer btn-press bg-green-50 border-green-200 text-green-800"; stText.innerText = "MENSALIDADE EM DIA"; stIcon.className = "fas fa-check-circle text-2xl"; } else { stCard.className = "p-4 rounded-lg border mb-4 cursor-pointer btn-press bg-red-50 border-red-200 text-red-800"; stText.innerText = "PAGAMENTO PENDENTE"; stIcon.className = "fas fa-exclamation-circle text-2xl"; } const finSnap = await getDoc(doc(db, "settings", "financial")); if(finSnap.exists()) { const fin = finSnap.data(); document.getElementById('pixKey').value = fin.pixKey || "admin@bolao112.com"; document.getElementById('btnSendProof').onclick = () => { const msg = encodeURIComponent("Ei Branco! Segue o comprovante da minha mensalidade do Bol√£o 112."); window.open(`https://wa.me/${fin.adminPhone}?text=${msg}`, '_blank'); }; } 
        }
        document.getElementById('uploadPhoto').onchange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onloadend = async () => { const base64 = reader.result.split(',')[1]; await updateDoc(doc(db, "users", currentUser.uid), { photoBase64: base64 }); loadProfile(); }; reader.readAsDataURL(file); } };
        document.getElementById('financialCard').onclick = () => document.getElementById('pixArea').classList.toggle('hidden');
        document.getElementById('btnCopyPix').onclick = () => { document.getElementById('pixKey').select(); document.execCommand('copy'); alert("Chave Pix Copiada!"); };
        async function calculatePot() { const snap = await getDocs(collection(db, "users")); let total = 0; snap.forEach(d => { const p = d.data().payments; if(p) total += Object.values(p).filter(v => v).length * 10; }); document.getElementById('potModal').querySelector('p.text-4xl').innerText = total.toLocaleString('pt-br',{style:'currency',currency:'BRL'}); }
        document.getElementById('btnPot').onclick = () => document.getElementById('potModal').classList.remove('hidden');
        
        window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');
        document.getElementById('btnRefresh').onclick = () => {
            const active = document.querySelector('nav#bottomNav .text-\\[\\#006400\\]').id.replace('nav-','');
            showTab(active);
        };
        document.getElementById('btnLogout').onclick = () => signOut(auth);

    </script>
</body>
</html>
