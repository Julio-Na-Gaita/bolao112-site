<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bol√£o 112 F.C</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap');
        :root { --dark-green: #006400; --gold: #FFD700; }
        body { font-family: 'PT Serif', serif; -webkit-tap-highlight-color: transparent; user-select: none; background-color: #f3f4f6; }
        
        .card-cut { background: white; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)); }
        
        .bg-main { background-size: cover; background-attachment: fixed; background-position: center; transition: background 0.3s ease; }
        .tab-matches { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_jogos.png'); }
        .tab-ranking { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_ranking.png'); }
        .tab-rules { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_regras.png'); }
        .tab-profile { background-image: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)), url('bg_perfil.png'); }

        .btn-press:active { transform: scale(0.90); transition: 0.1s; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-[#006400] text-white pt-[env(safe-area-inset-top)] sticky top-0 z-50 shadow-md">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-lg font-bold tracking-tighter uppercase">Bol√£o 112 F.C</h1>
            <div class="flex gap-4">
                <button id="btnPot" class="btn-press text-[#FFD700]"><i class="fas fa-piggy-bank text-xl drop-shadow-md"></i></button>
                <button id="btnRefresh" class="btn-press"><i class="fas fa-sync-alt text-xl"></i></button>
                <button id="btnLogout" class="hidden btn-press"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </div>
    </nav>

    <main id="appContent" class="flex-1 overflow-y-auto bg-main tab-matches pb-32">
        <section id="loginScreen" class="flex flex-col items-center justify-center min-h-[70vh] p-6">
            <div class="card-cut w-full max-w-sm p-8 border-t-4 border-[#006400]">
                <h2 class="text-xl font-black text-center text-[#006400] mb-8 uppercase tracking-widest">Acesso Membros</h2>
                <input type="text" id="userInput" placeholder="Usu√°rio" class="w-full p-4 bg-gray-50 border rounded-lg mb-4 outline-none focus:ring-2 focus:ring-green-700">
                <input type="password" id="passInput" placeholder="Senha" class="w-full p-4 bg-gray-50 border rounded-lg mb-8 outline-none focus:ring-2 focus:ring-green-700">
                <button id="btnLoginAction" class="w-full bg-[#006400] text-white py-4 font-bold rounded-lg btn-press shadow-lg">ACESSAR</button>
            </div>
        </section>

        <div id="mainLists" class="hidden p-4 space-y-4">
            <div id="matchesList" class="space-y-8"></div>
            
            <div id="rankingContainer" class="hidden">
                <div class="card-cut p-4 mb-4 border-t-2 border-[#FFD700]">
                    <div class="flex justify-between items-center border-b pb-2 mb-2">
                        <h3 class="font-bold text-lg text-gray-800">Classifica√ß√£o</h3>
                        <span id="lastUpdateRanking" class="text-[10px] text-gray-400">...</span>
                    </div>
                    <div class="grid grid-cols-[30px_1fr_30px_30px_30px_40px] text-[10px] font-bold text-gray-400 uppercase text-center">
                        <span>Pos</span><span class="text-left pl-2">Nome</span><span class="text-red-500">D</span><span>V</span><span>F</span><span class="text-black">PTS</span>
                    </div>
                    <div id="rankingListContent" class="mt-2 space-y-2"></div>
                </div>
                <div class="bg-black/80 text-[#FFD700] p-3 text-[10px] text-center rounded-lg shadow-lg">Legenda: D=D√©bitos(-1) | V=Vit√≥rias | F=Finais | PTS=Pontos</div>
            </div>

            <div id="rulesContainer" class="hidden space-y-4">
                <div class="card-cut p-6 border-2 border-[#006400] text-center bg-yellow-50">
                    <h2 class="text-xl font-black text-[#006400] mb-2">REGULAMENTO 2026</h2>
                    <p class="text-xs text-gray-600 leading-relaxed text-left">
                        üéØ <b>Objetivo:</b> Competi√ß√£o de palpites esportivos...<br>
                        üóìÔ∏è <b>Vig√™ncia:</b> 01/01/2026 a 31/12/2026.<br>
                        ‚úÖ A participa√ß√£o implica aceita√ß√£o total.
                    </p>
                </div>
                <div id="rulesList" class="space-y-3"></div>
            </div>

            <div id="profileContainer" class="hidden">
                <div class="card-cut p-6 border-t-4 border-[#006400] text-center relative">
                    <h2 class="font-bold text-gray-400 text-xs mb-6 tracking-[0.2em]">CART√ÉO DE MEMBRO</h2>
                    <div class="relative w-28 h-28 mx-auto mb-4">
                        <div id="profileAvatar" class="w-full h-full bg-gray-200 rounded-full border-4 border-white shadow-lg overflow-hidden flex items-center justify-center">
                            <i class="fas fa-user text-4xl text-gray-400"></i>
                        </div>
                        <label class="absolute bottom-0 right-0 bg-[#006400] text-white p-2 rounded-full shadow-md cursor-pointer btn-press">
                            <i class="fas fa-camera text-xs"></i>
                            <input type="file" id="uploadPhoto" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <h3 id="profileName" class="text-2xl font-black text-gray-800 uppercase leading-none">...</h3>
                    <p id="profileUser" class="text-gray-500 text-sm mb-6">@...</p>
                    <div id="financialCard" class="p-4 rounded-lg border mb-4 cursor-pointer btn-press transition-colors">
                        <div class="flex justify-between items-center">
                            <div class="text-left"><p id="financialStatusText" class="font-black text-sm">VERIFICANDO...</p></div>
                            <i id="financialIcon" class="fas fa-circle-notch fa-spin text-2xl"></i>
                        </div>
                    </div>
                    <div id="pixArea" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200 text-left space-y-3">
                        <div class="text-center mb-2"><i class="fas fa-qrcode text-3xl text-[#006400]"></i><p class="font-bold text-[#006400]">PAGAMENTO PIX</p><p class="text-2xl font-black">R$ 10,00</p></div>
                        <div><label class="text-[10px] text-gray-500 font-bold">CHAVE PIX</label><div class="flex gap-2"><input type="text" id="pixKey" readonly class="w-full text-xs p-2 bg-white border rounded"><button id="btnCopyPix" class="bg-[#006400] text-white px-3 rounded"><i class="fas fa-copy"></i></button></div></div>
                        <button id="btnSendProof" class="w-full bg-green-500 text-white py-2 rounded font-bold text-xs shadow btn-press"><i class="fab fa-whatsapp"></i> ENVIAR COMPROVANTE</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-6" onclick="closeModal(event)">
        <div id="modalContent" class="w-full max-w-sm" onclick="event.stopPropagation()"></div>
    </div>

    <nav id="bottomNav" class="hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t safe-bottom flex justify-around p-2 z-50 shadow-2xl">
        <button onclick="showTab('matches')" class="nav-btn flex flex-col items-center text-[#006400]" id="nav-matches"><i class="fas fa-soccer-ball text-lg"></i><span class="text-[10px] mt-1">Jogos</span></button>
        <button onclick="showTab('ranking')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-ranking"><i class="fas fa-trophy text-lg"></i><span class="text-[10px] mt-1">Ranking</span></button>
        <button onclick="showTab('rules')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-rules"><i class="fas fa-gavel text-lg"></i><span class="text-[10px] mt-1">Regras</span></button>
        <button onclick="showTab('profile')" class="nav-btn flex flex-col items-center text-gray-400" id="nav-profile"><i class="fas fa-user text-lg"></i><span class="text-[10px] mt-1">Perfil</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEkEE2X5hWIqopoJ0D9jFzCjJHKR8b82k",
            authDomain: "bolao112fc.firebaseapp.com",
            projectId: "bolao112fc",
            storageBucket: "bolao112fc.firebasestorage.app",
            messagingSenderId: "131329454158",
            appId: "1:131329454158:web:983e4544dd651ec942131f",
            measurementId: "G-5SGWJE6EKK"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // Regras Completas
        const rulesData = [
            { t: "1Ô∏è‚É£ PARTICIPA√á√ÉO E FINANCEIRO", c: "üí∞ Aporte Mensal: R$ 10,00 (Venc. dia 10).\n‚ö†Ô∏è Inadimpl√™ncia: -1 ponto a cada 5 dias de atraso e perda do direito de voto." },
            { t: "2Ô∏è‚É£ PREMIA√á√ÉO FINAL", c: "ü•á 1¬∫ Lugar: 60%\nü•à 2¬∫ Lugar: 30%\nü•â 3¬∫ Lugar: 10%\nDo pote anual acumulado." },
            { t: "3Ô∏è‚É£ SISTEMA DE PONTUA√á√ÉO", c: "‚úÖ Acerto: 3 pontos.\nüî• Finais: 6 pontos (Peso 2).\nüí• Oitavas Perfeitas: +3 pontos b√¥nus." },
            { t: "4Ô∏è‚É£ COMPETI√á√ïES V√ÅLIDAS", c: "Copa do Mundo, Champions League, Libertadores, Copa do Brasil, Sul-Americana e outras copas mata-mata." },
            { t: "5Ô∏è‚É£ CRIT√âRIOS DE DESEMPATE", c: "1. Menor inadimpl√™ncia (D)\n2. Maior n¬∫ de vit√≥rias (V)\n3. Maior n¬∫ de finais (F)\n4. Sorteio." },
            { t: "6Ô∏è‚É£ PLATAFORMAS OFICIAIS", c: "Palpites exclusivos pelo App Android ou Site/PWA. Votos por WhatsApp n√£o s√£o v√°lidos." },
            { t: "7Ô∏è‚É£ BLOQUEIO DE EDI√á√ÉO", c: "O sistema trava automaticamente qualquer palpite ap√≥s o hor√°rio oficial do jogo (deadline)." }
        ];

        document.getElementById('btnLoginAction').onclick = async () => {
            const user = document.getElementById('userInput').value.trim().toLowerCase();
            const pass = document.getElementById('passInput').value;
            try { await signInWithEmailAndPassword(auth, `${user}@bolao112.com`, pass); } 
            catch (e) { alert("Acesso negado."); }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainLists').classList.remove('hidden');
                document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('btnLogout').classList.remove('hidden');
                showTab('matches');
                calculatePot();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainLists').classList.add('hidden');
                document.getElementById('bottomNav').classList.add('hidden');
            }
        });

        window.showTab = (tab) => {
            const content = document.getElementById('appContent');
            content.classList.remove('tab-matches', 'tab-ranking', 'tab-rules', 'tab-profile');
            content.classList.add(`tab-${tab}`);
            ['matches', 'ranking', 'rules', 'profile'].forEach(t => {
                document.getElementById(`${t}Container`)?.classList.add('hidden');
                document.getElementById('matchesList')?.classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.replace('text-[#006400]', 'text-gray-400');
            });
            if(tab === 'matches') { document.getElementById('matchesList').classList.remove('hidden'); loadMatches(); }
            else {
                document.getElementById(`${tab}Container`).classList.remove('hidden');
                if(tab === 'ranking') loadRanking();
                if(tab === 'rules') renderRules();
                if(tab === 'profile') loadProfile();
            }
            document.getElementById(`nav-${tab}`).classList.replace('text-gray-400', 'text-[#006400]');
        };

        // --- SECTION HEADERS ---
        const SectionHeader = (title, color) => `
            <div class="bg-white/90 border border-[${color}] rounded-tl-2xl rounded-br-2xl p-2 text-center shadow-sm mb-4">
                <h4 class="font-bold text-[${color}] uppercase tracking-wider text-xs">${title}</h4>
            </div>`;

        async function loadMatches() {
            const list = document.getElementById('matchesList');
            list.innerHTML = `<div class="text-center py-20 text-green-800"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
            const snap = await getDocs(collection(db, "matches"));
            const now = new Date();
            
            let open = [], waiting = [], finished = [];
            
            snap.forEach(doc => {
                const m = {id: doc.id, ...doc.data()};
                const deadline = m.deadline.toDate();
                if(m.winner) finished.push(m);
                else if(now > deadline) waiting.push(m);
                else open.push(m);
            });

            // Ordena√ß√£o
            open.sort((a,b) => a.deadline.toDate() - b.deadline.toDate());
            waiting.sort((a,b) => b.deadline.toDate() - a.deadline.toDate());
            finished.sort((a,b) => b.deadline.toDate() - a.deadline.toDate());

            let html = "";
            if(open.length) html += SectionHeader("‚úÖ CONFRONTOS DISPON√çVEIS ‚úÖ", "#006400") + open.map(m => createMatchCard(m, false)).join('');
            if(waiting.length) html += SectionHeader("‚è≥ AGUARDANDO RESULTADO ‚è≥", "#FBC02D") + waiting.map(m => createMatchCard(m, true)).join('');
            if(finished.length) html += SectionHeader("üö´ CONFRONTOS FINALIZADOS üö´", "#D32F2F") + finished.map(m => createMatchCard(m, true)).join('');
            
            list.innerHTML = html || `<div class="text-center text-gray-500 mt-10">Nenhum jogo encontrado.</div>`;
            // Re-hidratar votos (Async)
            document.querySelectorAll('.match-card').forEach(async el => {
                const mid = el.dataset.id;
                const vRef = doc(db, "guesses", `${mid}_${currentUser.uid}`);
                const vSnap = await getDoc(vRef);
                if(vSnap.exists()) {
                    const vote = vSnap.data().teamSelected;
                    const btn = el.querySelector(`button[data-team="${vote}"] span`);
                    if(btn) btn.className = "text-[11px] font-black text-center leading-tight text-[#006400] underline decoration-2 underline-offset-4";
                }
            });
        }

        function createMatchCard(m, expired) {
            const deadline = m.deadline.toDate();
            return `
                <div class="match-card card-cut p-5 relative border-l-[6px] ${m.winner ? 'border-red-600 opacity-90' : (expired ? 'border-yellow-500' : 'border-[#006400]')} mb-6" data-id="${m.id}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex flex-col">
                            <span class="text-[10px] font-bold text-[#006400] uppercase">${m.competition}</span>
                            <span class="text-[12px] text-gray-400 font-serif">${m.round}</span>
                            <span class="text-[10px] font-bold ${expired ? 'text-red-600' : 'text-black'} mt-1">
                                ${expired ? 'Encerrado:' : 'Prazo:'} ${deadline.toLocaleTimeString([], {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}
                            </span>
                        </div>
                        <button onclick="openVoters('${m.id}', '${m.teamA}', '${m.teamB}', ${expired}, '${m.winner||''}')" class="text-[#006400]">
                            <i class="fas ${expired ? 'fa-eye' : 'fa-users'} text-lg"></i>
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-between px-2">
                        <button onclick="vote('${m.id}', '${m.teamA}')" ${expired ? 'disabled' : ''} class="btn-press flex flex-col items-center w-[42%]" data-team="${m.teamA}">
                            <img src="${m.teamAUrl}" class="w-14 h-14 object-contain mb-3 drop-shadow-sm">
                            <span class="text-[12px] font-black text-center leading-tight text-gray-800">${m.teamA}</span>
                        </button>
                        <span class="italic font-black text-gray-200 text-2xl">VS</span>
                        <button onclick="vote('${m.id}', '${m.teamB}')" ${expired ? 'disabled' : ''} class="btn-press flex flex-col items-center w-[42%]" data-team="${m.teamB}">
                            <img src="${m.teamBUrl}" class="w-14 h-14 object-contain mb-3 drop-shadow-sm">
                            <span class="text-[12px] font-black text-center leading-tight text-gray-800">${m.teamB}</span>
                        </button>
                    </div>
                    ${m.winner ? `<div class="mt-4 text-center border-t pt-2"><span class="text-[10px] text-gray-400 font-bold">VENCEDOR</span><p class="text-[#006400] font-black text-lg">${m.winner}</p></div>` : ''}
                </div>`;
        }

        window.vote = async (mId, team) => {
            if(!currentUser) return;
            await setDoc(doc(db, "guesses", `${mId}_${currentUser.uid}`), { matchId: mId, userId: currentUser.uid, teamSelected: team, timestamp: new Date() });
            loadMatches(); // Simples reload para atualizar visual
        };

        // --- VOTANTES MODAL ---
        window.openVoters = async (mId, tA, tB, expired, winner) => {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            content.innerHTML = `<div class="card-cut p-6 text-center"><i class="fas fa-spinner fa-spin text-2xl text-[#006400]"></i></div>`;

            const guessesSnap = await getDocs(query(collection(db, "guesses"), where("matchId", "==", mId))); // Requer √≠ndice composto se for complexo, mas aqui √© simples
            // OBS: Onde clause client-side filtering se n√£o tiver indice
            const allGuesses = [];
            guessesSnap.forEach(d => allGuesses.push(d.data()));
            
            const usersSnap = await getDocs(collection(db, "users"));
            const usersMap = {};
            usersSnap.forEach(u => usersMap[u.id] = u.data());

            let listHtml = "";
            if(allGuesses.length === 0) listHtml = `<p class="text-sm text-gray-500 py-4">Nenhum voto registrado.</p>`;
            
            // Ordena√ß√£o (Vencedores primeiro)
            allGuesses.sort((a,b) => {
                const nameA = usersMap[a.userId]?.name || "";
                const nameB = usersMap[b.userId]?.name || "";
                if(winner) {
                    const winA = a.teamSelected === winner;
                    const winB = b.teamSelected === winner;
                    if(winA && !winB) return -1;
                    if(!winA && winB) return 1;
                }
                return nameA.localeCompare(nameB);
            });

            allGuesses.forEach(g => {
                const u = usersMap[g.userId] || {name: "Desconhecido"};
                const isWinner = winner && g.teamSelected === winner;
                const isLoser = winner && g.teamSelected !== winner;
                const rowBg = isWinner ? 'bg-green-50' : (isLoser ? 'bg-red-50' : 'bg-white');
                const icon = isWinner ? '<i class="fas fa-check-circle text-green-700"></i>' : (isLoser ? '<i class="fas fa-times-circle text-red-600"></i>' : '');

                listHtml += `
                    <div class="flex items-center justify-between p-2 rounded mb-1 border-b border-gray-100 ${rowBg}">
                        <div class="flex items-center gap-2">
                            ${u.photoBase64 ? `<img src="data:image/jpeg;base64,${u.photoBase64}" class="w-6 h-6 rounded-full object-cover">` : `<i class="fas fa-user-circle text-gray-300"></i>`}
                            <span class="text-xs font-bold truncate max-w-[120px]">${u.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${expired ? `<span class="text-[10px] font-black">${g.teamSelected}</span> ${icon}` : `<span class="text-[10px] text-gray-400 italic"><i class="fas fa-lock text-[10px]"></i> Sigilo</span>`}
                        </div>
                    </div>`;
            });

            content.innerHTML = `
                <div class="card-cut p-0 overflow-hidden">
                    <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                        <h3 class="font-bold text-[#006400] text-sm uppercase">${expired ? 'Palpites Registrados' : 'Quem j√° votou?'}</h3>
                        <button onclick="closeModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="max-h-[60vh] overflow-y-auto p-4 space-y-1">
                        ${listHtml}
                    </div>
                    <div class="p-3 bg-gray-50 text-center">
                        <button onclick="closeModal()" class="text-[#006400] font-black text-xs">FECHAR</button>
                    </div>
                </div>`;
        };

        window.closeModal = () => document.getElementById('modalOverlay').classList.add('hidden');

        // --- RANKING ---
        async function loadRanking() {
            // ... (L√≥gica id√™ntica √† anterior, mas com adi√ß√£o de Modal de Detalhes) ...
            const list = document.getElementById('rankingListContent');
            list.innerHTML = `<div class="text-center py-10"><i class="fas fa-spinner fa-spin"></i></div>`;
            const [usersSnap, guessesSnap, matchesSnap] = await Promise.all([getDocs(collection(db, "users")), getDocs(collection(db, "guesses")), getDocs(collection(db, "matches"))]);
            const matches = []; matchesSnap.forEach(d => matches.push({id: d.id, ...d.data()}));
            const finished = matches.filter(m => m.winner);
            
            let users = [];
            usersSnap.forEach(uDoc => {
                const u = uDoc.data();
                let p=0, v=0, f=0;
                const hist = [];
                guessesSnap.forEach(g => { 
                    if(g.data().userId === uDoc.id) {
                        const m = finished.find(fm => fm.id === g.data().matchId);
                        if(m) {
                            const hit = m.winner === g.data().teamSelected;
                            const isFin = m.round === "Final";
                            if(hit) { p += isFin?6:3; v++; if(isFin)f++; hist.push(`‚úÖ Acertou: ${m.teamA} x ${m.teamB} (+${isFin?6:3})`); }
                            else hist.push(`üëé Errou: ${m.teamA} x ${m.teamB}`);
                        }
                    }
                });
                const d = u.debts||0; p-=d; if(d>0) hist.push(`üîª Penalidade (-${d})`);
                users.push({id: uDoc.id, name: u.name||"Sem Nome", p, v, f, d, photo: u.photoBase64, history: hist});
            });

            users.sort((a,b) => b.p - a.p || a.d - b.d || b.v - a.v || b.f - a.f);
            
            list.innerHTML = "";
            users.forEach((u, i) => {
                const pos = i + 1;
                const bg = pos === 1 ? 'bg-yellow-50' : (pos <= 3 ? 'bg-gray-50' : 'bg-white');
                list.innerHTML += `
                    <div class="${bg} rounded-lg p-3 flex items-center border border-gray-100 shadow-sm text-xs">
                        <div class="w-[30px] font-bold text-center">${pos}¬∫</div>
                        <div class="flex-1 flex items-center pl-2 gap-2 overflow-hidden" onclick="openPhoto('${u.photo}', '${u.name}')">
                            ${u.photo ? `<img src="data:image/jpeg;base64,${u.photo}" class="w-6 h-6 rounded-full object-cover border">` : `<i class="fas fa-user-circle text-gray-300 text-lg"></i>`}
                            <span class="font-bold truncate">${u.name}</span>
                        </div>
                        <div class="w-[30px] text-center text-red-500 font-bold clickable" onclick="openHistory('${u.name}', '${u.history.join('|')}')">${u.d}</div>
                        <div class="w-[30px] text-center text-gray-500 clickable" onclick="openHistory('${u.name}', '${u.history.join('|')}')">${u.v}</div>
                        <div class="w-[30px] text-center text-gray-500 clickable" onclick="openHistory('${u.name}', '${u.history.join('|')}')">${u.f}</div>
                        <div class="w-[40px] text-center font-black text-[#006400] text-sm clickable" onclick="openHistory('${u.name}', '${u.history.join('|')}')">${u.p}</div>
                    </div>`;
            });
            document.getElementById('lastUpdateRanking').innerText = `Atualizado: ${new Date().toLocaleTimeString().slice(0,5)}`;
        }

        window.openHistory = (name, rawHist) => {
            const hist = rawHist.split('|');
            const html = hist.length ? hist.map(h => `<div class="border-b py-2 text-xs ${h.includes('‚úÖ')?'text-black':'text-red-500'}">${h}</div>`).join('') : '<p>Sem hist√≥rico.</p>';
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalContent').innerHTML = `
                <div class="card-cut p-0 overflow-hidden">
                    <div class="bg-gray-50 p-4 border-b"><h3 class="font-bold uppercase text-[#006400]">Extrato: ${name}</h3></div>
                    <div class="max-h-[50vh] overflow-y-auto p-4">${html}</div>
                    <div class="p-3 text-center"><button onclick="closeModal()" class="text-xs font-black text-[#006400]">FECHAR</button></div>
                </div>`;
        };

        window.openPhoto = (b64, name) => {
            if(!b64) return;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalContent').innerHTML = `
                <div class="card-cut p-4 text-center">
                    <img src="data:image/jpeg;base64,${b64}" class="w-full rounded bg-gray-200 mb-4">
                    <h3 class="font-bold uppercase">${name}</h3>
                    <button onclick="closeModal()" class="mt-4 text-[#006400] font-black text-xs">FECHAR</button>
                </div>`;
        }

        // --- OUTRAS FUN√á√ïES ---
        function renderRules() {
            const list = document.getElementById('rulesList');
            if(list.innerHTML !== "") return;
            list.innerHTML = rulesData.map(r => `
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                    <button class="w-full text-left font-bold text-sm text-[#006400] flex justify-between items-center" onclick="this.nextElementSibling.classList.toggle('hidden')">${r.t} <i class="fas fa-chevron-down text-xs"></i></button>
                    <div class="hidden mt-3 text-xs text-gray-700 leading-relaxed border-t pt-2 whitespace-pre-line">${r.c}</div>
                </div>`).join('');
        }

        // ... (Profile Logic e Pote Logic mantidos da vers√£o anterior) ...
        async function loadProfile() { /* Mesmo c√≥digo anterior */ const docRef = doc(db, "users", currentUser.uid); const snap = await getDoc(docRef); if(!snap.exists()) return; const u = snap.data(); document.getElementById('profileName').innerText = u.name || "MEMBRO"; document.getElementById('profileUser').innerText = `@${u.username}`; if(u.photoBase64) document.getElementById('profileAvatar').innerHTML = `<img src="data:image/jpeg;base64,${u.photoBase64}" class="w-full h-full object-cover">`; const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"]; const currMonth = months[new Date().getMonth()]; const isPaid = u.payments && u.payments[currMonth]; const stCard = document.getElementById('financialCard'); const stText = document.getElementById('financialStatusText'); const stIcon = document.getElementById('financialIcon'); if(isPaid || new Date().getFullYear() < 2026) { stCard.className = "p-4 rounded-lg border mb-4 cursor-pointer btn-press bg-green-50 border-green-200 text-green-800"; stText.innerText = "MENSALIDADE EM DIA"; stIcon.className = "fas fa-check-circle text-2xl"; } else { stCard.className = "p-4 rounded-lg border mb-4 cursor-pointer btn-press bg-red-50 border-red-200 text-red-800"; stText.innerText = "PAGAMENTO PENDENTE"; stIcon.className = "fas fa-exclamation-circle text-2xl"; } const finSnap = await getDoc(doc(db, "settings", "financial")); if(finSnap.exists()) { const fin = finSnap.data(); document.getElementById('pixKey').value = fin.pixKey || "admin@bolao112.com"; document.getElementById('btnSendProof').onclick = () => { const msg = encodeURIComponent("Ei Branco! Segue o comprovante da minha mensalidade do Bol√£o 112."); window.open(`https://wa.me/${fin.adminPhone}?text=${msg}`, '_blank'); }; } }
        document.getElementById('uploadPhoto').onchange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onloadend = async () => { const base64 = reader.result.split(',')[1]; await updateDoc(doc(db, "users", currentUser.uid), { photoBase64: base64 }); loadProfile(); }; reader.readAsDataURL(file); } };
        document.getElementById('financialCard').onclick = () => document.getElementById('pixArea').classList.toggle('hidden');
        document.getElementById('btnCopyPix').onclick = () => { const key = document.getElementById('pixKey'); key.select(); document.execCommand('copy'); alert("Chave Pix Copiada!"); };
        async function calculatePot() { const snap = await getDocs(collection(db, "users")); let total = 0; snap.forEach(d => { const p = d.data().payments; if(p) total += Object.values(p).filter(v => v).length * 10; }); document.getElementById('potValue').innerText = total.toLocaleString('pt-br',{style: 'currency', currency: 'BRL'}); }
        document.getElementById('btnPot').onclick = () => document.getElementById('potModal').classList.remove('hidden');
        document.getElementById('btnRefresh').onclick = () => { const tab = document.querySelector('nav#bottomNav .text-\\[\\#006400\\]').id.replace('nav-',''); showTab(tab); };
        document.getElementById('btnLogout').onclick = () => signOut(auth);
    </script>
</body>
</html>
